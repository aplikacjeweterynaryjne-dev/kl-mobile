<!DOCTYPE html>
<html lang="pl">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

Â  <title>KARTA LECZENIA ZWIERZÄ„T</title>

Â  Â  <meta name="theme-color" content="#2b74e4">
Â  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0275d8">
Â  <link rel="icon" href="https://www.gstatic.com/images/icons/material/system/2x/pets_black_24dp.png" type="image/png">
Â  <meta name="mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="default">

Â  <style>
Â  /* --- Sekcja Drukuj + e-mail (styling) --- */
Â  .drukuj-sekcja {
Â  Â  margin-top: 20px;
Â  Â  padding: 10px 0 0 0;
Â  Â  border-top: 1px solid #e0e0e0;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: flex-start;
Â  Â  gap: 10px;
Â  }

Â  .drukuj-sekcja #drukujBtn {
Â  Â  background: #e6e6e6;
Â  Â  border: 1px solid #aaa;
Â  Â  padding: 6px 12px;
Â  Â  border-radius: 6px;
Â  Â  cursor: pointer;
Â  Â  font-size: 15px;
Â  }

Â  .drukuj-sekcja #drukujBtn:hover {
Â  Â  background: #dcdcdc;
Â  }

Â  /* ğŸ“§ Pole e-mail */
Â  .email-box {
Â  Â  width: 100%;
Â  Â  font-size: 14px;
Â  }

Â  .email-input-wrapper {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 6px;
Â  Â  margin-top: 6px;
Â  }

Â  .email-input-wrapper input[type="email"] {
Â  Â  width: 33%;
Â  Â  min-width: 180px;
Â  Â  padding: 6px 8px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  Â  box-sizing: border-box;
Â  }

Â  .email-input-wrapper button {
Â  Â  background: #f5f5f5;
Â  Â  border: 1px solid #bbb;
Â  Â  border-radius: 5px;
Â  Â  cursor: pointer;
Â  Â  font-size: 16px;
Â  Â  padding: 5px 8px;
Â  }

Â  /* Ukryj pole e-mail przy drukowaniu */
Â  @media print {
Â  Â  .email-box, .drukuj-sekcja button#saveEmail { display: none !important; }
Â  }

Â  body { font-family: Arial, sans-serif; margin: 20px; transform: scale(0.95); transform-origin: top left; }
Â  h2 { text-align: center; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; }
Â  .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 12px; margin-bottom: 10px; }
Â  .top-section div { padding: 5px; }
Â  .table-container { width: 100%; overflow-x: auto; }
Â  table { border-collapse: collapse; width: 100%; font-size: 11px; }
Â  th, td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
Â  th { background: #e8eefc; text-align: center; }
Â  td[contenteditable="true"] { background: #fefefe; }
Â  .actions { text-align: right; margin-top: 10px; }
Â  @media print { #printBtn, #copyBtn, #clearSignBtn, #fullscreenBtn, #formBtn { display: none; } }
Â  input[type="date"] { font-size: 11px; }
Â  .small-input { width: 40px; display: inline-block; margin-right: 3px; }
Â  .center-text { text-align: center; }

Â  /* podpisy */
Â  .signatures { display: flex; justify-content: space-between; margin-top: 20px; }
Â  .signature-box { display: flex; flex-direction: column; align-items: center; width: 48%; }
Â  .signature-label { font-weight: bold; margin-bottom: 2px; display: block; text-align: center; width: 100%; }
Â  .signature-canvas { border: 1px solid #000; display: block; height: 80px; width: 100%; margin-top: 5px; touch-action: none; }
Â  .signature-img { display: block; height: 80px; width: 100%; object-fit: contain; margin-top: 5px; }
Â  .signature-name { margin-top: 2px; font-weight: normal; text-align: center; }
Â  /* podpisy */
Â  /* ... (inne style podpisÃ³w) ... */
/* podpisy */
Â  /* ... (inne style podpisÃ³w) ... */
Â  .fullscreen-overlay {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; right: 0; bottom: 0; /* Pokryj caÅ‚y ekran */
Â  Â  background: #fff;
Â  Â  display: none; /* Ukryj overlay na starcie */
Â  Â  z-index: 9999;
Â  Â  flex-direction: column;
Â  Â  padding: 10px;
Â  Â  box-sizing: border-box;
Â  }
Â  .fullscreen-canvas {
Â  Â  flex-grow: 1; /* PozwÃ³l pÅ‚Ã³tnu rosnÄ…Ä‡, ale... */
    max-height: 80vh; /* Ogranicz wysokoÅ›Ä‡ */
Â  Â  width: 100%;
Â  Â  border: 1px solid #000;
Â  Â  touch-action: none;
Â  Â  cursor: crosshair;
Â  }
Â  /* Styl dla przyciskÃ³w w overlay */
Â  .fullscreen-overlay button {
Â  Â  margin-top: 8px;
Â  Â  padding: 8px 15px;
Â  }
  /* Dostosowanie dla trybu poziomego */
  @media (orientation: landscape) and (max-height: 500px) {
    .fullscreen-overlay { padding: 5px; }
    .fullscreen-overlay button { margin-top: 5px; padding: 5px 10px; }
  }
Â  #closeSignBtn { margin-top: 8px; }
Â  #clearFullscreenSignBtn { margin-top: 8px; }

Â  /* ---- formularz (dodany, nie wpÅ‚ywa na tabelÄ™) ---- */
Â  #formModal {
Â  Â  position: fixed;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100vw;
Â  Â  height: 100vh;
Â  Â  background: rgba(0,0,0,0.48);
Â  Â  display: none;
Â  Â  z-index: 10000;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  overflow: hidden;
Â  }

Â  .form-card {
Â  Â  width: 140vw;
Â  Â  max-width: 600px;
Â  Â  height: 120vh;
Â  Â  overflow-y: auto;
Â  Â  background: #fff;
Â  Â  border-radius: 12px;
Â  Â  padding: 24px;
Â  Â  box-sizing: border-box;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: flex-start;
Â  Â  font-size: clamp(18px, 5vw, 22px);
Â  }

Â  @media (max-width: 480px) {
Â  Â  .form-card {
Â  Â  Â  width: 98vw;
Â  Â  Â  height: 95vh;
Â  Â  Â  padding: 12px;
Â  Â  }
Â  Â  input, select, textarea, button {
Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  }

Â  .form-step { display:none; }
Â  .form-step.active { display:block; }
Â  .form-row { margin-bottom:8px; }
Â  .form-row label { display:block; font-weight:600; font-size:13px; margin-bottom:4px; }
Â  .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="number"], .form-row textarea, .form-row input[list] {
Â  Â  width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px;
Â  Â  box-sizing:border-box;
Â  }
Â  .form-row textarea { min-height:70px; resize:vertical; }
Â  .form-actions { display:flex; gap:8px; justify-content:space-between; margin-top:12px; flex-wrap:wrap; }
Â  .form-actions .left, .form-actions .right { display:flex; gap:8px; }
Â  .btn { padding:8px 11px; border-radius:8px; border:1px solid #bbb; background:#f7f7f7; cursor:pointer; font-size:14px; }
Â  .btn.primary { background:#2b74e4; color:#fff; border-color:#2260c5; }
Â  .btn.warn { background:#c0392b; color:#fff; border-color:#992d22; }
Â  .btn.ghost { background:transparent; border-color:#ccc; }
Â  .small { padding:6px 8px; font-size:13px; }

Â  #micBtn { padding:6px 8px; border-radius:8px; cursor:pointer; border:1px solid #ccc; background:#eef; }

Â  .highlight-row { animation: highlightAnim 2s ease; }
Â  @keyframes highlightAnim {
Â  Â  0% { background: #ffff99; }
Â  Â  100% { background: transparent; }
Â  }

Â  @media (orientation: portrait) {
Â  Â  .form-card {
Â  Â  Â  width: 98vw;
Â  Â  Â  max-width: 720px;
Â  Â  }
Â  }

Â  @media (orientation: landscape) {
Â  Â  .form-card {
Â  Â  Â  width: 90vw;
Â  Â  Â  max-width: 720px;
Â  Â  Â  max-height: 95vh;
Â  Â  }
Â  }
Â  Â  /* --- Styl dla przycisku edycji wiersza --- */
.btn-edit-row {
Â  background: #f0f0f0;
Â  border: 1px solid #ccc;
Â  border-radius: 4px;
Â  padding: 0px 5px;
Â  margin-left: 4px;
Â  cursor: pointer;
Â  font-size: 12px;
Â  line-height: 1.2;
Â  vertical-align: middle;
}
.btn-edit-row:hover {
Â  background: #e0e0e0;
}

/* ======================================================== */
/* KOMPLETNE STYLE DLA WYDRUKU (aby zmieÅ›ciÄ‡ na A4)        */
/* ======================================================== */
@media print {

  /* --- Ustawienia strony A4 --- */
  @page {
    size: A4;
    margin: 1cm; /* MoÅ¼esz zmniejszyÄ‡, np. do 0.5cm */
  }

  /* --- Zmniejszenie ogÃ³lnych odstÄ™pÃ³w i czcionek --- */
  body {
    font-size: 10pt;
    margin: 0 !important;
    transform: none !important;
    width: 100%;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  h2 { font-size: 13pt; margin-bottom: 5px; }
  p { margin-top: 4px; margin-bottom: 4px; font-size: 9pt; }

  /* --- Sekcja nagÅ‚Ã³wkowa --- */
  .top-section {
    font-size: 9pt;
    margin-bottom: 5px;
    grid-template-columns: 1fr 1fr 1fr;
  }
  .top-section div { padding: 2px; }
  .top-section input[type="date"],
  .top-section input[type="text"] { font-size: 9pt; padding: 1px; }

  /* --- Tabela --- */
  .table-container { margin-bottom: 5px; }
  table { font-size: 8pt; }
  th, td { padding: 1px 2px; word-break: break-word; }
  td input[type="number"],
  td input[list],
  td .small-input { font-size: 8pt; padding: 0; margin: 0; height: auto; max-width: 95%; }
  td[contenteditable="true"] { padding: 1px 2px; }

  /* --- Podpisy --- */
  .signatures { margin-top: 10px; }
  .signature-box { width: 48%; }
  .signature-label { font-size: 9pt; margin-bottom: 0; }
  .signature-canvas, .signature-img { height: 40px; margin-top: 2px; }
  .signature-name { font-size: 9pt; margin-top: 1px; }

  /* --- Ukrywanie WSZYSTKICH niepotrzebnych elementÃ³w --- */
  .actions,           /* Sekcja z przyciskami na dole */
  #fullscreenOverlay, /* Overlay podpisu */
  #formModal,         /* Modal formularza */
  #fullscreenBtn,     /* Przycisk powiÄ™kszenia podpisu */
  #clearSignBtn,      /* Przycisk czyszczenia podpisu */
  #copyBtn,           /* Przycisk kopiowania danych */
  #formBtn,           /* Przycisk otwierania formularza */
  .email-box,         /* Sekcja e-mail */
  .drukuj-sekcja button#saveEmail, /* Przycisk zapisu e-mail */
  #printBtn,          /* Przycisk Drukuj (z <div class="actions">) */
  .btn-edit-row {     /* âœ… StrzaÅ‚ki edycji wiersza */
    display: none !important;
  }

} /* Koniec @media print */

/* âœ… DODANO: POCZÄ„TEK: Ukryj zapisany paragon podczas drukowania */
@media print {
  #savedReceiptSummary {
    display: none !important;
  }
}
/* âœ… DODANO: KONIEC: Ukryj zapisany paragon podczas drukowania */

Â  </style>
</head>

<body>

<div style="text-align: center; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
  <button id="tabKartaBtn" class="btn primary">ğŸ“ Karta Leczenia</button>
  <button id="tabKalkulatorBtn" class="btn">ğŸ§® Kalkulator Wizyty</button>
</div>
<div id="kartaLeczeniaSection">

<h2>KARTA LECZENIA ZWIERZÄ„T GOSPODARSKICH ORAZ ZWIERZÄ„T, Z KTÃ“RYCH POZYSKANE TKANKI LUB PRODUKTY SÄ„ PRZEZNACZONE DO SPOÅ»YCIA PRZEZ LUDZI / EWIDENCJA LECZENIA ZWIERZÄ„T</h2>

<div class="top-section">
Â  <div>
Â  Â  <b>Nazwa i adres zakÅ‚adu leczniczego dla zwierzÄ…t:</b><br>
Â  Â  <span id="nazwaLecznicy"></span><br>
Â  Â  <b>Wykonanie czynnoÅ›ci lekarsko-weterynaryjnych dnia:</b>
Â  Â  <input type="date" id="dataWykonania"><br>
Â  Â  <b>Nr stada:</b> <span id="nrStada"></span>
Â  </div>
Â  <div>
Â  Â  <b>ImiÄ™, nazwisko i adres albo nazwa siedziby i adres posiadacza zwierzÄ™cia:</b><br>
Â  Â  <input list="klientList" id="klientSelect" placeholder="Wpisz lub wybierz klienta"><br>
Â  Â  <span id="adresKlienta"></span>
Â  Â  <datalist id="klientList"></datalist>
Â  </div>
Â  <div>
Â  Â  <b>ZgÅ‚oszenie:</b> Data: <input type="date" id="dataZgloszenia"><br>
Â  Â  <b>Nr dokumentu:</b> <input type="text" id="nrDokumentu" placeholder="________">
Â  </div>
</div>
<div id="formBtnContainer" style="text-align: center; margin-bottom: 10px;">
    </div>

<div class="table-container">
Â  <table id="karta">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th rowspan="2" style="width:30px;">Lp.</th>
Â  Â  Â  <th rowspan="2" class="center-text">
Â  Â  Â  Â  Nazwa siedziby stada i opis leczonego zwierzÄ™cia<br>
Â  Â  Â  Â  (gatunek, pÅ‚eÄ‡ numer identyfikacyjny, sposÃ³b oznakowania, wiek, masa ciaÅ‚a)
Â  Â  Â  </th>
Â  Â  Â  <th rowspan="2" class="center-text">Liczba leczonych zwierzÄ…t</th>
Â  Â  Â  <th rowspan="2" class="center-text">Rozpoznanie albo wstÄ™pne rozpoznanie choroby</th>
Â  Â  Â  <th colspan="3">
Â  Â  Â  Â  Zastosowane u poszczegÃ³lnych zwierzÄ…t produkty lecznicze lub nabyte przez posiadacza zwierzÄ™cia produkty lecznicze weterynaryjne lub pasze lecznicze
Â  Â  Â  </th>
Â  Â  Â  <th rowspan="2">okres karencji / Zabieg leczniczy lub profilaktyczne zalecenia lekarskie oraz uwagi</th>
Â  Â  </tr>
Â  Â  <tr>
Â  Â  Â  <th>Nazwa produktu leczniczego/ produktu leczniczego weterynaryjnego/ paszy leczniczej</th>
Â  Â  Â  <th>Numer serii produktu leczniczego lub produktu leczniczego weterynaryjnego</th>
Â  Â  Â  <th>IloÅ›Ä‡, dawkowanie zastosowanego produktu leczniczego lub iloÅ›Ä‡, dawkowanie i okres stosowanie nabytego produktu leczniczego, weterynaryjnego/paszy leczniczej</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody></tbody>
Â  </table>
</div>

<p><b>OÅ›wiadczam, Å¼e nabyte produkty lecznicze weterynaryjne/pasze lecznicze zostanÄ… zastosowane zgodnie z zaleceniami lekarza weterynarii.</b></p>

<div class="signatures">
Â  <div class="signature-box">
Â  Â  <span class="signature-label">Lekarz weterynarii</span>
Â  Â  <img id="doctor-signature" class="signature-img" alt="Podpis lekarza">
Â  Â  <span class="signature-name">lek. wet. Magdalena Chojnowska</span>
Â  </div>
Â  <div class="signature-box">
Â  Â  <span class="signature-label">Podpis posiadacza zwierzÄ™cia</span>
Â  Â  <canvas id="canvasPosiadacz" class="signature-canvas"></canvas>
Â  Â  <button id="fullscreenBtn">Podpisz dokument</button>
Â  Â  <button id="clearSignBtn">WyczyÅ›Ä‡ podpis</button>
Â  </div>
</div>

<p><b>Wyniki badaÅ„ uzupeÅ‚niajÄ…cych:</b><br>*W przypadku zwierzÄ…t znajdujÄ…cych siÄ™ w rejestrze zwierzÄ…t gospodarskich oznakowanych</p>

<div class="actions">
 <button id="openCalculatorBtn" class="btn small">OtwÃ³rz Kalkulator</button> Â  <button id="copyBtn" class="btn">Przepisz dane z leczenia na miejscu</button>
Â  <button id="formBtn" class="btn">ğŸ“‹ WprowadÅº poprzez formularz</button>
Â  <button id="printBtn" class="btn" onclick="window.print()">Drukuj / Zapisz PDF</button>
Â  <div class="email-box">
Â  <label for="userEmail">ğŸ“§ Podaj swÃ³j adres e-mail:</label>
Â  <div class="email-input-wrapper">
Â  Â  <input type="email" id="userEmail" placeholder="np. jan.kowalski@email.com">
Â  Â  <button type="button" id="saveEmail" title="Zapisz adres e-mail">ğŸ’¾</button>
Â  </div>
</div>

</div>

<div class="fullscreen-overlay" id="fullscreenOverlay">
Â  <canvas id="fullscreenCanvas" class="fullscreen-canvas"></canvas>
Â  <button id="closeSignBtn">Zamknij podpis</button>
Â  <button id="clearFullscreenSignBtn">WyczyÅ›Ä‡ podpis</button>
</div>

<div id="formModal" aria-hidden="true">
Â  <div class="form-card" role="dialog" aria-modal="true">
Â  Â  Â  Â  <div id="step1" class="form-step active">
Â  Â  Â  <h3>Dane posiadacza / nagÅ‚Ã³wek</h3>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formKlient">ImiÄ™, nazwisko lub nazwa siedziby</label>
Â  Â  Â  Â  <input list="klientList" id="formKlient" placeholder="Wpisz lub wybierz klienta">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formAdres">Adres</label>
Â  Â  Â  Â  <input type="text" id="formAdres" placeholder="Adres">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formNrStada">Nr stada</label>
Â  Â  Â  Â  <input type="text" id="formNrStada" placeholder="Nr stada">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formDataZgloszenia">Data zgÅ‚oszenia</label>
Â  Â  Â  Â  <input type="date" id="formDataZgloszenia">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formDataWykonania">Data wykonania</label>
Â  Â  Â  Â  <input type="date" id="formDataWykonania">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formNrDokumentu">Nr dokumentu</label>
Â  Â  Â  Â  <input type="text" id="formNrDokumentu" placeholder="Numer dokumentu">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-actions">
Â  Â  Â  Â  <div class="left">
Â  Â  Â  Â  Â  <button id="closeForm" class="btn ghost small">ZakoÅ„cz</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  <button id="nextToProducts" class="btn primary small">Dalej âœ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="step2" class="form-step">
Â  Â  Â  <h3>Edycja wierszy tabeli</h3>

Â  Â  Â  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
Â  Â  Â  Â  <label style="margin:0; font-weight:600;">Wybierz wiersz</label>
Â  Â  Â  Â  <select id="formRowSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"></select>
Â  Â  Â  Â  <div style="display:flex; gap:6px;">
Â  Â  Â  Â  Â  <button id="prevRow" class="btn small">â—€</button>
Â  Â  Â  Â  Â  <button id="nextRow" class="btn small">â–¶</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formOpis">Nazwa siedziby stada i opis zwierzÄ™cia</label>
Â  Â  Â  Â  <textarea id="formOpis" placeholder="Opis zwierzÄ™cia"></textarea>
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formLiczba">Liczba leczonych zwierzÄ…t</label>
Â  Â  Â  Â  <input type="number" id="formLiczba" min="0" placeholder="0">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formRozpoznanie">Rozpoznanie / wstÄ™pne rozpoznanie</label>
Â  Â  Â  Â  <input type="text" id="formRozpoznanie" placeholder="Rozpoznanie">
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formLek">Nazwa produktu leczniczego (lista)</label>
Â  Â  Â  Â  <input list="listaLekow" id="formLek" placeholder="Wybierz lek">
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
Â  Â  Â  Â  <button id="micBtn" class="" title="Dyktuj nazwÄ™ produktu">ğŸ¤</button>
Â  Â  Â  Â  <small style="color:#666">NaciÅ›nij mikrofon aby dyktowaÄ‡</small>
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formSeria">Numer serii produktu</label>
Â  Â  Â  Â  <input type="text" id="formSeria" placeholder="Numer serii">
Â  Â  Â  </div>
Â  Â  Â  <form id="myForm">

Â  <div class="form-row">
Â  Â  <label>IloÅ›Ä‡ </label>
Â  Â  <input type="number" inputmode="numeric" pattern="[0-9]*" id="formIlosc" placeholder="0" style="width:60px;">
Â  </div>

Â  <div class="form-row">
Â  Â  <label>Dawkowanie / jednostka</label>
Â  Â  <input type="text" id="formDawkowanie" placeholder="np. 2 ml/kg">
Â  </div>
</form>

Â  Â  Â  <div class="mic-container">
Â  <input type="text" id="formKarencja" placeholder="Okres karencji / uwagi">
Â  <button type="button" id="micKarencja" class="mic-btn" title="Dyktuj">ğŸ¤</button>
</div>


Â  Â  Â  <div class="form-actions" style="margin-top:12px;">
Â  Â  Â  Â  <div class="left">
Â  Â  Â  Â  Â  <button id="backToHeader" class="btn ghost small">â¬… Cofnij</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  <button id="saveRow" class="btn primary small">Zapisz wiersz</button>
Â  Â  Â  Â  Â  <button id="formCopyBtn" class="btn small">Przepisz dane z leczenia na miejscu</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>
</div>

<datalist id="listaLekow"></datalist>

</div> <div id="kalkulatorWizytySection" style="display: none;">
  <h2>Kalkulator Wizyty</h2>
  <div id="calculatorUI">
    <div id="receiptDisplay" style="border: 1px solid #ccc; min-height: 100px; margin-bottom: 15px; padding: 5px; background: #f9f9f9;">
      <p style="text-align: center; color: #999;">Paragon jest pusty</p>
    </div>

    <div>
      <input type="checkbox" id="copyFromCardCheckbox">
      <label for="copyFromCardCheckbox">Przepisz produkty z karty leczenia</label>
    </div>

    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: flex-end;">
      <div style="flex-grow: 1;">
        <label for="productSelect">Wybierz produkt:</label><br>
        <input list="listaLekow" id="productSelect" style="width: 100%; padding: 5px;">
        </div>
      <div>
        <label for="productQuantityInput">IloÅ›Ä‡:</label><br>
        <input type="number" id="productQuantityInput" value="1" min="1" style="width: 60px; padding: 5px;">
      </div>
      <button id="addProductBtn" class="btn primary small">Dodaj</button>
    </div>

    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: flex-end;">
       <div>
           <label for="pluCodeInput">Kod PLU:</label><br>
           <input type="text" id="pluCodeInput" style="width: 80px; padding: 5px;">
       </div>
       <button id="pluBtn" class="btn small">PLU</button>
    </div>


    <div style="text-align: right; margin-top: 20px;">
      <button id="saveReceiptBtn" class="btn primary">Zapisz Paragon</button>
    </div>
  </div>

  <div id="savedReceiptSummary" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px;">
     </div>

</div> <script>
/* ----- dane map i nazwy lekÃ³w (bÄ™dÄ… uzupeÅ‚nione z serwera) ----- */
let mapaSerii = {}, mapaIlosci = {}, mapaKarencji = {}, nazwyLekow = [];

// ğŸŒ Tryb GitHub Pages â€“ pobieramy dane z lokalnego pliku data.json
fetch('data.json')
  .then(response => {
    if (!response.ok) throw new Error('BÅ‚Ä…d sieci: ' + response.status);
    return response.json();
  })
  .then(data => {
    console.log('âœ… Dane pobrane z data.json:', data);
    initData(data);
  })
  .catch(error => {
    console.error('âŒ BÅ‚Ä…d pobierania pliku data.json:', error);
    alert('Nie udaÅ‚o siÄ™ pobraÄ‡ danych. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.');
  });

function initData(data) {
  // nagÅ‚Ã³wek
  document.getElementById('nazwaLecznicy').textContent = data.nazwaLecznicy || '';
  // klienci -> datalist
  const klientList = document.getElementById('klientList');
  klientList.innerHTML = '';
  (data.klienci || []).forEach(k => {
    const opt = document.createElement('option');
    opt.value = k.nazwa;
    opt.dataset.adres = k.adres || '';
    opt.dataset.nrstada = k.nrStada || '';
    klientList.appendChild(opt);
  });

  // leki -> mapy i lista
  nazwyLekow = [];
  (data.leki || []).forEach(l => {
    mapaSerii[l.nazwa] = l.nrSerii || '';
    mapaIlosci[l.nazwa] = l.dawkowanie || '';
    mapaKarencji[l.nazwa] = l.karencja || '';
    nazwyLekow.push(l.nazwa);
  });
  rebuildListaLekow();

  // default daty -> today
  const today = new Date().toISOString().split('T')[0];
  if (!document.getElementById('dataZgloszenia').value) document.getElementById('dataZgloszenia').value = today;
  if (!document.getElementById('dataWykonania').value) document.getElementById('dataWykonania').value = today;
  const formDataZgloszenia = document.getElementById('formDataZgloszenia');
  const formDataWykonania = document.getElementById('formDataWykonania');
  if (formDataZgloszenia) formDataZgloszenia.value = today;
  if (formDataWykonania) formDataWykonania.value = today;

  // podpis lekarza
  if (data.doctorSignature) document.getElementById('doctor-signature').src = data.doctorSignature;

  // generuj wiersze tabeli
  generateRows();

  // podÅ‚Ä…cz zachowanie autouzupeÅ‚niania klienta w nagÅ‚Ã³wku i w formularzu
  setupClientAutoFill();

  // --- Przenoszenie przyciskÃ³w ---
  const formBtnContainer = document.getElementById('formBtnContainer');
  const formBtn = document.getElementById('formBtn');
  if (formBtnContainer && formBtn) {
    formBtnContainer.appendChild(formBtn);
  } else {
     if (!formBtn) console.warn("#formBtn not found, skipping move.");
     if (!formBtnContainer) console.warn("#formBtnContainer not found, skipping move.");
  }

  const copyBtn = document.getElementById('copyBtn');
  const buttonPlaceholder = document.getElementById('copyBtnPlaceholder');
  if (copyBtn && buttonPlaceholder) {
      buttonPlaceholder.appendChild(copyBtn);
  } else {
     if (!copyBtn) console.warn("#copyBtn not found, skipping move.");
     if (!buttonPlaceholder) console.warn("#copyBtnPlaceholder not found, skipping move.");
  }
} // <- Koniec funkcji initData

/* ---- generowanie wierszy ---- */
function generateRows(){
  const tbody = document.querySelector('#karta tbody');
  tbody.innerHTML = '';
  for (let i=1;i<=13;i++){
    const row = document.createElement('tr');
    if (i===10) {
      const cell = document.createElement('td');
      cell.colSpan = 8;
      cell.style.textAlign = 'left';
      const mainContainer = document.createElement('div');
      mainContainer.style.display = 'flex';
      mainContainer.style.alignItems = 'center';
      mainContainer.style.justifyContent = 'space-between';
      cell.appendChild(mainContainer);
      const textDiv = document.createElement('div');
      textDiv.textContent = 'Potwierdzenie nabycia produktu leczniczego weterynaryjnego/paszy leczniczej';
      textDiv.style.fontWeight = 'bold';
      mainContainer.appendChild(textDiv);
      const buttonPlaceholder = document.createElement('div');
      buttonPlaceholder.style.marginLeft = '10px';
      buttonPlaceholder.id = 'copyBtnPlaceholder';
      mainContainer.appendChild(buttonPlaceholder);
      row.appendChild(cell);
      tbody.appendChild(row);
      continue;
    }
    for (let j=1;j<=8;j++){
      const cell = document.createElement('td');

      if (j===1) { // Logika dla j=1
        const logicalIndex = (i > 10) ? i - 2 : i - 1;
        const rowNumText = (i > 10 ? i - 10 : i) + '.';
        cell.textContent = rowNumText + ' ';
        const btn = document.createElement('button');
        btn.textContent = 'â¡ï¸';
        btn.className = 'btn-edit-row';
        btn.title = 'Edytuj ten wiersz w formularzu';
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openFormAtRow(logicalIndex);
        });
        cell.appendChild(btn);
      } else { // DomyÅ›lne dla pozostaÅ‚ych + logika specjalna
         if (i !== 10) {
             cell.contentEditable = true;
         }
      }

      if (j>=2 && j<=4) { cell.classList.add('center-text'); } // Centrowanie

      if (j===3 && i!==10){ // Input liczbowy
         const input = document.createElement('input');
         input.type = 'number'; input.min = '0'; input.style.width = '50px';
         cell.textContent = ''; cell.appendChild(input);
      }

      if (j===5 && i!==10){ // Input listy lekÃ³w
        const input = document.createElement('input');
        input.setAttribute('list','listaLekow'); input.style.width = '95%';
        input.addEventListener('input', function(){
          const nrCell = row.cells[5]; const iloscCell = row.cells[6]; const karCell = row.cells[7];
          const nazwa = this.value; const nr = mapaSerii[nazwa] || '';
          const dawka = mapaIlosci[nazwa] || ''; const kar = mapaKarencji[nazwa] || '';
          if(nrCell) nrCell.textContent = nr;
          if(iloscCell) iloscCell.innerHTML = `<input class="small-input" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="iloÅ›Ä‡"> ${dawka||''}`;
          if(karCell) karCell.textContent = kar;
        });
        cell.textContent = ''; cell.appendChild(input);
      }
      row.appendChild(cell);
    } // Koniec pÄ™tli for (j...)
    tbody.appendChild(row);
  } // Koniec pÄ™tli for (i...)
  populateRowSelect();
} // Koniec funkcji generateRows

/* ---- NOWA FUNKCJA: Otwiera formularz na konkretnym wierszu ---- */
function openFormAtRow(logicalIndex) {
  formModal.style.display = 'flex';
  showStep(2);
  populateRowSelect();
  formRowSelect.value = logicalIndex;
  selectRowInForm(logicalIndex);
  formRowSelect.dataset.prevIndex = logicalIndex;
}
/* ---- lista lekow w datalist ---- */
function rebuildListaLekow(){
  const dl = document.getElementById('listaLekow');
  dl.innerHTML = '';
  nazwyLekow.forEach(n=>{ const o = document.createElement('option'); o.value = n; dl.appendChild(o); });
}

/* ---- podÅ‚Ä…czenie autouzupeÅ‚niania klienta ---- */
function setupClientAutoFill(){
  const klientSelect = document.getElementById('klientSelect');
  const klientList = document.getElementById('klientList');
  klientSelect.addEventListener('input', function(){
    const val = this.value; const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('adresKlienta').textContent = opt.dataset.adres || '';
      document.getElementById('nrStada').textContent = opt.dataset.nrstada || '';
    } else {
      document.getElementById('adresKlienta').textContent = '';
      document.getElementById('nrStada').textContent = '';
    }
  });
  const formKlient = document.getElementById('formKlient');
  formKlient.addEventListener('input', function(){
    const val = this.value; const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('formAdres').value = opt.dataset.adres || '';
      document.getElementById('formNrStada').value = opt.dataset.nrstada || '';
    }
  });
}

/* ---- kopiowanie do wiersza 10 ---- */
function copyToRow10FromRow0(){
  const rows = document.querySelectorAll('#karta tbody tr'); if (!rows[0]) return;
  const ed = rowsEditable(); if (ed.length === 0) return; const src = ed[0];
  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
  const specialIndex = tbodyTrs.findIndex(tr => tr.children.length === 1 && tr.children[0].colSpan==8); if (specialIndex === -1) return;
  const logicalRows = rowsEditable(); if (logicalRows.length >= 10) {
    const target = logicalRows[9];
    const sourceTextDiv = src.cells[1].querySelector('.editable-text'); // Poprawka: Bierzemy z diva
    const targetTextDiv = target.cells[1].querySelector('.editable-text'); // Poprawka: Zapisujemy do diva
    if (sourceTextDiv && targetTextDiv) targetTextDiv.textContent = sourceTextDiv.textContent;
    else target.cells[1].textContent = src.cells[1].textContent; // Fallback
    const srcInput = src.cells[2].querySelector('input'); const tgtInput = target.cells[2].querySelector('input');
    if (srcInput && tgtInput) tgtInput.value = srcInput.value;
    target.cells[3].textContent = src.cells[3].textContent;
    target.classList.add('highlight-row'); setTimeout(()=>target.classList.remove('highlight-row'),2000);
    target.scrollIntoView({behavior:'smooth', block:'center'});
  } else { alert('Brak wystarczajÄ…cej liczby wierszy aby przenieÅ›Ä‡ dane do wiersza 10.'); }
}

/* helper: zwraca tablicÄ™ edytowalnych wierszy */
function rowsEditable(){ return [...document.querySelectorAll('#karta tbody tr')].filter(tr=>tr.cells.length === 8); }

/* ---- Formularz: logika ---- */
const formModal = document.getElementById('formModal'); const step1 = document.getElementById('step1'); const step2 = document.getElementById('step2');
const formBtn = document.getElementById('formBtn'); const closeForm = document.getElementById('closeForm');
const nextToProducts = document.getElementById('nextToProducts'); const backToHeader = document.getElementById('backToHeader');
const formRowSelect = document.getElementById('formRowSelect');

if (formBtn) {
    formBtn.addEventListener('click', ()=>{
      formModal.style.display = 'flex'; showStep(1); populateRowSelect(); formRowSelect.dataset.prevIndex = 0;
      document.getElementById('formKlient').value = document.getElementById('klientSelect').value || '';
      document.getElementById('formAdres').value = document.getElementById('adresKlienta').textContent || '';
      document.getElementById('formNrStada').value = document.getElementById('nrStada').textContent || '';
      document.getElementById('formDataZgloszenia').value = document.getElementById('dataZgloszenia').value || '';
      document.getElementById('formDataWykonania').value = document.getElementById('dataWykonania').value || '';
      document.getElementById('formNrDokumentu').value = document.getElementById('nrDokumentu').value || '';
    });
}
closeForm.addEventListener('click', ()=> formModal.style.display = 'none');
function showStep(n){ step1.classList.toggle('active', n===1); step2.classList.toggle('active', n===2); }
nextToProducts.addEventListener('click', ()=>{ syncHeaderFormToTop(); populateRowSelect(); selectRowInForm(0); showStep(2); });
backToHeader.addEventListener('click', ()=>{ showStep(1); });
function syncHeaderFormToTop(){
  const klient = document.getElementById('formKlient').value; const adres = document.getElementById('formAdres').value;
  const nrStada = document.getElementById('formNrStada').value; const dataZ = document.getElementById('formDataZgloszenia').value;
  const dataW = document.getElementById('formDataWykonania').value; const nrDok = document.getElementById('formNrDokumentu').value;
  document.getElementById('klientSelect').value = klient; document.getElementById('adresKlienta').textContent = adres;
  document.getElementById('nrStada').textContent = nrStada; if (dataZ) document.getElementById('dataZgloszenia').value = dataZ;
  if (dataW) document.getElementById('dataWykonania').value = dataW; document.getElementById('nrDokumentu').value = nrDok;
}
function populateRowSelect(){
  const sel = formRowSelect; sel.innerHTML = ''; const logical = rowsEditable();
  logical.forEach((tr, idx) => {
    const display = tr.cells[0].textContent || (idx+1)+'.'; const opt = document.createElement('option');
    opt.value = idx; opt.textContent = (idx+1) + '.'; sel.appendChild(opt);
  });
}
document.getElementById('nextRow').addEventListener('click', ()=>{
  const sel = formRowSelect; const prevIdx = parseInt(sel.dataset.prevIndex,10); if (!isNaN(prevIdx)) saveRow(prevIdx);
  if (sel.selectedIndex < sel.options.length - 1) sel.selectedIndex++; sel.dispatchEvent(new Event('change'));
});
document.getElementById('prevRow').addEventListener('click', ()=>{
  const sel = formRowSelect; const prevIdx = parseInt(sel.dataset.prevIndex,10); if (!isNaN(prevIdx)) saveRow(prevIdx);
  if (sel.selectedIndex > 0) sel.selectedIndex--; sel.dispatchEvent(new Event('change'));
});
formRowSelect.addEventListener('change', ()=>{
  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10); if (!isNaN(prevIdx)) saveRow(prevIdx);
  const idx = parseInt(formRowSelect.value,10); selectRowInForm(idx); formRowSelect.dataset.prevIndex = idx;
});

/* ---- funkcja zapisu wiersza ---- */
function saveRow(idx){
  const logical = rowsEditable(); const row = logical[idx]; if (!row) return;
  const textDiv = row.cells[1].querySelector('.editable-text'); // ZnajdÅº div
  if (textDiv) textDiv.textContent = document.getElementById('formOpis').value; // Zapisz do diva
  else row.cells[1].textContent = document.getElementById('formOpis').value; // Fallback
  const inp2 = row.cells[2].querySelector('input'); if (inp2) inp2.value = document.getElementById('formLiczba').value;
  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
  const produktInput = row.cells[4].querySelector('input');
  if (produktInput) { produktInput.value = document.getElementById('formLek').value; produktInput.dispatchEvent(new Event('input', { bubbles:true })); }
  row.cells[5].textContent = document.getElementById('formSeria').value;
  const cell6 = row.cells[6]; const iloscInput = cell6.querySelector('input[type="number"]');
  if (il
