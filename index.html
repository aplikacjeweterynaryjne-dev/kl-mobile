<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>KARTA LECZENIA ZWIERZƒÑT</title>

  <!-- ‚úÖ DODANE: obs≈Çuga PWA -->
  <meta name="theme-color" content="#2b74e4">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0275d8">
  <link rel="icon" href="https://www.gstatic.com/images/icons/material/system/2x/pets_black_24dp.png" type="image/png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
  /* --- Sekcja Drukuj + e-mail (styling) --- */
  .drukuj-sekcja {
    margin-top: 20px;
    padding: 10px 0 0 0;
    border-top: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .drukuj-sekcja #drukujBtn {
    background: #e6e6e6;
    border: 1px solid #aaa;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
  }

  .drukuj-sekcja #drukujBtn:hover {
    background: #dcdcdc;
  }

  /* üìß Pole e-mail */
  .email-box {
    width: 100%;
    font-size: 14px;
  }

  .email-input-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
  }

  .email-input-wrapper input[type="email"] {
    width: 33%;
    min-width: 180px;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }

  .email-input-wrapper button {
    background: #f5f5f5;
    border: 1px solid #bbb;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    padding: 5px 8px;
  }

  /* Ukryj pole e-mail przy drukowaniu */
  @media print {
    .email-box, .drukuj-sekcja button#saveEmail { display: none !important; }
  }

  body { font-family: Arial, sans-serif; margin: 20px; transform: scale(0.95); transform-origin: top left; }
  h2 { text-align: center; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; }
  .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 12px; margin-bottom: 10px; }
  .top-section div { padding: 5px; }
  .table-container { width: 100%; overflow-x: auto; }
  table { border-collapse: collapse; width: 100%; font-size: 11px; }
  th, td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
  th { background: #e8eefc; text-align: center; }
  td[contenteditable="true"] { background: #fefefe; }
  .actions { text-align: right; margin-top: 10px; }
  @media print { #printBtn, #copyBtn, #clearSignBtn, #fullscreenBtn, #formBtn { display: none; } }
  input[type="date"] { font-size: 11px; }
  .small-input { width: 40px; display: inline-block; margin-right: 3px; }
  .center-text { text-align: center; }

  /* podpisy */
  .signatures { display: flex; justify-content: space-between; margin-top: 20px; }
  .signature-box { display: flex; flex-direction: column; align-items: center; width: 48%; }
  .signature-label { font-weight: bold; margin-bottom: 2px; display: block; text-align: center; width: 100%; }
  .signature-canvas { border: 1px solid #000; display: block; height: 80px; width: 100%; margin-top: 5px; touch-action: none; }
  .signature-img { display: block; height: 80px; width: 100%; object-fit: contain; margin-top: 5px; }
  .signature-name { margin-top: 2px; font-weight: normal; text-align: center; }
  /* podpisy */
  /* ... (inne style podpis√≥w) ... */
/* podpisy */
  /* ... (inne style podpis√≥w) ... */
  .fullscreen-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0; /* Pokryj ca≈Çy ekran */
    background: #fff;
    display: none; /* ‚úÖ POPRAWKA: Ukryj overlay na starcie */
    z-index: 9999;
    /* U≈ºyj flexbox DOPIERO gdy jest widoczny (JS ustawi display: flex) */
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  /* ... (reszta styl√≥w dla .fullscreen-canvas i przycisk√≥w pozostaje bez zmian) ... */
  .fullscreen-canvas {
    flex-grow: 1; /* Pozw√≥l p≈Ç√≥tnu rozciƒÖgnƒÖƒá siƒô pionowo */
    width: 100%; /* Zajmij ca≈ÇƒÖ dostƒôpnƒÖ szeroko≈õƒá */
    border: 1px solid #000;
    touch-action: none;
    cursor: crosshair; /* Zmie≈Ñ kursor na krzy≈ºyk */
  }
  /* Styl dla przycisk√≥w w overlay */
  .fullscreen-overlay button {
    margin-top: 8px; /* Odstƒôp miƒôdzy przyciskami a p≈Ç√≥tnem/sobƒÖ */
    padding: 8px 15px; /* Trochƒô wiƒôksze przyciski */
  }
    /* ‚úÖ DODAJ: Dostosowanie dla trybu poziomego */
  @media (orientation: landscape) and (max-height: 500px) { /* Stosuj tylko na ni≈ºszych ekranach w poziomie */
    .fullscreen-overlay {
      padding: 5px; /* Mniejszy padding */
    }
    .fullscreen-canvas {
      /* Mo≈ºesz eksperymentowaƒá z max-height, np. 80vh (80% wysoko≈õci widoku) */
      /* lub zostawiƒá flex-grow, je≈õli padding wystarczy */
      max-height: 85vh;
    }
    .fullscreen-overlay button {
      margin-top: 5px; /* Mniejszy odstƒôp */
      padding: 5px 10px; /* Mniejsze przyciski */
    }
  }
  #closeSignBtn { /* Domy≈õlny odstƒôp ju≈º jest, zerujemy */
      margin-top: 8px;
  }
   #clearFullscreenSignBtn {
       margin-top: 8px;
   }

  /* ---- formularz (dodany, nie wp≈Çywa na tabelƒô) ---- */
  #formModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.48);
    display: none;
    z-index: 10000;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .form-card {
    width: 140vw;
    max-width: 600px;
    height: 120vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    font-size: clamp(18px, 5vw, 22px);
  }

  @media (max-width: 480px) {
    .form-card {
      width: 98vw;
      height: 95vh;
      padding: 12px;
    }
    input, select, textarea, button {
      font-size: 1rem;
    }
  }

  .form-step { display:none; }
  .form-step.active { display:block; }
 /* Zwiƒôkszenie czcionki nag≈Ç√≥wk√≥w w formularzu */
  .form-step h3 {
    font-size: 25px; /* Domy≈õlna jest zwykle ok. 20-21px */
  }
    /* Zwiƒôkszenie czcionki przycisk√≥w w formularzu */
  #formModal .btn {
    font-size: 19px;
  }
    .form-row { margin-bottom:8px; }
  .form-row label { display:block; font-weight:600; font-size:18px; margin-bottom:4px; }
  .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="number"], .form-row textarea, .form-row input[list] {
¬† ¬† width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px;
¬† ¬† box-sizing:border-box;
¬† }
  .form-row textarea { min-height:70px; resize:vertical; }
  .form-actions { display:flex; gap:8px; justify-content:space-between; margin-top:12px; flex-wrap:wrap; }
  .form-actions .left, .form-actions .right { display:flex; gap:8px; }
  .btn { padding:8px 11px; border-radius:8px; border:1px solid #bbb; background:#f7f7f7; cursor:pointer; font-size:14px; }
  .btn.primary { background:#2b74e4; color:#fff; border-color:#2260c5; }
  .btn.warn { background:#c0392b; color:#fff; border-color:#992d22; }
  .btn.ghost { background:transparent; border-color:#ccc; }
  .small { padding:6px 8px; font-size:13px; }

  #micBtn { padding:6px 8px; border-radius:8px; cursor:pointer; border:1px solid #ccc; background:#eef; }

  .highlight-row { animation: highlightAnim 2s ease; }
  @keyframes highlightAnim {
    0% { background: #ffff99; }
    100% { background: transparent; }
  }

  @media (orientation: portrait) {
    .form-card {
      width: 98vw;
      max-width: 720px;
    }
  }

  @media (orientation: landscape) {
    .form-card {
      width: 90vw;
      max-width: 720px;
      max-height: 95vh;
    }
  }
    /* --- Styl dla przycisku edycji wiersza --- */
.btn-edit-row {
¬† background: #f0f0f0;
¬† border: 1px solid #ccc;
¬† border-radius: 4px;
¬† padding: 0px 5px;
¬† margin-left: 4px;
¬† cursor: pointer;
¬† font-size: 12px;
¬† line-height: 1.2;
¬† vertical-align: middle;
}
.btn-edit-row:hover {
¬† background: #e0e0e0;
}

/* Ukryj przycisk podczas drukowania */

@media print {

  .btn-edit-row { display: none !important; }

}

    /* ======================================================== */

/* STYLE DLA WYDRUKU (aby zmie≈õciƒá na A4)                   */

/* ======================================================== */

@media print {



  /* --- Ustawienia strony A4 --- */

  @page {

    size: A4;

    /* Mo≈ºesz dostosowaƒá marginesy, np. zmniejszyƒá do 0.5cm */

    margin: 1cm; 

  }



  /* --- Zmniejszenie og√≥lnych odstƒôp√≥w i czcionek --- */

  body {

    font-size: 10pt; /* Zmniejsz bazowy rozmiar czcionki dla wydruku */

    margin: 0 !important; /* Usu≈Ñ margines body tylko dla wydruku */

    transform: none !important; /* Wy≈ÇƒÖcz skalowanie dla wydruku */

    width: 100%; /* Upewnij siƒô, ≈ºe body zajmuje ca≈ÇƒÖ szeroko≈õƒá */

    -webkit-print-color-adjust: exact; /* Zachowaj kolory t≈Ça (np. w nag≈Ç√≥wkach tabeli) */

    print-color-adjust: exact;

  }



  h2 {

    font-size: 13pt; /* Mniejszy tytu≈Ç */

    margin-bottom: 5px;

  }



  .top-section {

    font-size: 9pt; /* Mniejsza czcionka w sekcji nag≈Ç√≥wkowej */

    margin-bottom: 5px;

    grid-template-columns: 1fr 1fr 1fr; /* Upewnij siƒô, ≈ºe uk≈Çad jest zachowany */

  }

  .top-section div {

      padding: 2px; /* Mniejszy padding */

  }

   .top-section input[type="date"],

   .top-section input[type="text"] {

      font-size: 9pt; /* Mniejsza czcionka input√≥w */

      padding: 1px;

   }





  /* --- Zmniejszenie tabeli --- */

  .table-container {

    margin-bottom: 5px;

  }

  table {

    font-size: 8pt; /* Znacznie mniejsza czcionka w tabeli */

  }

  th, td {

    padding: 1px 2px; /* Minimalny padding w kom√≥rkach */

    word-break: break-word; /* Pozw√≥l na ≈Çamanie d≈Çugich s≈Ç√≥w */

  }

  /* Zmniejszenie input√≥w wewnƒÖtrz tabeli */

   td input[type="number"],

   td input[list],

   td .small-input {

     font-size: 8pt;

     padding: 0;

     margin: 0;

     height: auto;

     max-width: 95%; /* Zapobiegaj rozpychaniu kom√≥rki */

   }

   /* Usuniƒôcie dodatkowego miejsca przy edytowalnych kom√≥rkach */

   td[contenteditable="true"] {

     padding: 1px 2px;

   }





  /* --- Zmniejszenie sekcji podpis√≥w --- */

  p { /* Zmniejsz marginesy wok√≥≈Ç paragraf√≥w */

    margin-top: 4px;

    margin-bottom: 4px;

    font-size: 9pt;

  }



  .signatures {

    margin-top: 10px; /* Mniejszy odstƒôp nad podpisami */

  }

  .signature-box {

    width: 48%; /* Zachowaj szeroko≈õƒá */

  }

  .signature-label {

     font-size: 9pt;

     margin-bottom: 0;

  }

  .signature-canvas, .signature-img {

    height: 40px; /* Znacznie zmniejsz wysoko≈õƒá obszaru podpisu */

    margin-top: 2px;

  }

   .signature-name {

     font-size: 9pt;

     margin-top: 1px;

   }



  /* --- Ukrywanie niepotrzebnych element√≥w (ju≈º masz czƒô≈õƒá z tego) --- */

  .actions, /* Ukryj ca≈ÇƒÖ sekcjƒô akcji */

  #fullscreenOverlay, /* Ukryj overlay do podpisu */

  #formModal, /* Ukryj formularz modalny */

  #fullscreenBtn, /* Dodatkowe ukrycie na wszelki wypadek */

  #clearSignBtn,

  #copyBtn,

  #formBtn,

  .email-box {

    display: none !important;

  }
  /* Ukryj strza≈Çki edycji wiersza podczas drukowania */
@media print {
  .btn-edit-row {
    display: none !important;
  }
}
  /* ‚úÖ DODANO: POCZƒÑTEK: Ukryj zapisany paragon podczas drukowania */
@media print {
  #savedReceiptSummary {
    display: none !important;
  }
}
/* ‚úÖ DODANO: Powiƒôkszenie przycisku "Dodaj" w kalkulatorze (silniejszy selektor) */
#kalkulatorWizytySection #addProductBtn {
  font-size: 18px !important;
  padding: 15px 20px !important;
  line-height: 1.3 !important;
  /* Resetujemy wymiary, aby padding m√≥g≈Ç dzia≈Çaƒá */
  width: auto !important; 
  height: auto !important;
}
  /* ‚úÖ DODAJ TE STYLE DLA TABELI KLIENT√ìW */
#klientTable .btn {
    font-size: 12px;
    padding: 4px 8px;
    margin-right: 4px;
    border-radius: 6px;
}
#klientTable .btn.warn {
    background: #c0392b; 
    color: #fff; 
    border-color: #992d22;
}
#klientTable .btn.warn:hover {
    background: #a93226;
}
  </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body>
  <div style="text-align: center; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
  <button id="tabKartaBtn" class="btn primary">üìù Karta Leczenia</button>
  <button id="tabKalkulatorBtn" class="btn">üßÆ Kalkulator Wizyty</button>
  <button id="tabBazaKlientowBtn" class="btn">üë• Baza Klient√≥w</button>
</div>
  <div id="kartaLeczeniaSection">
<h2>KARTA LECZENIA ZWIERZƒÑT GOSPODARSKICH ORAZ ZWIERZƒÑT, Z KT√ìRYCH POZYSKANE TKANKI LUB PRODUKTY SƒÑ PRZEZNACZONE DO SPO≈ªYCIA PRZEZ LUDZI / EWIDENCJA LECZENIA ZWIERZƒÑT</h2>

<div class="top-section">
  <div>
    <b>Nazwa i adres zak≈Çadu leczniczego dla zwierzƒÖt:</b><br>
    <span id="nazwaLecznicy"></span><br>
    <b>Wykonanie czynno≈õci lekarsko-weterynaryjnych dnia:</b>
    <input type="date" id="dataWykonania"><br>
    <b>Nr stada:</b> <span id="nrStada"></span>
  </div>
  <div>
    <b>Imiƒô, nazwisko i adres albo nazwa siedziby i adres posiadacza zwierzƒôcia:</b><br>
    <input list="klientList" id="klientSelect" placeholder="Wpisz lub wybierz klienta"><br>
    <span id="adresKlienta"></span>
    <datalist id="klientList"></datalist>
  </div>
  <div>
    <b>Zg≈Çoszenie:</b> Data: <input type="date" id="dataZgloszenia"><br>
    <b>Nr dokumentu:</b> <input type="text" id="nrDokumentu" placeholder="________">
  </div>
</div>

<div class="table-container">
  <table id="karta">
  <thead>
    <tr>
      <th rowspan="2" style="width:30px;">Lp.</th>
      <th rowspan="2" class="center-text">
        Nazwa siedziby stada i opis leczonego zwierzƒôcia<br>
        (gatunek, p≈Çeƒá numer identyfikacyjny, spos√≥b oznakowania, wiek, masa cia≈Ça)
      </th>
      <th rowspan="2" class="center-text">Liczba leczonych zwierzƒÖt</th>
      <th rowspan="2" class="center-text">Rozpoznanie albo wstƒôpne rozpoznanie choroby</th>
      <th colspan="3">
        Zastosowane u poszczeg√≥lnych zwierzƒÖt produkty lecznicze lub nabyte przez posiadacza zwierzƒôcia produkty lecznicze weterynaryjne lub pasze lecznicze
      </th>
      <th rowspan="2">okres karencji / Zabieg leczniczy lub profilaktyczne zalecenia lekarskie oraz uwagi</th>
    </tr>
    <tr>
      <th>Nazwa produktu leczniczego/ produktu leczniczego weterynaryjnego/ paszy leczniczej</th>
      <th>Numer serii produktu leczniczego lub produktu leczniczego weterynaryjnego</th>
      <th>Ilo≈õƒá, dawkowanie zastosowanego produktu leczniczego lub ilo≈õƒá, dawkowanie i okres stosowanie nabytego produktu leczniczego, weterynaryjnego/paszy leczniczej</th>
    </tr>
  </thead>
  <tbody></tbody>
  </table>
</div>

<p><b>O≈õwiadczam, ≈ºe nabyte produkty lecznicze weterynaryjne/pasze lecznicze zostanƒÖ zastosowane zgodnie z zaleceniami lekarza weterynarii.</b></p>

<div class="signatures">
  <div class="signature-box">
    <span class="signature-label">Lekarz weterynarii</span>
    <img id="doctor-signature" class="signature-img" alt="Podpis lekarza">
    <span class="signature-name">lek. wet. Magdalena Chojnowska</span>
  </div>
  <div class="signature-box">
    <span class="signature-label">Podpis posiadacza zwierzƒôcia</span>
    <canvas id="canvasPosiadacz" class="signature-canvas"></canvas>
    <button id="fullscreenBtn">Podpisz dokument</button>
    <button id="clearSignBtn">Wyczy≈õƒá podpis</button>
  </div>
</div>

<p><b>Wyniki bada≈Ñ uzupe≈ÇniajƒÖcych:</b><br>*W przypadku zwierzƒÖt znajdujƒÖcych siƒô w rejestrze zwierzƒÖt gospodarskich oznakowanych</p>

<div class="actions">
  <button id="openCalculatorBtn" class="btn small">Otw√≥rz Kalkulator</button>
  <button id="copyBtn" class="btn">Przepisz dane z leczenia na miejscu</button>
  <button id="formBtn" class="btn">üìã Wprowad≈∫ poprzez formularz</button>
  <button id="printBtn" class="btn" onclick="window.print()">Drukuj / Zapisz PDF</button>
  <div class="email-box">
  <label for="userEmail">üìß Podaj sw√≥j adres e-mail:</label>
  <div class="email-input-wrapper">
    <input type="email" id="userEmail" placeholder="np. jan.kowalski@email.com">
    <button type="button" id="saveEmail" title="Zapisz adres e-mail">üíæ</button>
  </div>
</div>

</div>

<!-- fullscreen overlay for signature -->
<div class="fullscreen-overlay" id="fullscreenOverlay">
  <canvas id="fullscreenCanvas" class="fullscreen-canvas"></canvas>
  <button id="closeSignBtn">Zamknij podpis</button>
  <button id="clearFullscreenSignBtn">Wyczy≈õƒá podpis</button>
</div>

<!-- FORMULARZ (modal od do≈Çu na mobilnych) -->
<div id="formModal" aria-hidden="true">
  <div class="form-card" role="dialog" aria-modal="true">
    <!-- krok 1: nag≈Ç√≥wek -->
    <div id="step1" class="form-step active">
      <h3>Dane posiadacza / nag≈Ç√≥wek</h3>
      <div class="form-row">
        <label for="formKlient">Imiƒô, nazwisko lub nazwa siedziby</label>
        <input list="klientList" id="formKlient" placeholder="Wpisz lub wybierz klienta">
      </div>
      <div class="form-row">
        <label for="formAdres">Adres</label>
        <input type="text" id="formAdres" placeholder="Adres">
      </div>
      <div class="form-row">
        <label for="formNrStada">Nr stada</label>
        <input type="text" id="formNrStada" placeholder="Nr stada">
      </div>
      <div class="form-row">
        <label for="formDataZgloszenia">Data zg≈Çoszenia</label>
        <input type="date" id="formDataZgloszenia">
      </div>
      <div class="form-row">
        <label for="formDataWykonania">Data wykonania</label>
        <input type="date" id="formDataWykonania">
      </div>
      <div class="form-row">
        <label for="formNrDokumentu">Nr dokumentu</label>
        <input type="text" id="formNrDokumentu" placeholder="Numer dokumentu">
      </div>
      <div class="form-actions">
        <div class="left">
          <button id="closeForm" class="btn ghost small">Zako≈Ñcz</button>
        </div>
        <div class="right">
          <button id="nextToProducts" class="btn primary small">Dalej ‚ûú</button>
        </div>
      </div>
    </div>

    <!-- krok 2: edycja wierszy -->
    <div id="step2" class="form-step">
      <h3>Edycja wierszy tabeli</h3>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <label style="margin:0; font-weight:600;">Wybierz wiersz</label>
        <select id="formRowSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"></select>
        <div style="display:flex; gap:6px;">
          <button id="prevRow" class="btn small">‚óÄ</button>
          <button id="nextRow" class="btn small">‚ñ∂</button>
        </div>
      </div>

      <div class="form-row">
        <label for="formOpis">Nazwa siedziby stada i opis zwierzƒôcia</label>
        <textarea id="formOpis" placeholder="Opis zwierzƒôcia"></textarea>
      </div>
      <div class="form-row">
        <label for="formLiczba">Liczba leczonych zwierzƒÖt</label>
        <input type="number" id="formLiczba" min="0" placeholder="0">
      </div>
      <div class="form-row">
        <label for="formRozpoznanie">Rozpoznanie / wstƒôpne rozpoznanie</label>
        <input type="text" id="formRozpoznanie" placeholder="Rozpoznanie">
      </div>

      <div class="form-row">
        <label for="formLek">Nazwa produktu leczniczego (lista)</label>
        <input list="listaLekow" id="formLek" placeholder="Wybierz lek">
      </div>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <button id="micBtn" class="" title="Dyktuj nazwƒô produktu">üé§</button>
        <small style="color:#666">Naci≈õnij mikrofon aby dyktowaƒá</small>
      </div>

      <div class="form-row">
        <label for="formSeria">Numer serii produktu</label>
        <input type="text" id="formSeria" placeholder="Numer serii">
      </div>
      <form id="myForm">

  <div class="form-row">
    <label>Ilo≈õƒá </label>
    <input type="number" inputmode="numeric" pattern="[0-9]*" id="formIlosc" placeholder="0" style="width:60px;">
  </div>

  <div class="form-row">
    <label>Dawkowanie / jednostka</label>
    <input type="text" id="formDawkowanie" placeholder="np. 2 ml/kg">
  </div>
</form>

      <div class="mic-container">
  <input type="text" id="formKarencja" placeholder="Okres karencji / uwagi">
  <button type="button" id="micKarencja" class="mic-btn" title="Dyktuj">üé§</button>
</div>


      <div class="form-actions" style="margin-top:12px;">
        <div class="left">
          <button id="backToHeader" class="btn ghost small">‚¨Ö Cofnij</button>
        </div>
        <div class="right">
          <button id="saveRow" class="btn primary small">Zapisz wiersz</button>
          <button id="formCopyBtn" class="btn small">Przepisz dane z leczenia na miejscu</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- datalist dla lek√≥w (tworzone dynamicznie) -->
<datalist id="listaLekow"></datalist>
    </div> <div id="kalkulatorWizytySection" style="display: none;">
  <h2>Kalkulator Wizyty</h2>
  <div id="calculatorUI">
    <div id="receiptDisplay" style="border: 1px solid #ccc; min-height: 100px; margin-bottom: 15px; padding: 5px; background: #f9f9f9;">
      <p style="text-align: center; color: #999;">Paragon jest pusty</p>
    </div>

    <div>
      <input type="checkbox" id="copyFromCardCheckbox">
      <label for="copyFromCardCheckbox">Przepisz produkty z karty leczenia</label>
    </div>

 <div style="margin-top: 15px; display: flex; gap: 10px; align-items: flex-end;">
      
      <div style="flex-grow: 1;">
        <label for="productSelect">Wybierz produkt:</label><br>
        <input list="listaLekow" id="productSelect" style="width: 100%; padding: 5px; box-sizing: border-box;">
      </div>
      
      <div>
        <label for="productQuantityInput">Ilo≈õƒá:</label><br>
        <input type="number" id="productQuantityInput" value="1" min="1" style="width: 60px; padding: 5px;">
      </div>
      
      <div style="padding-bottom: 5px;"> <span id="productUnitDisplay" style="font-size: 0.9em; color: #555;"></span>
      </div>

      <div>
         <button id="addProductBtn" class="btn primary">Dodaj</button>
      </div>

    </div>
    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: flex-end;">
       <div>
           <label for="pluCodeInput">Kod PLU:</label><br>
           <input type="text" id="pluCodeInput" style="width: 80px; padding: 5px;">
       </div>
       <button id="pluBtn" class="btn small">PLU</button>
    </div>


    <div style="text-align: right; margin-top: 20px;">
      <button id="saveReceiptBtn" class="btn primary">Zapisz Paragon</button>
    </div>
  </div>

  <div id="savedReceiptSummary" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px;">
     </div>

</div> ```
<div id="bazaKlientowSection" style="display: none;">
  
  <h2>Baza Klient√≥w</h2>
  <div class="form-row" style="margin-bottom: 15px;">
    <label for="clientSearchInput" style="font-size: 18px;">Wyszukaj klienta:</label>
    <input type="search" id="clientSearchInput" placeholder="Wpisz nazwƒô, adres lub nr stada..." style="width:100%; padding:8px; font-size:16px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; margin-top: 4px;">
  </div>
  <button id="addNewClientBtn" class="btn primary" style="margin-bottom: 15px;">
    Ôºã Dodaj nowego klienta
  </button>
  <button id="importFromSheetBtn" class="btn" style="margin-bottom: 15px; background-color: #f0f0f0;">
    üìã Wklej / Importuj z Arkusza
  </button>
<h4 id="clientCountDisplay" style="margin: 0 0 10px 0; text-align: right; font-weight: normal; color: #333;">
  ≈ÅƒÖczna liczba klient√≥w: ...
</h4>
 <div class="table-container">
    <table id="klientTable"> <thead>
        <tr>
          <th>Nazwa</th>
          <th>Adres</th>
          <th>Nr Stada</th>
          <th>Nr telefonu</th>
          <th>E-mail</th>
          <th>ID Lecznicy</th>
          <th style="width: 130px;">Akcje</th>
        </tr>
      </thead>
      <tbody id="klientTableBody">
        <tr><td colspan="7" style="text-align: center; padding: 10px;">≈Åadowanie...</td></tr>
      </tbody> </table> </div>
  </div>
  <div id="clientFormModal" aria-hidden="true" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.48); display: none; z-index: 10000; justify-content: center; align-items: center; overflow: hidden;">
  <div class="form-card" role="dialog" aria-modal="true">
    
    <h3 id="clientFormTitle" style="font-size: 25px;">Dane Klienta</h3>
    
    <input type="hidden" id="clientFormDocId">
    
    <div class="form-row">
      <label for="clientFormNazwa">Imiƒô, nazwisko lub nazwa siedziby</label>
      <input type="text" id="clientFormNazwa" placeholder="Wpisz nazwƒô klienta" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
    </div>
    
    <div class="form-row">
      <label for="clientFormAdres">Adres</label>
      <input type="text" id="clientFormAdres" placeholder="Wpisz adres" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
    </div>
    
    <div class="form-row">
      <label for="clientFormNrStada">Nr stada</label>
      <input type="text" id="clientFormNrStada" placeholder="Wpisz numer stada" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
    </div>
    <div class="form-row">
    <label for="clientFormNrTelefonu">Nr telefonu</label>
    <input type="tel" id="clientFormNrTelefonu" placeholder="Wpisz numer telefonu" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
  </div>
    <div class="form-row">
      <label for="clientFormEmail">Adres e-mail</label>
      <input type="email" id="clientFormEmail" placeholder="Wpisz adres e-mail" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
    </div>
    <div class="form-row">
      <label for="clientFormIdLecznicy">ID Lecznicy</label>
      <input type="text" id="clientFormIdLecznicy" placeholder="Wpisz ID Lecznicy" style="width:100%; padding:8px; font-size:19px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
    </div>
    <div class="form-actions">
      <div class="left">
        <button id="cancelClientForm" class="btn ghost small" style="font-size: 19px;">Anuluj</button>
      </div>
      <div class="right">
        <button id="saveClientBtn" class="btn primary small" style="font-size: 19px;">Zapisz</button>
      </div>
    </div>
    
  </div>
</div>
   </div> <div id="pasteDataModal" aria-hidden="true" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.48); display: none; z-index: 10001; justify-content: center; align-items: center; overflow: hidden;">
  <div class="form-card" role="dialog" aria-modal="true" style="max-width: 90vw; width: 800px;">
    
    <h3 style="font-size: 25px;">Wklej dane z Arkusza</h3>
    
    <p style="font-size: 14px; margin-top: 0; padding: 5px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px;">
      <strong>Wa≈ºne!</strong> Wklejone dane muszƒÖ mieƒá **6 kolumn** w DOK≈ÅADNIEJ kolejno≈õci:<br>
      1. Nazwa, 2. Adres, 3. Nr Stada, 4. Nr telefonu, 5. E-mail, 6. ID Lecznicy
    </p>
    <p style="font-size: 13px; margin-top: 0;">
      Skrypt znajdzie klienta po **Nazwie** (kolumna 1) i zaktualizuje pozosta≈Çe pola. Je≈õli klient o danej nazwie nie istnieje, zostanie zignorowany.
    </p>

    <div class="form-row">
      <label for="pasteTextarea">Wklej dane (skopiowane z Excela lub Google Sheets):</label>
      <textarea id="pasteTextarea" style="width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; min-height: 200px; resize:vertical;"></textarea>
    </div>
    
    <div class="form-actions">
      <div class="left">
        <button id="cancelPasteData" class="btn ghost small" style="font-size: 19px;">Anuluj</button>
      </div>
      <div class="right">
        <button id="savePasteDataBtn" class="btn primary small" style="font-size: 19px;">Importuj i Zaktualizuj</button>
      </div>
    </div>
    
  </div>
</div>
/* ----- Inicjalizacja Firebase (Uruchamia siƒô na starcie) ----- */
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyBFSlW9_i877sdlTfGHV4XKGeYlbKPAoM0",
  authDomain: "kl-mobile-3536f.firebaseapp.com",
  projectId: "kl-mobile-3536f",
  storageBucket: "kl-mobile-3536f.firebasestorage.app",
  messagingSenderId: "420035668375",
  appId: "1:420035668375:web:712c93f1765729b39bbcd2"
};

// Inicjalizuj Firebase tylko raz
if (!firebase.apps.length) {
   firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
console.log("Firebase gotowy do dzia≈Çania.");

/* ----- G≈Å√ìWNE ZMIENNE APLIKACJI ----- */
let mapaSerii = {}, mapaIlosci = {}, mapaKarencji = {}, nazwyLekow = [];
let mapaCen = {};
let receiptTotal = 0;

// üåê Pobieramy dane dynamicznie z Firestore
async function fetchDataFromFirebase() {
  try {
    console.log("Pobieranie danych z Firestore...");

    // 1. Pobierz dane lecznicy (je≈õli masz je w bazie, na razie pomijamy)
    const nazwaLecznicy = "Gabinet Weterynaryjny ‚ÄúTAURUS‚Äù Magdalena Chojnowska, 19-100 Mo≈Ñki ul. Bia≈Çostocka 59"; // Mo≈ºesz to przenie≈õƒá do bazy
    const doctorSignature = "https://lh3.googleusercontent.com/d/1heCfm8DWWl6chTAtIKxcOsFZAUZF91Et=s800"; // Mo≈ºesz to przenie≈õƒá do bazy

    // 2. Pobierz klient√≥w
    const klienciSnapshot = await db.collection("klienci").get();
    const klienci = klienciSnapshot.docs.map(doc => doc.data());
    console.log(`Pobrano ${klienci.length} klient√≥w.`);

    // 3. Pobierz leki
    const lekiSnapshot = await db.collection("leki").get();
    const leki = lekiSnapshot.docs.map(doc => doc.data());
    console.log(`Pobrano ${leki.length} lek√≥w.`);

    // 4. Z≈Ç√≥≈º obiekt danych i przeka≈º do initData
    const data = { nazwaLecznicy, klienci, leki, doctorSignature };
    console.log('‚úÖ Dane pobrane z Firestore:', data);
    initData(data); // Wywo≈Çaj starƒÖ funkcjƒô z nowymi danymi

  } catch (error) {
    console.error('‚ùå B≈ÇƒÖd pobierania danych z Firestore:', error);
    alert('Nie uda≈Ço siƒô pobraƒá danych z bazy. Sprawd≈∫ po≈ÇƒÖczenie internetowe.');
  }
}

// Uruchom pobieranie danych
fetchDataFromFirebase();
function initData(data) {
  // nag≈Ç√≥wek
  document.getElementById('nazwaLecznicy').textContent = data.nazwaLecznicy || '';
  // klienci -> datalist
  const klientList = document.getElementById('klientList');
  klientList.innerHTML = '';
  (data.klienci||[]).forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k.nazwa;
    opt.dataset.adres = k.adres || '';
    opt.dataset.nrstada = k.nrStada || '';
    klientList.appendChild(opt);
    // also add to the top klientSelect if present (same datalist used)
  });

  // leki -> mapy i lista
  nazwyLekow = [];
  mapaCen = {}; // Wyczy≈õƒá mapƒô cen przed wype≈Çnieniem
  (data.leki || []).forEach(l => {
    mapaSerii[l.nazwa] = l.nrSerii || '';
    mapaIlosci[l.nazwa] = l.dawkowanie || '';
    mapaKarencji[l.nazwa] = l.karencja || '';
    mapaCen[l.nazwa] = l.cena || 0; // ‚úÖ DODANO: Wype≈Çnij mapƒô cen
    nazwyLekow.push(l.nazwa);
  });
  rebuildListaLekow();

  // default daty -> today
  const today = new Date().toISOString().split('T')[0];
  if (!document.getElementById('dataZgloszenia').value) document.getElementById('dataZgloszenia').value = today;
  if (!document.getElementById('dataWykonania').value) document.getElementById('dataWykonania').value = today;
  document.getElementById('formDataZgloszenia').value = today;
  document.getElementById('formDataWykonania').value = today;

  // podpis lekarza
  if (data.doctorSignature) document.getElementById('doctor-signature').src = data.doctorSignature;

  // generuj wiersze tabeli
  generateRows();

  // pod≈ÇƒÖcz zachowanie autouzupe≈Çniania klienta w nag≈Ç√≥wku i w formularzu
  setupClientAutoFill();
  // --- Przenoszenie przycisk√≥w ---

  // Przenie≈õ przycisk #formBtn nad tabelƒô (je≈õli masz ten kod, jest OK)
  const formBtnContainer = document.getElementById('formBtnContainer');
  const formBtn = document.getElementById('formBtn');
  if (formBtnContainer && formBtn) {
    formBtnContainer.appendChild(formBtn);
  } else {
     if (!formBtn) console.warn("#formBtn not found, skipping move.");
     if (!formBtnContainer) console.warn("#formBtnContainer not found, skipping move.");
  }

  // Przenie≈õ przycisk #copyBtn do specjalnego wiersza tabeli
  const copyBtn = document.getElementById('copyBtn');
  const buttonPlaceholder = document.getElementById('copyBtnPlaceholder'); // Znajd≈∫ placeholder

  if (copyBtn && buttonPlaceholder) {
      buttonPlaceholder.appendChild(copyBtn); // Przenie≈õ przycisk do placeholdera
  } else {
     if (!copyBtn) console.warn("#copyBtn not found, skipping move.");
     if (!buttonPlaceholder) console.warn("#copyBtnPlaceholder not found, skipping move.");
  }
  // ‚úÖ KONIEC WKLEJANEGO KODU
}

/* ---- generowanie wierszy (dok≈Çadnie tak jak wcze≈õniej) ---- */
function generateRows(){
  const tbody = document.querySelector('#karta tbody');
  tbody.innerHTML = '';
  for (let i=1;i<=13;i++){
    const row = document.createElement('tr');
  if (i===10) {
      const cell = document.createElement('td');
      cell.colSpan = 8;
      cell.style.textAlign = 'left'; // Wyr√≥wnanie dla ca≈Çej kom√≥rki

      // G≈Ç√≥wny kontener w kom√≥rce, u≈ºywajƒÖcy flexbox
      const mainContainer = document.createElement('div');
      mainContainer.style.display = 'flex'; // Ustawienie element√≥w obok siebie
      mainContainer.style.alignItems = 'center'; // Wyr√≥wnanie pionowe do ≈õrodka
      mainContainer.style.justifyContent = 'space-between'; // Opcjonalnie: rozsu≈Ñ tekst i przycisk
      cell.appendChild(mainContainer);

      // Kontener na tekst (aby zachowaƒá pogrubienie)
      const textDiv = document.createElement('div');
      textDiv.textContent = 'Potwierdzenie nabycia produktu leczniczego weterynaryjnego/paszy leczniczej';
      textDiv.style.fontWeight = 'bold';
      mainContainer.appendChild(textDiv); // Dodaj tekst do g≈Ç√≥wnego kontenera

      // Kontener (placeholder) na przycisk
      const buttonPlaceholder = document.createElement('div');
      buttonPlaceholder.style.marginLeft = '10px'; // Dodaj ma≈Çy odstƒôp miƒôdzy tekstem a przyciskiem
      buttonPlaceholder.id = 'copyBtnPlaceholder'; // ‚úÖ Dodajemy ID, aby ≈Çatwiej go znale≈∫ƒá
      mainContainer.appendChild(buttonPlaceholder); // Dodaj placeholder do g≈Ç√≥wnego kontenera

      row.appendChild(cell);
      tbody.appendChild(row);
      continue; // Kontynuuj pƒôtlƒô
    }
    for (let j=1;j<=8;j++){
      const cell = document.createElement('td');
  if (j===1) {
        // Obliczamy "logiczny" indeks wiersza (0-11),
        // kt√≥ry jest u≈ºywany przez funkcje formularza
        const logicalIndex = (i > 10) ? i - 2 : i - 1;

        // Bierzemy tekst, kt√≥ry mia≈Çe≈õ tam wcze≈õniej (np. "1.", "2." itd.)
        const rowNumText = (i > 10 ? i - 10 : i) + '.';

        // Wyczy≈õƒá kom√≥rkƒô i dodaj numer
        cell.textContent = rowNumText + ' '; 

        // Stw√≥rz i dodaj przycisk "edytuj"
        const btn = document.createElement('button');
        btn.textContent = '‚û°Ô∏è'; // Mo≈ºesz zmieniƒá na '‚úèÔ∏è' lub inny symbol
        btn.className = 'btn-edit-row';
        btn.title = 'Edytuj ten wiersz w formularzu';

        btn.addEventListener('click', (e) => {
          // Zatrzymujemy propagacjƒô, aby klikniƒôcie przycisku
          // nie aktywowa≈Ço edycji kom√≥rki (contenteditable)
          e.stopPropagation(); 

          // Wywo≈Çujemy naszƒÖ nowƒÖ funkcjƒô z indeksem tego wiersza
          openFormAtRow(logicalIndex);
        });

        cell.appendChild(btn);
      }
      if (i!==10) cell.contentEditable = true;
      if (j>=2 && j<=4) cell.classList.add('center-text');
      // kolumna 3 -> number input
      if (j===3 && i!==10){
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.style.width = '50px';
        cell.textContent = '';
        cell.appendChild(input);
      }
      // kolumna 5 -> input z listƒÖ lek√≥w
      if (j===5 && i!==10){
        const input = document.createElement('input');
        input.setAttribute('list','listaLekow');
        input.style.width = '95%';
        input.addEventListener('input', function(){
          const nrCell = row.cells[5];
          const iloscCell = row.cells[6];
          const karCell = row.cells[7];
          const nazwa = this.value;
          const nr = mapaSerii[nazwa] || '';
          const dawka = mapaIlosci[nazwa] || '';
          const kar = mapaKarencji[nazwa] || '';
          nrCell.textContent = nr;
          iloscCell.innerHTML = `<input class="small-input" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="ilo≈õƒá"> ${dawka||''}`;
          karCell.textContent = kar;
        });
        cell.textContent = '';
        cell.appendChild(input);
      }
      row.appendChild(cell);
    }
    tbody.appendChild(row);
  }
  // napelnij select w formularzu odpowiadajƒÖcym wierszom
  populateRowSelect();
}
/* ‚úÖ DODAJ Tƒò NOWƒÑ FUNKCJƒò: ‚úÖ */

/* ---- NOWA FUNKCJA: Otwiera formularz na konkretnym wierszu ---- */
function openFormAtRow(logicalIndex) {
  // 1. Otw√≥rz modal
  formModal.style.display = 'flex';
  
  // 2. Przejd≈∫ od razu do kroku 2 (edycja wiersza)
  showStep(2);
  
  // 3. Wype≈Çnij listƒô rozwijanƒÖ wierszy (na wypadek gdyby nie by≈Ça)
  populateRowSelect();
  
  // 4. Ustaw listƒô rozwijanƒÖ na klikniƒôty wiersz
  formRowSelect.value = logicalIndex;
  
  // 5. Wczytaj dane z tego wiersza do formularza
  selectRowInForm(logicalIndex);
  
  // 6. Ustaw 'poprzedni' indeks, aby auto-zapis dzia≈Ça≈Ç poprawnie
  formRowSelect.dataset.prevIndex = logicalIndex;
}
/* ---- lista lekow w datalist ---- */
function rebuildListaLekow(){
  const dl = document.getElementById('listaLekow');
  dl.innerHTML = '';
  nazwyLekow.forEach(n=>{
    const o = document.createElement('option');
    o.value = n;
    dl.appendChild(o);
  });
}

/* ---- pod≈ÇƒÖczenie autouzupe≈Çniania klienta (nag≈Ç√≥wek i pole formularza) ---- */
function setupClientAutoFill(){
  const klientSelect = document.getElementById('klientSelect');
  const klientList = document.getElementById('klientList');
  klientSelect.addEventListener('input', function(){
    const val = this.value;
    const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('adresKlienta').textContent = opt.dataset.adres || '';
      document.getElementById('nrStada').textContent = opt.dataset.nrstada || '';
    } else {
      document.getElementById('adresKlienta').textContent = '';
      document.getElementById('nrStada').textContent = '';
    }
  });

  // formularz - automatyczne uzupe≈Çnianie adresu i nr stada po wyborze klienta
  const formKlient = document.getElementById('formKlient');
  formKlient.addEventListener('input', function(){
    const val = this.value;
    const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('formAdres').value = opt.dataset.adres || '';
      document.getElementById('formNrStada').value = opt.dataset.nrstada || '';
    } else {
      // nieznany klient -> nie czy≈õcimy adresu aby u≈ºytkownik m√≥g≈Ç pisaƒá
    }
  });
}

/* ---- kopiowanie do wiersza 10 i przewiniƒôcie + pod≈õwietlenie ---- */
function copyToRow10FromRow0(){
  const rows = document.querySelectorAll('#karta tbody tr');
  if (!rows[0]) return;
  // only copy if rows[0] is a normal row (we built so first is row 1)
  // find source cells: first non-10 row (rows array includes the special row as one element)
  // Safer way: build arr of editable rows (like rowsEditable())
  const ed = rowsEditable();
  if (ed.length === 0) return;
  const src = ed[0]; // first editable row
  // find the DOM row index of physical row10 in tbody (it is the 10th created tr)
  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
  // find index of the row which has colSpan === 8 (our special row)
  const specialIndex = tbodyTrs.findIndex(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
  if (specialIndex === -1) return;
  const row10 = tbodyTrs[specialIndex];
  // copy cells 1..3 from src into the "special" row cells (special row has single TD colspan 8)
  // Original behaviour: rows[10].cells[1] etc. In our DOM the "special" row is single cell colspan 8,
  // but original code earlier assumed rows[10].cells[1] exists. To match original behaviour we will insert
  // a new row AFTER the special row and fill it (but user wanted structure unchanged). So keep original approach:
  // In earlier code, rows[10] referenced the 11th element of NodeList of rows (including special as its own row),
  // and they set rows[10].cells[1] etc. That worked because special row still had 8 cells in earlier code.
  // To be compatible, we will locate the editable rows array and find the 10th logical row (index 9) and copy into it.
  const logicalRows = rowsEditable(); // array of trs for logical rows (skips special)
  if (logicalRows.length >= 10) {
    const target = logicalRows[9]; // 0-based -> 9 = 10th editable row (this corresponds to original design)
    // copy columns: cells[1], cells[2], cells[3]
    target.cells[1].textContent = src.cells[1].textContent;
    // cell[2] may contain input
    const srcInput = src.cells[2].querySelector('input');
    const tgtInput = target.cells[2].querySelector('input');
    if (srcInput && tgtInput) tgtInput.value = srcInput.value;
    target.cells[3].textContent = src.cells[3].textContent;
    // highlight and scroll
    target.classList.add('highlight-row');
    setTimeout(()=>target.classList.remove('highlight-row'),2000);
    // scroll into view
    target.scrollIntoView({behavior:'smooth', block:'center'});
  } else {
    alert('Brak wystarczajƒÖcej liczby wierszy aby przenie≈õƒá dane do wiersza 10.');
  }
}

/* helper: zwraca tabelƒô logicznych (edytowalnych) wierszy jako tablica */
function rowsEditable(){
  return [...document.querySelectorAll('#karta tbody tr')].filter(tr=>tr.cells.length === 8);
}

/* ---- Formularz: otwieranie, krokowanie, synchronizacja nag≈Ç√≥wka ---- */
const formModal = document.getElementById('formModal');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const formBtn = document.getElementById('formBtn');
const closeForm = document.getElementById('closeForm');
const nextToProducts = document.getElementById('nextToProducts');
const backToHeader = document.getElementById('backToHeader');
const formRowSelect = document.getElementById('formRowSelect');

formBtn.addEventListener('click', ()=>{
  formModal.style.display = 'flex';
  showStep(1);
  populateRowSelect();
  formRowSelect.dataset.prevIndex = 0; 
  // set form fields from current header values (so form reflects table)
  document.getElementById('formKlient').value = document.getElementById('klientSelect').value || '';
  document.getElementById('formAdres').value = document.getElementById('adresKlienta').textContent || '';
  document.getElementById('formNrStada').value = document.getElementById('nrStada').textContent || '';
  document.getElementById('formDataZgloszenia').value = document.getElementById('dataZgloszenia').value || '';
  document.getElementById('formDataWykonania').value = document.getElementById('dataWykonania').value || '';
  document.getElementById('formNrDokumentu').value = document.getElementById('nrDokumentu').value || '';
});

closeForm.addEventListener('click', ()=> formModal.style.display = 'none');

function showStep(n){
  step1.classList.toggle('active', n===1);
  step2.classList.toggle('active', n===2);
}

/* Next -> synchronizuj nag≈Ç√≥wek i przejd≈∫ do kroku 2 */
nextToProducts.addEventListener('click', ()=>{
  // sync header form -> top header immediately (as user wanted)
  syncHeaderFormToTop();
  // populate first selected row data into form fields
  populateRowSelect();
  selectRowInForm(0); // default first logical row
  showStep(2);
});

/* back */
backToHeader.addEventListener('click', ()=>{
  showStep(1);
});

/* sync header: wpisane w formularzu warto≈õci trafiajƒÖ do headera */
function syncHeaderFormToTop(){
  const klient = document.getElementById('formKlient').value;
  const adres = document.getElementById('formAdres').value;
  const nrStada = document.getElementById('formNrStada').value;
  const dataZ = document.getElementById('formDataZgloszenia').value;
  const dataW = document.getElementById('formDataWykonania').value;
  const nrDok = document.getElementById('formNrDokumentu').value;
  document.getElementById('klientSelect').value = klient;
  document.getElementById('adresKlienta').textContent = adres;
  document.getElementById('nrStada').textContent = nrStada;
  if (dataZ) document.getElementById('dataZgloszenia').value = dataZ;
  if (dataW) document.getElementById('dataWykonania').value = dataW;
  document.getElementById('nrDokumentu').value = nrDok;
}

/* ---- Row select: wype≈Çnij select indeksami logicznych wierszy (1..13 bez wiersza 10) ---- */
function populateRowSelect(){
  const sel = formRowSelect;
  sel.innerHTML = '';
  const logical = rowsEditable();
  logical.forEach((tr, idx) => {
    // compute displayed row number -> use first cell (like "1." etc)
    const display = tr.cells[0].textContent || (idx+1)+'.';
    const opt = document.createElement('option');
    opt.value = idx; // index within logical array
    opt.textContent = (idx+1) + '.';
    sel.appendChild(opt);
  });
}

/* ---- wybierz kolejny/poprzedni w formularzu ---- */
document.getElementById('nextRow').addEventListener('click', ()=>{
  const sel = formRowSelect;
  const prevIdx = parseInt(sel.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx); // autozapis obecnego wiersza
  if (sel.selectedIndex < sel.options.length - 1) sel.selectedIndex++;
  sel.dispatchEvent(new Event('change'));
});

document.getElementById('prevRow').addEventListener('click', ()=>{
  const sel = formRowSelect;
  const prevIdx = parseInt(sel.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx); // autozapis obecnego wiersza
  if (sel.selectedIndex > 0) sel.selectedIndex--;
  sel.dispatchEvent(new Event('change'));
});

// dodatkowo przy rƒôcznym wyborze wiersza w dropdown autozapis
formRowSelect.addEventListener('change', ()=>{
  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx); // teraz zapisze r√≥wnie≈º 0
  const idx = parseInt(formRowSelect.value,10);
  selectRowInForm(idx);
  formRowSelect.dataset.prevIndex = idx;
});



/* ---- zapis aktualnego wiersza przy zmianie wiersza w formularzu ---- */
formRowSelect.addEventListener('change', ()=> {
  // zapis aktualnego wiersza przed przej≈õciem do nowego
  const prevIdx = parseInt(formRowSelect.dataset.prevIndex, 10);
  if (!isNaN(prevIdx)) {
    saveRow(prevIdx);
  }
  const idx = parseInt(formRowSelect.value, 10);
  selectRowInForm(idx);
  formRowSelect.dataset.prevIndex = idx; // zapamiƒôtaj nowy indeks
});

/* ---- funkcja zapisu wiersza (je≈õli jeszcze nie masz) ---- */
function saveRow(idx){
  const logical = rowsEditable();
  const row = logical[idx];
  if (!row) return;

  // write values
  row.cells[1].textContent = document.getElementById('formOpis').value;
  const inp2 = row.cells[2].querySelector('input');
  if (inp2) inp2.value = document.getElementById('formLiczba').value;
  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
  const produktInput = row.cells[4].querySelector('input');
  if (produktInput) {
    produktInput.value = document.getElementById('formLek').value;
    produktInput.dispatchEvent(new Event('input', { bubbles:true }));
  }
  row.cells[5].textContent = document.getElementById('formSeria').value;
  const iloInp = row.cells[6].querySelector('input');
  if (iloInp) iloInp.value = document.getElementById('formDawkowanie').value || iloInp.value;
  row.cells[7].textContent = document.getElementById('formKarencja').value;
  row.classList.add('highlight-row');
  setTimeout(()=>row.classList.remove('highlight-row'), 1600);
}


function selectRowInForm(logicalIndex){
  const logical = rowsEditable();
  const row = logical[logicalIndex];
  if (!row) return;
  // load values into form
  document.getElementById('formOpis').value = row.cells[1].textContent.trim();
  const inp = row.cells[2].querySelector('input');
  document.getElementById('formLiczba').value = inp ? inp.value : '';
  document.getElementById('formRozpoznanie').value = row.cells[3].textContent.trim();
  const lekInput = row.cells[4].querySelector('input');
  document.getElementById('formLek').value = lekInput ? lekInput.value : '';
  document.getElementById('formSeria').value = row.cells[5].textContent.trim();
  // ilo≈õƒá w kom√≥rce 6 mo≈ºe byƒá input + tekst dawkowania
  // --- Wczytanie ilo≈õci i dawkowania z kom√≥rki 6 ---
const cell6 = row.cells[6];

// liczba (ma≈Çy input)
const iloscInput = cell6.querySelector('input[type="number"]');
document.getElementById('formIlosc').value = iloscInput ? iloscInput.value : '';

// tekst po input (dawkowanie)
let tekstDawkowania = '';
if (cell6.childNodes.length > 1 && cell6.childNodes[1].nodeType === Node.TEXT_NODE) {
  tekstDawkowania = cell6.childNodes[1].textContent.trim();
}
document.getElementById('formDawkowanie').value = tekstDawkowania;

  document.getElementById('formKarencja').value = row.cells[7].textContent.trim();
}

/* ---- po wyborze produktu w formularzu automatycznie uzupe≈Çnij seria/dawkowanie/karencja ---- */
document.getElementById('formLek').addEventListener('input', function(){
  const n = this.value;
  document.getElementById('formSeria').value = mapaSerii[n] || '';
  // je≈õli dawkowanie ma byƒá w polu 'tekstowym' (zachowujemy format tabeli)
  document.getElementById('formDawkowanie').value = mapaIlosci[n] || '';
  document.getElementById('formKarencja').value = mapaKarencji[n] || '';
});

/* ---- zapis wiersza: zapisuje do logicznego wiersza (nie zmienia struktury tabeli) ---- */
document.getElementById('saveRow').addEventListener('click', ()=>{
  const idx = parseInt(formRowSelect.value,10);
  const logical = rowsEditable();
  const row = logical[idx];
  if (!row) { alert('Brak wybranego wiersza'); return; }

  // write values
  row.cells[1].textContent = document.getElementById('formOpis').value;
  // cell 2 -> input
  const inp2 = row.cells[2].querySelector('input');
  if (inp2) inp2.value = document.getElementById('formLiczba').value;
  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
  // produkt input
  const produktInput = row.cells[4].querySelector('input');
  if (produktInput) {
    produktInput.value = document.getElementById('formLek').value;
    // dispatch input event to trigger table logic (fills serie/ilosc/karencja like original)
    produktInput.dispatchEvent(new Event('input', { bubbles:true }));
  }
  // series
  row.cells[5].textContent = document.getElementById('formSeria').value;
  // ilo≈õƒá -> if there's input inside cell[6], set it; otherwise set text
  const iloInp = row.cells[6].querySelector('input');
  if (iloInp) {
    // if user provided numeric in formDawkowanie, try set numeric portion
    // but the table's cell[6] holds "<input> dostawanieTekst", so set input value
    iloInp.value = document.getElementById('formDawkowanie').value || iloInp.value;
    // ensure we don't destroy trailing dosing text - that part comes from map and already set by productInput.dispatchEvent
  } else {
    row.cells[6].textContent = document.getElementById('formDawkowanie').value;
  }
  row.cells[7].textContent = document.getElementById('formKarencja').value;

  // Visually confirm
  row.classList.add('highlight-row');
  setTimeout(()=>row.classList.remove('highlight-row'), 1600);
  alert('Wiersz zapisany.');
});

/* ---- przycisk przepisz w formularzu: przenie≈õ dane z pierwszego wiersza do wiersza 10 i przenie≈õ u≈ºytkownika tam ---- */
document.getElementById('formCopyBtn').addEventListener('click', ()=>{
  copyToRow10FromRow0();

  // ustaw w formularzu na wiersz 10 (indeks logiczny 9)
  const sel = formRowSelect;
  sel.value = 9; // 0-based index
  sel.dispatchEvent(new Event('change'));

  // przewi≈Ñ do wiersza 10 w tabeli
  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
  const special = tbodyTrs.find(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
  if (special) { 
    special.scrollIntoView({behavior:'smooth', block:'center'}); 
    special.classList.add('highlight-row'); 
    setTimeout(()=>special.classList.remove('highlight-row'),2000); 
  }

  // formularz pozostaje otwarty
});


/* ---- przycisk g√≥rny: przepisz dane z leczenia na miejscu (tak jak oryginalnie) ---- */
document.getElementById('copyBtn').addEventListener('click', ()=> {
  // wykonaj kopiƒô i przewi≈Ñ do wiersza 10
  copyToRow10FromRow0();
});

/* ---- mikrofon (dyktowanie nazwy leku) ---- */
document.getElementById('micBtn').addEventListener('click', ()=>{
  // check for SpeechRecognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { alert('Twoja przeglƒÖdarka nie obs≈Çuguje rozpoznawania mowy'); return; }
  const rec = new SpeechRecognition();
  rec.lang = 'pl-PL';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.start();
  rec.onresult = (e) => {
    const text = e.results[0][0].transcript;
    document.getElementById('formLek').value = text;
    // auto-fill based on recognized name (best effort)
    document.getElementById('formSeria').value = mapaSerii[text] || '';
    document.getElementById('formDawkowanie').value = mapaIlosci[text] || '';
    document.getElementById('formKarencja').value = mapaKarencji[text] || '';
  };
  rec.onerror = (ev) => {
    console.error('Speech error', ev);
    alert('B≈ÇƒÖd rozpoznawania mowy: ' + (ev.error || 'nieznany'));
  };
});

/* ---- podpis (Wersja z blokadƒÖ ma≈Çego p≈Ç√≥tna) ---- */
/* ---- podpis (Wersja z blokadƒÖ i auto-resize) ---- */
/* ---- podpis (Wersja z blokadƒÖ, auto-resize i wymuszeniem landscape) ---- */
function initSignature(id){
  const canvas = document.getElementById(id); // Ma≈Çe p≈Ç√≥tno
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  canvas.classList.add('disabled'); // Zablokuj ma≈Çe p≈Ç√≥tno

  // Przyciski i overlay
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const clearSignBtn = document.getElementById('clearSignBtn');
  const fullscreenOverlay = document.getElementById('fullscreenOverlay');
  const fullscreenCanvas = document.getElementById('fullscreenCanvas'); // Du≈ºe p≈Ç√≥tno
  const closeBtn = document.getElementById('closeSignBtn');
  const clearFullscreenBtn = document.getElementById('clearFullscreenSignBtn');

  let fDrawing = false;
  let fctx;

  function getFPos(e){
    const rect = fullscreenCanvas.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  // ‚úÖ ZMIANA: Dodano sprawdzanie orientacji przed rozpoczƒôciem rysowania
  const startDrawingFullscreen = e => {
    // Sprawd≈∫ orientacjƒô - prostsza metoda por√≥wnania wymiar√≥w okna
    if (window.innerHeight > window.innerWidth) {
        alert("Proszƒô obr√≥ciƒá urzƒÖdzenie do pozycji poziomej, aby podpisaƒá.");
        fDrawing = false; // Upewnij siƒô, ≈ºe rysowanie jest zablokowane
        return; // Zako≈Ñcz funkcjƒô, nie zaczynaj rysowaƒá
    }
    // Je≈õli jest landscape, kontynuuj normalnie
    fDrawing = true;
    const pos=getFPos(e);
    fctx.beginPath();
    fctx.moveTo(pos.x,pos.y);
  };
  const drawFullscreen = e => { if(fDrawing){ const pos=getFPos(e); fctx.lineTo(pos.x,pos.y); fctx.stroke(); }};
  const stopDrawingFullscreen = () => { fDrawing = false; };

  const handleResize = () => {
    if (fullscreenOverlay.style.display !== 'flex') {
      window.removeEventListener('resize', handleResize);
      return;
    }
    const newWidth = fullscreenCanvas.offsetWidth;
    const newHeight = fullscreenCanvas.offsetHeight;
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = fullscreenCanvas.width;
    tempCanvas.height = fullscreenCanvas.height;
    if (fullscreenCanvas.width > 0 && fullscreenCanvas.height > 0) {
       tempCtx.drawImage(fullscreenCanvas, 0, 0);
    }
    fullscreenCanvas.width = newWidth;
    fullscreenCanvas.height = newHeight;
    fctx = fullscreenCanvas.getContext('2d');
    fctx.lineWidth = 6; // Ustawiamy grubo≈õƒá linii (poprawiona z ostatniej zmiany)
    fctx.lineCap = 'round';
    if (tempCanvas.width > 0 && tempCanvas.height > 0) {
       fctx.drawImage(tempCanvas, 0, 0, newWidth, newHeight);
    }
  };

  // --- Obs≈Çuga przycisk√≥w ---
  fullscreenBtn.addEventListener('click', async ()=>{ // Zmieniono na async dla await
    fullscreenOverlay.style.display = 'flex';

    // ‚úÖ ZMIANA: Spr√≥buj zablokowaƒá orientacjƒô na poziomƒÖ
    try {
        if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock('landscape');
            console.log("Orientacja zablokowana na landscape.");
        } else {
            console.warn("Screen Orientation API not fully supported.");
        }
    } catch (error) {
        console.error("Nie uda≈Ço siƒô zablokowaƒá orientacji:", error);
        // Mo≈ºna tu dodaƒá komunikat dla u≈ºytkownika, je≈õli blokada jest krytyczna
        // alert("Nie uda≈Ço siƒô wymusiƒá orientacji poziomej. Spr√≥buj obr√≥ciƒá urzƒÖdzenie rƒôcznie.");
    }

    requestAnimationFrame(() => {
        const canvasWidth = fullscreenCanvas.offsetWidth;
        const canvasHeight = fullscreenCanvas.offsetHeight;
        fullscreenCanvas.width = canvasWidth;
        fullscreenCanvas.height = canvasHeight;

        fctx = fullscreenCanvas.getContext('2d');
        fctx.clearRect(0, 0, canvasWidth, canvasHeight);
        fctx.lineWidth = 6; // Ustawiamy grubo≈õƒá linii
        fctx.lineCap = 'round';
        fctx.drawImage(canvas, 0, 0, canvasWidth, canvasHeight);

        fullscreenCanvas.addEventListener('pointerdown', startDrawingFullscreen);
        fullscreenCanvas.addEventListener('pointermove', drawFullscreen);
        fullscreenCanvas.addEventListener('pointerup', stopDrawingFullscreen);
        fullscreenCanvas.addEventListener('pointerleave', stopDrawingFullscreen);

        window.addEventListener('resize', handleResize);
    });

  });

  closeBtn.addEventListener('click', ()=>{
    window.removeEventListener('resize', handleResize);

    // ‚úÖ ZMIANA: Odblokuj orientacjƒô
    if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
        console.log("Orientacja odblokowana.");
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(fullscreenCanvas, 0, 0, canvas.width, canvas.height);

    fullscreenOverlay.style.display = 'none';

    fullscreenCanvas.removeEventListener('pointerdown', startDrawingFullscreen);
    fullscreenCanvas.removeEventListener('pointermove', drawFullscreen);
    fullscreenCanvas.removeEventListener('pointerup', stopDrawingFullscreen);
    fullscreenCanvas.removeEventListener('pointerleave', stopDrawingFullscreen);
  });

  clearFullscreenBtn.addEventListener('click', ()=>{
      if (fctx) {
        fctx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
      }
  });

  clearSignBtn.addEventListener('click', ()=>{ ctx.clearRect(0, 0, canvas.width, canvas.height); });

} // Koniec initSignature

// Inicjalizacja (bez zmian)
window.addEventListener('load', ()=> initSignature('canvasPosiadacz'));
/* ---- zapis wiersza automatycznie przy zmianie wiersza ---- */
formRowSelect.addEventListener('change', ()=>{
  // zapis aktualnego wiersza przed przej≈õciem do nowego
  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) {
    saveRow(prevIdx);
  }
  const idx = parseInt(formRowSelect.value,10);
  selectRowInForm(idx);
  formRowSelect.dataset.prevIndex = idx; // zapamiƒôtaj nowy indeks
});

/* ---- funkcja zapisu wiersza (przeniesiona w g√≥rƒô aby mo≈ºna u≈ºyƒá dynamicznie) ---- */
function saveRow(idx){
  const logical = rowsEditable();
  const row = logical[idx];
  if (!row) return;

  // write values
  row.cells[1].textContent = document.getElementById('formOpis').value;
  const inp2 = row.cells[2].querySelector('input');
  if (inp2) inp2.value = document.getElementById('formLiczba').value;
  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
  const produktInput = row.cells[4].querySelector('input');
  if (produktInput) {
    produktInput.value = document.getElementById('formLek').value;
    produktInput.dispatchEvent(new Event('input', { bubbles:true }));
  }
  row.cells[5].textContent = document.getElementById('formSeria').value;

// --- ZAPIS ILO≈öCI I DAWKOWANIA ---
const cell = row.cells[6]; // kolumna Ilo≈õƒá / dawkowanie
const iloscInput = cell.querySelector('input[type="number"]');
if (iloscInput) {
  // przepisz warto≈õƒá liczbowƒÖ z formularza
  iloscInput.value = document.getElementById('formIlosc').value || '';
}

const dawkowanie = document.getElementById('formDawkowanie').value || '';
// je≈õli po input jest tekst ‚Äî zaktualizuj go
if (cell.childNodes.length > 1 && cell.childNodes[1].nodeType === Node.TEXT_NODE) {
  cell.childNodes[1].textContent = ' ' + dawkowanie;
} else {
  // je≈õli brak tekstu ‚Äî dodaj nowy
  cell.appendChild(document.createTextNode(' ' + dawkowanie));
}

// --- pozosta≈Çe pola ---
row.cells[7].textContent = document.getElementById('formKarencja').value;

// efekt wizualny: pod≈õwietlenie zapisanego wiersza
row.classList.add('highlight-row');
setTimeout(() => row.classList.remove('highlight-row'), 1600);

}

/* ---- przycisk Zako≈Ñcz w kroku 2 ---- */
const finishBtn = document.createElement('button');
finishBtn.textContent = 'Zako≈Ñcz';
finishBtn.className = 'btn warn small';
finishBtn.style.marginLeft = '6px';
finishBtn.addEventListener('click', ()=>{
  const idx = parseInt(formRowSelect.value,10);
  saveRow(idx);          // zapis obecnego wiersza
  syncHeaderFormToTop(); // aktualizacja nag≈Ç√≥wka
  formModal.style.display = 'none'; // zamknij formularz
});
step2.querySelector('.form-actions .right').appendChild(finishBtn);
// Dopasowanie formularza do ekranu przy rotacji lub resize
window.addEventListener("resize", () => {
  const modal = document.getElementById("formModal");
  const card = modal.querySelector(".form-card");
  if (card) {
    card.style.height = window.innerHeight * 0.99 + "px";
    card.style.width = Math.min(window.innerWidth * 0.95, 600) + "px";
  }
});
// üé§ Dyktowanie g≈Çosowe dla pola "Okres karencji / uwagi"
const micBtn = document.getElementById('micKarencja');
const karencjaInput = document.getElementById('formKarencja');

if ('webkitSpeechRecognition' in window) {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'pl-PL';
  recognition.continuous = false;
  recognition.interimResults = false;

  micBtn.addEventListener('click', () => {
    if (micBtn.classList.contains('active')) {
      recognition.stop();
      micBtn.classList.remove('active');
    } else {
      recognition.start();
      micBtn.classList.add('active');
    }
  });

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    karencjaInput.value = karencjaInput.value
      ? karencjaInput.value + ' ' + text
      : text;
  };

  recognition.onerror = (e) => {
    console.error('B≈ÇƒÖd rozpoznawania mowy:', e.error);
    micBtn.classList.remove('active');
  };

  recognition.onend = () => {
    micBtn.classList.remove('active');
  };
} else {
  micBtn.style.display = 'none';
  console.warn('Rozpoznawanie mowy nie jest obs≈Çugiwane w tej przeglƒÖdarce.');
}
// === Obs≈Çuga przycisku Drukuj i zapisu e-maila ===

// Drukuj (je≈õli chcesz ≈ºeby klikniƒôcie tego przycisku wywo≈Ça≈Ço window.print)
const drukujBtn = document.getElementById('drukujBtn');
if (drukujBtn) {
  drukujBtn.addEventListener('click', () => {
    window.print();
  });
}

// Elementy e-mail
const emailInput = document.getElementById('userEmail');
const saveEmailBtn = document.getElementById('saveEmail');

// Wczytaj zapisany e-mail z localStorage (je≈õli jest)
try {
  const savedEmail = localStorage.getItem('userEmail');
  if (savedEmail && emailInput) emailInput.value = savedEmail;
} catch (e) {
  console.warn('Brak dostƒôpu do localStorage:', e);
}

// Zapisuj e-mail po klikniƒôciu przycisku üíæ
if (saveEmailBtn && emailInput) {
  saveEmailBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if (!email) {
      alert('‚ö†Ô∏è Wprowad≈∫ adres e-mail.');
      return;
    }
    // podstawowa walidacja
    if (!email.includes('@') || !email.includes('.')) {
      alert('‚ö†Ô∏è Wprowad≈∫ poprawny adres e-mail.');
      return;
    }
    try {
      localStorage.setItem('userEmail', email);
      alert('üì® Adres e-mail zosta≈Ç zapisany lokalnie.');
    } catch (e) {
      console.error('B≈ÇƒÖd zapisu w localStorage:', e);
      alert('‚ùå Nie uda≈Ço siƒô zapisaƒá adresu e-mail lokalnie.');
    }
  });
}
</script>
<script>
<script>
// ========================================================
// DEKLARACJE G≈Å√ìWNYCH ZMIENNYCH UI (POCZƒÑTEK SKRYPTU)
// ========================================================

// --- Zmienne Sekcji ---
const kartaSection = document.getElementById('kartaLeczeniaSection');
const kalkulatorSection = document.getElementById('kalkulatorWizytySection');
const bazaKlientowSection = document.getElementById('bazaKlientowSection');

// --- Zmienne Przycisk√≥w Zak≈Çadek ---
const tabKartaBtn = document.getElementById('tabKartaBtn');
const tabKalkulatorBtn = document.getElementById('tabKalkulatorBtn');
const tabBazaKlientowBtn = document.getElementById('tabBazaKlientowBtn');

// --- Zmienne Bazy Klient√≥w ---
const klientTableBody = document.getElementById('klientTableBody');
const addNewClientBtn = document.getElementById('addNewClientBtn');
const clientSearchInput = document.getElementById('clientSearchInput'); // Wyszukiwarka
const importFromSheetBtn = document.getElementById('importFromSheetBtn'); // Import

// --- Zmienne Modala Klienta (Edycja/Dodawanie) ---
const clientFormModal = document.getElementById('clientFormModal');
const clientFormTitle = document.getElementById('clientFormTitle');
const cancelClientForm = document.getElementById('cancelClientForm');
const saveClientBtn = document.getElementById('saveClientBtn');
const clientFormDocId = document.getElementById('clientFormDocId');
const clientFormNazwa = document.getElementById('clientFormNazwa');
const clientFormAdres = document.getElementById('clientFormAdres');
const clientFormNrStada = document.getElementById('clientFormNrStada');
const clientFormNrTelefonu = document.getElementById('clientFormNrTelefonu');
const clientFormEmail = document.getElementById('clientFormEmail');
const clientFormIdLecznicy = document.getElementById('clientFormIdLecznicy');

// --- Zmienne Modala Importu (Wklejanie) ---
const pasteDataModal = document.getElementById('pasteDataModal');
const pasteTextarea = document.getElementById('pasteTextarea');
const cancelPasteData = document.getElementById('cancelPasteData');
const savePasteDataBtn = document.getElementById('savePasteDataBtn');

// --- Inne zmienne UI ---
const openCalcBtn = document.getElementById('openCalculatorBtn'); // Przycisk z Karty Leczenia

// ========================================================
// REJESTRACJA SERVICE WORKERA
// ========================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('‚úÖ Service Worker zarejestrowany!'))
    .catch(err => console.error('‚ùå B≈ÇƒÖd rejestracji SW:', err));
}

// ========================================================
// FUNKCJA PRZE≈ÅƒÑCZANIA ZAK≈ÅADEK
// ========================================================
function showSection(sectionToShow) {
  // Ukryj wszystkie sekcje
  if (kartaSection) kartaSection.style.display = 'none';
  if (kalkulatorSection) kalkulatorSection.style.display = 'none';
  if (bazaKlientowSection) bazaKlientowSection.style.display = 'none';

  // Odznacz wszystkie przyciski
  if (tabKartaBtn) tabKartaBtn.classList.remove('primary');
  if (tabKalkulatorBtn) tabKalkulatorBtn.classList.remove('primary');
  if (tabBazaKlientowBtn) tabBazaKlientowBtn.classList.remove('primary');

  // Poka≈º wybranƒÖ sekcjƒô i zaznacz przycisk
  if (sectionToShow === 'karta' && kartaSection) {
    kartaSection.style.display = 'block';
    if (tabKartaBtn) tabKartaBtn.classList.add('primary');
  } else if (sectionToShow === 'kalkulator' && kalkulatorSection) {
    kalkulatorSection.style.display = 'block';
    if (tabKalkulatorBtn) tabKalkulatorBtn.classList.add('primary');
    renderReceipt(); // Przelicz sumƒô po prze≈ÇƒÖczeniu (je≈õli istnieje)
  } else if (sectionToShow === 'baza' && bazaKlientowSection) {
    bazaKlientowSection.style.display = 'block';
    if (tabBazaKlientowBtn) tabBazaKlientowBtn.classList.add('primary');
    // Za≈Çaduj dane do tabeli przy ka≈ºdym prze≈ÇƒÖczeniu na tƒô zak≈Çadkƒô
    loadClientsToTable();
  }
}

// ========================================================
// DODAWANIE EVENT LISTENERS (Nas≈Çuchiwanie na klikniƒôcia/wpisywanie)
// ========================================================

// --- Listenery Przycisk√≥w Zak≈Çadek ---
if (tabKartaBtn) {
    tabKartaBtn.addEventListener('click', () => showSection('karta'));
}
if (tabKalkulatorBtn) {
    tabKalkulatorBtn.addEventListener('click', () => showSection('kalkulator'));
}
if (tabBazaKlientowBtn) {
    tabBazaKlientowBtn.addEventListener('click', () => showSection('baza'));
}

// --- Listener Wyszukiwarki Klient√≥w ---
if (clientSearchInput) {
    clientSearchInput.addEventListener('input', filterClientTable);
}

// --- Listener Przycisku "Otw√≥rz Kalkulator" z Karty Leczenia ---
if (openCalcBtn) {
    openCalcBtn.addEventListener('click', () => showSection('kalkulator'));
}

// ========================================================
// POZOSTA≈ÅA LOGIKA APLIKACJI (Kalkulator, Baza Klient√≥w itd.)
// ========================================================

// ‚úÖ POCZƒÑTEK: Zaktualizowany kod dla Kalkulatora Wizyty (z cenami)
// --- Logika Kalkulatora (z cenami) ---
// ... (tutaj zaczyna siƒô reszta Twojego kodu dla kalkulatora, importu Firebase, CRUD bazy klient√≥w itd.) ...
// --- Logika Kalkulatora (z cenami) ---
// --- Logika Kalkulatora (poczƒÖtkowa) ---
const copyCheckbox = document.getElementById('copyFromCardCheckbox');
const productSelect = document.getElementById('productSelect');
const quantityInput = document.getElementById('productQuantityInput');
const addProductBtn = document.getElementById('addProductBtn');
const receiptDisplay = document.getElementById('receiptDisplay');
const saveReceiptBtn = document.getElementById('saveReceiptBtn');
const savedReceiptSummary = document.getElementById('savedReceiptSummary');
const pluCodeInput = document.getElementById('pluCodeInput');
const pluBtn = document.getElementById('pluBtn');
const productUnitDisplay = document.getElementById('productUnitDisplay');
// Tablica przechowuje teraz { name: '...', quantity: 1, price: 10.50 }
let receiptItems = [];
// receiptTotal jest teraz zadeklarowany globalnie (wcze≈õniej w kodzie)

// Funkcja formatujƒÖca cenƒô
function formatPrice(price) {
    // Sprawd≈∫ czy price jest liczbƒÖ, je≈õli nie zwr√≥ƒá "0,00 z≈Ç"
    if (isNaN(price) || price === null) {
        return '0,00 z≈Ç';
    }
    return price.toFixed(2).replace('.', ',') + ' z≈Ç'; // Formatuj jako X,XX z≈Ç
}


// Funkcja renderujƒÖca paragon z cenami i sumƒÖ
function renderReceipt() {
  if (!receiptDisplay) return;

  receiptTotal = 0; // Zresetuj sumƒô przed przeliczeniem
  receiptDisplay.innerHTML = ''; // Wyczy≈õƒá

  if (receiptItems.length === 0) {
    receiptDisplay.innerHTML = '<p style="text-align: center; color: #999;">Paragon jest pusty</p>';
    // Dodaj div na sumƒô, nawet gdy paragon jest pusty
    const totalDivEmpty = document.createElement('div');
    totalDivEmpty.style.textAlign = 'right';
    totalDivEmpty.style.marginTop = '10px';
    totalDivEmpty.style.fontWeight = 'bold';
    totalDivEmpty.textContent = `Suma: ${formatPrice(receiptTotal)}`;
    receiptDisplay.appendChild(totalDivEmpty);
    return;
  }

  const list = document.createElement('ul');
  list.style.listStyle = 'none'; list.style.padding = '0'; list.style.margin = '0';

  receiptItems.forEach((item, index) => {
    // Upewnij siƒô, ≈ºe quantity i price sƒÖ liczbami
    const quantity = Number(item.quantity) || 0;
    const price = Number(item.price) || 0;
    const itemTotal = quantity * price;
    receiptTotal += itemTotal; // Dodaj do sumy ca≈Çkowitej

    const listItem = document.createElement('li');
    listItem.style.display = 'flex';
    listItem.style.justifyContent = 'space-between';
    listItem.style.alignItems = 'center'; // Lepsze wyr√≥wnanie pionowe
    listItem.style.marginBottom = '5px';
    listItem.style.borderBottom = '1px solid #eee';
    listItem.style.paddingBottom = '3px';

    // Kontener na nazwƒô i cenƒô jednostkowƒÖ
    const namePriceDiv = document.createElement('div');
    const nameSpan = document.createElement('span');
    nameSpan.textContent = item.name;
    namePriceDiv.appendChild(nameSpan);

    // Dodaj cenƒô jednostkowƒÖ pod nazwƒÖ (mniejszƒÖ czcionkƒÖ)
    const unitPriceSpan = document.createElement('span');
    unitPriceSpan.textContent = ` (${formatPrice(price)}/szt.)`; // Zak≈Çadamy cenƒô za sztukƒô
    unitPriceSpan.style.fontSize = '0.9em';
    unitPriceSpan.style.color = '#666';
    unitPriceSpan.style.marginLeft = '5px';
    namePriceDiv.appendChild(unitPriceSpan);

    // Kontener na ilo≈õƒá, cenƒô pozycji i przycisk usu≈Ñ
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = 'flex';
    controlsDiv.style.alignItems = 'center';
    controlsDiv.style.gap = '8px';

    const quantitySpan = document.createElement('span');
    quantitySpan.textContent = `x ${quantity}`;
    quantitySpan.style.minWidth = '40px'; // Ustawienie minimalnej szeroko≈õci

    // Dodaj cenƒô za ca≈ÇƒÖ pozycjƒô
    const itemTotalSpan = document.createElement('span');
    itemTotalSpan.textContent = formatPrice(itemTotal);
    itemTotalSpan.style.fontWeight = 'bold';
    itemTotalSpan.style.minWidth = '60px'; // Ustawienie minimalnej szeroko≈õci
    itemTotalSpan.style.textAlign = 'right';

    const removeBtn = document.createElement('button');
    removeBtn.textContent = '‚ùå';
    removeBtn.className = 'btn small ghost';
    removeBtn.style.padding = '2px 5px';
    removeBtn.title = 'Usu≈Ñ pozycjƒô';
    removeBtn.onclick = () => {
      receiptItems.splice(index, 1);
      renderReceipt(); // Przelicz i od≈õwie≈º
    };

    controlsDiv.appendChild(quantitySpan);
    controlsDiv.appendChild(itemTotalSpan); // Dodano cenƒô pozycji
    controlsDiv.appendChild(removeBtn);

    listItem.appendChild(namePriceDiv); // Lewa strona (nazwa + cena jedn.)
    listItem.appendChild(controlsDiv); // Prawa strona (ilo≈õƒá, cena poz., usu≈Ñ)
    list.appendChild(listItem);
  });
  receiptDisplay.appendChild(list);

  // Dodaj sumƒô ca≈ÇkowitƒÖ na dole
  const totalDiv = document.createElement('div');
  totalDiv.style.textAlign = 'right';
  totalDiv.style.marginTop = '10px';
  totalDiv.style.fontWeight = 'bold';
  totalDiv.style.fontSize = '1.1em';
  totalDiv.textContent = `Suma: ${formatPrice(receiptTotal)}`;
  receiptDisplay.appendChild(totalDiv);
}

// Funkcja pomocnicza do dodawania lub aktualizowania pozycji
function addItemToReceipt(productName, quantity) {
    // Upewnij siƒô, ≈ºe quantity jest liczbƒÖ
    const numQuantity = Number(quantity) || 0;
    if (numQuantity <= 0) return; // Nie dodawaj je≈õli ilo≈õƒá jest zerowa lub niepoprawna

    const price = mapaCen[productName] || 0; // Pobierz cenƒô z mapy

    const existingItem = receiptItems.find(item => item.name === productName);
    if (existingItem) {
        existingItem.quantity = (Number(existingItem.quantity) || 0) + numQuantity; // Upewnij siƒô, ≈ºe dodajesz liczby
    } else {
        receiptItems.push({ name: productName, quantity: numQuantity, price: price }); // Dodaj z cenƒÖ
    }
    renderReceipt(); // Przelicz i od≈õwie≈º
}

// Dodawanie produktu z formularza (u≈ºywa addItemToReceipt)
if (addProductBtn) {
    addProductBtn.addEventListener('click', () => {
      const productName = productSelect ? productSelect.value.trim() : '';
      const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 0;

      if (productName && quantity > 0) {
        if (typeof nazwyLekow !== 'undefined' && nazwyLekow.includes(productName)) {
           addItemToReceipt(productName, quantity); // U≈ºyj funkcji pomocniczej
           if (productSelect) productSelect.value = '';
           if (quantityInput) quantityInput.value = 1;
        } else { alert('Wybrany produkt nie znajduje siƒô w bazie lek√≥w.'); }
      } else { alert('Wybierz produkt i podaj poprawnƒÖ ilo≈õƒá.'); }
    });
}

// Kopiowanie z karty leczenia (u≈ºywa addItemToReceipt)
if (copyCheckbox) {
    copyCheckbox.addEventListener('change', () => {
      if (copyCheckbox.checked) {
        receiptItems = []; // Wyczy≈õƒá obecny paragon
        const rows = document.querySelectorAll('#karta tbody tr');
        rows.forEach(row => {
          if (row.cells.length === 8) {
            const lekInput = row.cells[4].querySelector('input[list="listaLekow"]');
            const iloscInput = row.cells[6].querySelector('input.small-input');

            if (lekInput && iloscInput) {
                 const productName = lekInput.value.trim();
                 const quantityValue = iloscInput.value;
                 const quantity = quantityValue ? parseInt(quantityValue, 10) : 0;

                 if (productName && quantity > 0) {
                    if (mapaCen.hasOwnProperty(productName)){
                       addItemToReceipt(productName, quantity);
                    } else {
                       console.warn(`Pominiƒôto kopiowanie: Produkt "${productName}" nie znaleziony w bazie cen.`);
                       // Opcjonalnie dodaj z cenƒÖ 0
                       // addItemToReceipt(productName, quantity);
                    }
                 }
            }
          }
        });
        // renderReceipt() jest ju≈º w addItemToReceipt
      }
    });
}

// Zapisywanie paragonu (dodaje sumƒô)
if (saveReceiptBtn) {
    saveReceiptBtn.addEventListener('click', () => {
      if (receiptItems.length > 0) {
        if (savedReceiptSummary) {
            savedReceiptSummary.innerHTML = '<h4>Zapisany Paragon:</h4>';
            const list = document.createElement('ul');
            list.style.listStyle = 'none'; list.style.paddingLeft = '10px';
            receiptItems.forEach(item => {
              const li = document.createElement('li');
              const quantity = Number(item.quantity) || 0;
              const price = Number(item.price) || 0;
              const itemTotal = quantity * price;
              li.textContent = `${item.name} x ${quantity} = ${formatPrice(itemTotal)}`;
              list.appendChild(li);
            });
            savedReceiptSummary.appendChild(list);
            const totalP = document.createElement('p');
            totalP.style.fontWeight = 'bold';
            totalP.style.textAlign = 'right';
            totalP.textContent = `Suma: ${formatPrice(receiptTotal)}`;
            savedReceiptSummary.appendChild(totalP);
        }
        alert('Paragon zapisany (tymczasowo).');
      } else { alert('Paragon jest pusty, nie ma czego zapisywaƒá.'); }
    });
}

// Obs≈Çuga PLU (u≈ºywa addItemToReceipt)
if (pluBtn) {
    pluBtn.addEventListener('click', () => {
        const code = pluCodeInput ? pluCodeInput.value.trim() : '';
        if(code){
            const productName = code; // Uproszczenie: kod = nazwa
            if (typeof nazwyLekow !== 'undefined' && nazwyLekow.includes(productName)) {
                addItemToReceipt(productName, 1); // Domy≈õlnie 1 szt.
                if (pluCodeInput) pluCodeInput.value = '';
            } else { alert(`Nie znaleziono produktu dla kodu PLU: ${code}`); }
        }
    });
}
// ‚úÖ DODANO: Aktualizacja jednostki/dawkowania po wyborze produktu
if (productSelect && productUnitDisplay) {
    productSelect.addEventListener('input', () => {
        const selectedProductName = productSelect.value;
        // Sprawd≈∫, czy mapaIlosci istnieje i czy zawiera wybrany produkt
        if (typeof mapaIlosci !== 'undefined' && mapaIlosci.hasOwnProperty(selectedProductName)) {
            // Wy≈õwietl ca≈Çe dawkowanie jako jednostkƒô
            productUnitDisplay.textContent = mapaIlosci[selectedProductName] || '';
        } else {
            productUnitDisplay.textContent = ''; // Wyczy≈õƒá, je≈õli nie znaleziono dawkowania
        }
    });
}
// ‚úÖ DODANO: KONIEC
// Pierwsze renderowanie paragonu
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderReceipt);
} else {
    if (document.getElementById('receiptDisplay')) { renderReceipt(); }
}

// ‚úÖ KONIEC: Zaktualizowany kod dla Kalkulatora Wizyty (z cenami)
// ‚úÖ DODANO: POCZƒÑTEK: Skrypt importu do Firebase (WERSJA POPRAWIONA dla v8)

/**
 * Funkcja importujƒÖca dane z data.json do Firestore.
 * Wywo≈Çaj jƒÖ JEDEN RAZ rƒôcznie z konsoli przeglƒÖdarki.
 * U≈ºyj: importDataToFirebase();
 */
async function importDataToFirebase() {
  try {
    // 1. Konfiguracja Firebase (dane, kt√≥re poda≈Çe≈õ)
    const firebaseConfig = {
      apiKey: "AIzaSyBFSlW9_i877sdlTfGHV4XKGeYlbKPAoM0",
      authDomain: "kl-mobile-3536f.firebaseapp.com",
      projectId: "kl-mobile-3536f",
      storageBucket: "kl-mobile-3536f.firebasestorage.app",
      messagingSenderId: "420035668375",
      appId: "1:420035668375:web:712c93f1765729b39bbcd2"
    };

    // 2. Inicjalizacja Firebase (SK≈ÅADNIA v8)
    if (!firebase.apps.length) {
       firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore(); // ‚úÖ POPRAWKA: Tak wyglƒÖda sk≈Çadnia v8
    console.log("Firebase zainicjowane, po≈ÇƒÖczono z bazƒÖ danych.");
    alert("Po≈ÇƒÖczono z Firebase. Rozpoczynam import... Sprawd≈∫ postƒôp w konsoli (F12).");

    // 3. Pobierz dane z pliku data.json
    console.log("Pobieranie danych z data.json...");
    const response = await fetch('data.json');
    if (!response.ok) {
       alert("B≈ÅƒÑD: Nie mo≈ºna pobraƒá pliku data.json. Sprawd≈∫, czy plik jest na GitHubie.");
       return;
    }
    const data = await response.json();
    console.log("Dane pobrane:", data);

    // 4. Import klient√≥w (SK≈ÅADNIA v8)
    if (data.klienci && data.klienci.length > 0) {
      console.log(`Rozpoczynam import ${data.klienci.length} klient√≥w...`);
      const klienciRef = db.collection("klienci"); // ‚úÖ POPRAWKA
      
      let batch = db.batch(); // ‚úÖ POPRAWKA
      let counter = 0;

      for (const klient of data.klienci) {
        if (klient.nazwa && klient.nazwa.trim() !== "") {
          const docRef = klienciRef.doc(); // ‚úÖ POPRAWKA (automatyczne ID)
          batch.set(docRef, klient); // ‚úÖ POPRAWKA
          counter++;

          if (counter % 499 === 0) {
            await batch.commit();
            batch = db.batch(); // ‚úÖ POPRAWKA
            console.log(`Wys≈Çano partiƒô ${counter} klient√≥w...`);
          }
        }
      }
      await batch.commit();
      console.log(`‚úÖ Import klient√≥w zako≈Ñczony (${counter} klient√≥w).`);
    } else {
      console.warn("Nie znaleziono klient√≥w w data.json.");
    }

    // 5. Import lek√≥w (SK≈ÅADNIA v8)
    if (data.leki && data.leki.length > 0) {
      console.log(`Rozpoczynam import ${data.leki.length} lek√≥w...`);
      const lekiRef = db.collection("leki"); // ‚úÖ POPRAWKA
      
      let batch = db.batch(); // ‚úÖ POPRAWKA
      let counter = 0;

      for (const lek of data.leki) {
        if (lek.nazwa && lek.nazwa.trim() !== "") {
          lek.cena = parseFloat(lek.cena) || 0; 
          const docRef = lekiRef.doc(); // ‚úÖ POPRAWKA
          batch.set(docRef, lek); // ‚úÖ POPRAWKA
          counter++;

          if (counter % 499 === 0) {
            await batch.commit();
            batch = db.batch(); // ‚úÖ POPRAWKA
            console.log(`Wys≈Çano partiƒô ${counter} lek√≥w...`);
          }
        }
      }
      await batch.commit();
      console.log(`‚úÖ Import lek√≥w zako≈Ñczony (${counter} lek√≥w).`);
    } else {
      console.warn("Nie znaleziono lek√≥w w data.json.");
    }

    alert("Import do Firebase zako≈Ñczony! Sprawd≈∫ konsolƒô Firebase.");
  } catch (error) {
     console.error("KRYTYCZNY B≈ÅƒÑD podczas importu:", error);
     alert("WystƒÖpi≈Ç krytyczny b≈ÇƒÖd podczas importu. Sprawd≈∫ konsolƒô (F12).");
  }
}
// ‚úÖ DODANO: KONIEC: Skrypt importu do Firebase (WERSJA POPRAWIONA dla v8)
// ========================================================
// ‚úÖ POCZƒÑTEK: LOGIKA ZAK≈ÅADKI BAZA KLIENT√ìW (CRUD)
// ========================================================

/**
 * Funkcja do od≈õwie≈ºania list <datalist> w ca≈Çej aplikacji.
 * Kluczowe, aby nowi klienci pojawiali siƒô na listach wyboru.
 */
async function refreshClientDataLists() {
    try {
        const klienciSnapshot = await db.collection("klienci").orderBy("nazwa").get();
        const klienci = klienciSnapshot.docs.map(doc => doc.data());
        
        const klientList = document.getElementById('klientList'); // G≈Ç√≥wna datalist
        if (!klientList) return;
        
        klientList.innerHTML = ''; // Wyczy≈õƒá
        klienci.forEach(k => {
            const opt = document.createElement('option');
            opt.value = k.nazwa;
            opt.dataset.adres = k.adres || '';
            opt.dataset.nrstada = k.nrStada || '';
            klientList.appendChild(opt);
        });
        console.log('Datalisty klient√≥w zosta≈Çy zaktualizowane.');
    } catch (error) {
        console.error('B≈ÇƒÖd od≈õwie≈ºania datalist klient√≥w:', error);
    }
}

 * ≈Åaduje klient√≥w z Firestore i buduje tabelƒô HTML.
 * (Wersja zaktualizowana o licznik, tel, email i ID Lecznicy)
 */
async function loadClientsToTable() {
    if (!klientTableBody) return;
    if (clientSearchInput) clientSearchInput.value = ''; // Resetuj filtr
    
    const clientCountDisplay = document.getElementById('clientCountDisplay');
    
    // Ustaw stan ≈Çadowania
    klientTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 10px;">≈Åadowanie danych...</td></tr>'; // ‚úÖ Colspan 7
    if (clientCountDisplay) clientCountDisplay.textContent = '≈ÅƒÖczna liczba klient√≥w: ...';
    
    try {
        const snapshot = await db.collection("klienci").orderBy("nazwa").get();
        klientTableBody.innerHTML = ''; // Wyczy≈õƒá "≈Åadowanie..."
        
        const count = snapshot.docs.length;
        if (clientCountDisplay) clientCountDisplay.textContent = `≈ÅƒÖczna liczba klient√≥w: ${count}`;
        
        if (snapshot.empty) {
            klientTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 10px;">Brak klient√≥w w bazie danych.</td></tr>'; // ‚úÖ Colspan 7
            return;
        }
        
        snapshot.docs.forEach(doc => {
            const klient = doc.data();
            const tr = document.createElement('tr');
            tr.dataset.id = doc.id;
            
            // ‚úÖ Zaktualizowano o nowe pola
            tr.innerHTML = `
                <td data-label="Nazwa">${klient.nazwa || 'Brak nazwy'}</td>
                <td data-label="Adres">${klient.adres || ''}</td>
                <td data-label="Nr Stada">${klient.nrStada || ''}</td>
                <td data-label="Nr telefonu">${klient.nrTelefonu || ''}</td>
                <td data-label="E-mail">${klient.email || ''}</td>
                <td data-label="ID Lecznicy">${klient.idLecznicy || ''}</td> <td>
                    <button class="btn btn-edit-client" data-id="${doc.id}">Edytuj</button>
                    <button class="btn warn btn-delete-client" data-id="${doc.id}">Usu≈Ñ</button>
                </td>
            `;
            klientTableBody.appendChild(tr);
        });
    } catch (error) {
        console.error("B≈ÇƒÖd ≈Çadowania klient√≥w: ", error);
        klientTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 10px; color: red;">WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania danych.</td></tr>'; // ‚úÖ Colspan 7
        
        if (clientCountDisplay) clientCountDisplay.textContent = '≈ÅƒÖczna liczba klient√≥w: B≈ÇƒÖd';
    }
}

/**
 * Obs≈Çuga klikniƒôƒá w tabeli (Edycja i Usuwanie) - Delegacja zdarze≈Ñ
 */
if (klientTableBody) {
    klientTableBody.addEventListener('click', async (e) => {
        const target = e.target;
        
       // --- EDYCJA KLIENTA ---
        if (target.classList.contains('btn-edit-client')) {
            const docId = target.dataset.id;
            try {
                const doc = await db.collection("klienci").doc(docId).get();
                if (!doc.exists) {
                    alert('B≈ÇƒÖd: Nie znaleziono klienta.');
                    return;
                }
                const data = doc.data();
                
                // Wype≈Çnij i poka≈º modal
                clientFormTitle.textContent = 'Edytuj klienta';
                clientFormDocId.value = docId; 
                clientFormNazwa.value = data.nazwa || '';
                clientFormAdres.value = data.adres || '';
                clientFormNrStada.value = data.nrStada || '';
                clientFormNrTelefonu.value = data.nrTelefonu || ''; // NOWE
                clientFormEmail.value = data.email || ''; // NOWE
                clientFormIdLecznicy.value = data.idLecznicy || ''; // NOWE
                clientFormModal.style.display = 'flex';
                
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania klienta do edycji: ', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas pobierania danych klienta.');
            }
        }
        
        // --- USUWANIE KLIENTA ---
        if (target.classList.contains('btn-delete-client')) {
            const docId = target.dataset.id;
            const row = target.closest('tr');
            const klientName = row.cells[0].textContent;
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá klienta: "${klientName}"? \n\nTej operacji nie mo≈ºna cofnƒÖƒá.`)) {
                try {
                    await db.collection("klienci").doc(docId).delete();
                    alert('Klient usuniƒôty pomy≈õlnie.');
                    loadClientsToTable(); // Od≈õwie≈º tabelƒô
                    refreshClientDataLists(); // Od≈õwie≈º listy wyboru w apce
                } catch (error) {
                    console.error('B≈ÇƒÖd usuwania klienta: ', error);
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania klienta.');
                }
            }
        }
    });
}

/**
 * Przycisk "Dodaj nowego klienta" - otwiera pusty modal
 */
if (addNewClientBtn) {
    addNewClientBtn.addEventListener('click', () => {
        clientFormTitle.textContent = 'Dodaj nowego klienta';
        clientFormDocId.value = ''; // Wyczy≈õƒá ID - to oznacza "dodawanie"
        clientFormNazwa.value = '';
        clientFormAdres.value = '';
        clientFormNrStada.value = '';
        clientFormNrTelefonu.value = ''; // NOWE
        clientFormEmail.value = ''; // NOWE
        clientFormIdLecznicy.value = ''; // NOWE
        clientFormModal.style.display = 'flex';
        clientFormNazwa.focus();
    });
}

/**
 * Przycisk "Anuluj" w modalu klienta
 */
if (cancelClientForm) {
    cancelClientForm.addEventListener('click', () => {
        clientFormModal.style.display = 'none';
    });
}

/**
 * Przycisk "Zapisz" w modalu klienta (obs≈Çuguje Dodawanie i Aktualizacjƒô)
 */
if (saveClientBtn) {
    saveClientBtn.addEventListener('click', async () => {
        const nazwa = clientFormNazwa.value.trim();
        const adres = clientFormAdres.value.trim();
        const nrStada = clientFormNrStada.value.trim();
        const nrTelefonu = clientFormNrTelefonu.value.trim(); // NOWE
        const email = clientFormEmail.value.trim(); // NOWE
        const idLecznicy = clientFormIdLecznicy.value.trim(); // NOWE
        const docId = clientFormDocId.value; 

        if (!nazwa) {
            alert('Nazwa klienta jest wymagana.');
            clientFormNazwa.focus();
            return;
        }

        const klientData = {
            nazwa: nazwa,
            adres: adres,
            nrStada: nrStada,
            nrTelefonu: nrTelefonu, // NOWE
            email: email, // NOWE
            idLecznicy: idLecznicy // NOWE
        };

        try {
            saveClientBtn.disabled = true;
            saveClientBtn.textContent = 'Zapisywanie...';
            
            if (docId) {
                // --- Tryb Aktualizacji (UPDATE) ---
                await db.collection("klienci").doc(docId).update(klientData);
                alert('Dane klienta zosta≈Çy zaktualizowane.');
            } else {
                // --- Tryb Dodawania (CREATE) ---
                await db.collection("klienci").add(klientData);
                alert('Nowy klient zosta≈Ç dodany.');
            }
            
            clientFormModal.style.display = 'none'; // Zamknij modal
            loadClientsToTable(); // Od≈õwie≈º tabelƒô klient√≥w
            refreshClientDataLists(); // BARDZO WA≈ªNE: od≈õwie≈º listy wyboru w ca≈Çej aplikacji

        } catch (error) {
            console.error('B≈ÇƒÖd zapisu klienta: ', error);
            alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu danych.');
        } finally {
            saveClientBtn.disabled = false;
            saveClientBtn.textContent = 'Zapisz';
        }
    });
}
// ‚úÖ KONIEC: LOGIKA ZAK≈ÅADKI BAZA KLIENT√ìW
    // ========================================================
// ========================================================
// ‚úÖ POCZƒÑTEK: LOGIKA IMPORTU (WKLEJANIA) DANYCH Z ARKUSZA
// ========================================================

// Otwieranie modala importu
if (importFromSheetBtn) {
    importFromSheetBtn.addEventListener('click', () => {
        pasteTextarea.value = ''; // Wyczy≈õƒá pole tekstowe
        pasteDataModal.style.display = 'flex';
        pasteTextarea.focus();
    });
}

// Anulowanie modala importu
if (cancelPasteData) {
    cancelPasteData.addEventListener('click', () => {
        pasteDataModal.style.display = 'none';
    });
}

// Zapisywanie (przetwarzanie) wklejonych danych
if (savePasteDataBtn) {
    savePasteDataBtn.addEventListener('click', async () => {
        const textData = pasteTextarea.value.trim();
        if (!textData) {
            alert('Pole tekstowe jest puste.');
            return;
        }

        // Dzielimy tekst na wiersze
        const rows = textData.split('\n');
        if (rows.length === 0) {
            alert('Brak danych do przetworzenia.');
            return;
        }

        if (!confirm(`Znaleziono ${rows.length} wierszy do przetworzenia. \n\nKontynuowaƒá?`)) {
            return;
        }

        savePasteDataBtn.disabled = true;
        savePasteDataBtn.textContent = 'Przetwarzanie...';

        let batch = db.batch();
        let updatedCount = 0;
        let errorCount = 0;
        const promises = []; // Tablica na operacje odczytu (find)

        // Krok 1: Przygotuj dane do aktualizacji dla ka≈ºdego wiersza
        for (const row of rows) {
            if (row.trim() === '') continue; // Pomi≈Ñ puste wiersze

            // Dane z Excela/Sheets sƒÖ oddzielone TABULATOREM
            const cells = row.split('\t'); 

            // ‚úÖ ZMIENIONO WARUNEK (teraz 6 kolumn)
            if (cells.length < 6) {
                console.warn('Pominiƒôto wiersz (za ma≈Ço kolumn):', row);
                errorCount++;
                continue;
            }

            // Zgodnie z instrukcjƒÖ w modalu:
            const nazwa = cells[0].trim();
            const adres = cells[1].trim();
            const nrStada = cells[2].trim();
            const nrTelefonu = cells[3].trim();
            const email = cells[4].trim();
            const idLecznicy = cells[5].trim(); // ‚úÖ NOWE

            if (!nazwa) {
                console.warn('Pominiƒôto wiersz (brak nazwy):', row);
                errorCount++;
                continue;
            }

            // Stw√≥rz dane do aktualizacji (bez nazwy, bo po niej szukamy)
            const dataToUpdate = {
                adres: adres,
                nrStada: nrStada,
                nrTelefonu: nrTelefonu,
                email: email,
                idLecznicy: idLecznicy // ‚úÖ NOWE
            };

            // Przygotuj zapytanie do znalezienia dokumentu po nazwie
            const query = db.collection('klienci').where('nazwa', '==', nazwa).limit(1).get();
            promises.push({ query, dataToUpdate, nazwa }); // dodajemy nazwa do logowania b≈Çƒôd√≥w
        }

        // Krok 2: Wykonaj wszystkie zapytania i przygotuj batch
        try {
            const results = await Promise.all(promises.map(p => p.query));

            results.forEach((snapshot, index) => {
                const dataToUpdate = promises[index].dataToUpdate;
                const nazwa = promises[index].nazwa;

                if (!snapshot.empty) {
                    // Znaleziono klienta, dodaj aktualizacjƒô do batcha
                    const docId = snapshot.docs[0].id;
                    const docRef = db.collection('klienci').doc(docId);
                    batch.update(docRef, dataToUpdate);
                    updatedCount++;
                } else {
                    // Nie znaleziono klienta o tej nazwie
                    console.warn(`Nie znaleziono klienta o nazwie: "${nazwa}"`);
                    errorCount++;
                }
            });

            // Krok 3: Wykonaj wszystkie aktualizacje za jednym razem
            if (updatedCount > 0) {
                await batch.commit();
            }

            alert(`Import zako≈Ñczony! \n\nZaktualizowano: ${updatedCount} klient√≥w. \nPominiƒôto (b≈Çƒôdy lub brak nazwy): ${errorCount}.`);

            pasteDataModal.style.display = 'none';
            loadClientsToTable(); // Od≈õwie≈º tabelƒô
            refreshClientDataLists(); // Od≈õwie≈º datalisty

        } catch (error) {
            console.error('Krytyczny b≈ÇƒÖd podczas importu batch:', error);
            alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu danych: ' + error.message);
        } finally {
  savePasteDataBtn.disabled = false;
            savePasteDataBtn.textContent = 'Importuj i Zaktualizuj';
        }
    }); // ‚úÖ DODAJ Tƒò KLAMRƒò Z ≈öREDNIKIEM (ko≈Ñczy addEventListener)
} // Koniec bloku "if (savePasteDataBtn)"
// ========================================================
// ‚úÖ KONIEC: LOGIKA IMPORTU (WKLEJANIA) DANYCH Z ARKUSZA
// ========================================================


    /**
     * Filtruje tabelƒô klient√≥w...
     */
    function filterClientTable() {
       // ... (kod funkcji filterClientTable) ...
    }


```
</script>
</body>
</html>
