<!DOCTYPE html>
<html lang="pl">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

Â  <title>KARTA LECZENIA ZWIERZÄ„T</title>
Â  Â  <meta name="theme-color" content="#2b74e4">
Â  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0275d8">
Â  <link rel="icon" href="https://www.gstatic.com/images/icons/material/system/2x/pets_black_24dp.png" type="image/png">
Â  <meta name="mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="default">

Â  <style>
Â  /* --- Sekcja Drukuj + e-mail (styling) --- */
Â  .drukuj-sekcja {
Â  Â  margin-top: 20px;
Â  Â  padding: 10px 0 0 0;
Â  Â  border-top: 1px solid #e0e0e0;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: flex-start;
Â  Â  gap: 10px;
Â  }

Â  .drukuj-sekcja #drukujBtn {
Â  Â  background: #e6e6e6;
Â  Â  border: 1px solid #aaa;
Â  Â  padding: 6px 12px;
Â  Â  border-radius: 6px;
Â  Â  cursor: pointer;
Â  Â  font-size: 15px;
Â  }

Â  .drukuj-sekcja #drukujBtn:hover {
Â  Â  background: #dcdcdc;
Â  }

Â  /* ğŸ“§ Pole e-mail */
Â  .email-box {
Â  Â  width: 100%;
Â  Â  font-size: 14px;
Â  }

Â  .email-input-wrapper {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 6px;
Â  Â  margin-top: 6px;
Â  }

Â  .email-input-wrapper input[type="email"] {
Â  Â  width: 33%;
Â  Â  min-width: 180px;
Â  Â  padding: 6px 8px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  Â  box-sizing: border-box;
Â  }

Â  .email-input-wrapper button {
Â  Â  background: #f5f5f5;
Â  Â  border: 1px solid #bbb;
Â  Â  border-radius: 5px;
Â  Â  cursor: pointer;
Â  Â  font-size: 16px;
Â  Â  padding: 5px 8px;
Â  }

Â  /* Ukryj pole e-mail przy drukowaniu */
Â  @media print {
Â  Â  .email-box, .drukuj-sekcja button#saveEmail { display: none !important; }
Â  }

Â  body { font-family: Arial, sans-serif; margin: 20px; transform: scale(0.95); transform-origin: top left; }
Â  h2 { text-align: center; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; }
Â  .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 12px; margin-bottom: 10px; }
Â  .top-section div { padding: 5px; }
Â  .table-container { width: 100%; overflow-x: auto; }
Â  table { border-collapse: collapse; width: 100%; font-size: 11px; }
Â  th, td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
Â  th { background: #e8eefc; text-align: center; }
Â  td[contenteditable="true"] { background: #fefefe; }
Â  .actions { text-align: right; margin-top: 10px; }
Â  @media print { #printBtn, #copyBtn, #clearSignBtn, #fullscreenBtn, #formBtn { display: none; } }
Â  input[type="date"] { font-size: 11px; }
Â  .small-input { width: 40px; display: inline-block; margin-right: 3px; }
Â  .center-text { text-align: center; }

Â  /* podpisy */
Â  .signatures { display: flex; justify-content: space-between; margin-top: 20px; }
Â  .signature-box { display: flex; flex-direction: column; align-items: center; width: 48%; }
Â  .signature-label { font-weight: bold; margin-bottom: 2px; display: block; text-align: center; width: 100%; }
Â  .signature-canvas { border: 1px solid #000; display: block; height: 80px; width: 100%; margin-top: 5px; touch-action: none; }
Â  .signature-img { display: block; height: 80px; width: 100%; object-fit: contain; margin-top: 5px; }
Â  .signature-name { margin-top: 2px; font-weight: normal; text-align: center; }
Â  .fullscreen-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:none; z-index:9999; justify-content:center; align-items:center; flex-direction: column; }
Â  .fullscreen-canvas { border:1px solid #000; touch-action:none; }
Â  #closeSignBtn { margin-top:10px; }
Â  #clearFullscreenSignBtn { margin-top:5px; }

Â  /* ---- formularz (dodany, nie wpÅ‚ywa na tabelÄ™) ---- */
Â  #formModal {
Â  Â  position: fixed;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100vw;
Â  Â  height: 100vh;
Â  Â  background: rgba(0,0,0,0.48);
Â  Â  display: none;
Â  Â  z-index: 10000;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  overflow: hidden;
Â  }

Â  .form-card {
Â  Â  width: 140vw;
Â  Â  max-width: 600px;
Â  Â  height: 120vh;
Â  Â  overflow-y: auto;
Â  Â  background: #fff;
Â  Â  border-radius: 12px;
Â  Â  padding: 24px;
Â  Â  box-sizing: border-box;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: flex-start;
Â  Â  font-size: clamp(18px, 5vw, 22px);
Â  }

Â  @media (max-width: 480px) {
Â  Â  .form-card {
Â  Â  Â  width: 98vw;
Â  Â  Â  height: 95vh;
Â  Â  Â  padding: 12px;
Â  Â  }
Â  Â  input, select, textarea, button {
Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  }

Â  .form-step { display:none; }
Â  .form-step.active { display:block; }
Â  .form-row { margin-bottom:8px; }
Â  .form-row label { display:block; font-weight:600; font-size:13px; margin-bottom:4px; }
Â  .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="number"], .form-row textarea, .form-row input[list] {
Â  Â  width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px;
Â  Â  box-sizing:border-box;
Â  }
Â  .form-row textarea { min-height:70px; resize:vertical; }
Â  .form-actions { display:flex; gap:8px; justify-content:space-between; margin-top:12px; flex-wrap:wrap; }
Â  .form-actions .left, .form-actions .right { display:flex; gap:8px; }
Â  .btn { padding:8px 11px; border-radius:8px; border:1px solid #bbb; background:#f7f7f7; cursor:pointer; font-size:14px; }
Â  .btn.primary { background:#2b74e4; color:#fff; border-color:#2260c5; }
Â  .btn.warn { background:#c0392b; color:#fff; border-color:#992d22; }
Â  .btn.ghost { background:transparent; border-color:#ccc; }
Â  .small { padding:6px 8px; font-size:13px; }

Â  #micBtn { padding:6px 8px; border-radius:8px; cursor:pointer; border:1px solid #ccc; background:#eef; }

Â  .highlight-row { animation: highlightAnim 2s ease; }
Â  @keyframes highlightAnim {
Â  Â  0% { background: #ffff99; }
Â  Â  100% { background: transparent; }
Â  }

Â  @media (orientation: portrait) {
Â  Â  .form-card {
Â  Â  Â  width: 98vw;
Â  Â  Â  max-width: 720px;
Â  Â  }
Â  }

Â  @media (orientation: landscape) {
Â  Â  .form-card {
Â  Â  Â  width: 90vw;
Â  Â  Â  max-width: 720px;
Â  Â  Â  max-height: 95vh;
Â  Â  }
Â  }
Â  Â  /* --- Styl dla przycisku edycji wiersza --- */
.btn-edit-row {
Â  background: #f0f0f0;
Â  border: 1px solid #ccc;
Â  border-radius: 4px;
Â  padding: 0px 5px;
Â  margin-left: 4px;
Â  cursor: pointer;
Â  font-size: 12px;
Â  line-height: 1.2;
Â  vertical-align: middle;
}
.btn-edit-row:hover {
Â  background: #e0e0e0;
}
/* Ukryj przycisk podczas drukowania */
@media print {
Â  .btn-edit-row { display: none !important; }
}
Â  Â  /* --- Styl dla checkboxa 'jw.' (jak wyÅ¼ej) --- */
.jw-checkbox-container {
Â  margin-top: 5px;
Â  font-size: 11px;
Â  color: #333;
}
.jw-checkbox-container input {
Â  vertical-align: middle;
Â  margin-right: 4px;
}
.jw-checkbox-container label {
Â  vertical-align: middle;
Â  cursor: pointer;
}
/* Kontener na tekst w edytowalnej komÃ³rce (kol. 2) */
.editable-text {
Â  min-height: 1.2em; /* Zapewnia miejsce do klikniÄ™cia */
}
/* Ukryj checkbox 'jw.' podczas drukowania */
@media print {
Â  .jw-checkbox-container { display: none !important; }
}
Â  </style>
</head>

<body>
<h2>KARTA LECZENIA ZWIERZÄ„T GOSPODARSKICH ORAZ ZWIERZÄ„T, Z KTÃ“RYCH POZYSKANE TKANKI LUB PRODUKTY SÄ„ PRZEZNACZONE DO SPOÅ»YCIA PRZEZ LUDZI / EWIDENCJA LECZENIA ZWIERZÄ„T</h2>

<div class="top-section">
Â  <div>
Â  Â  <b>Nazwa i adres zakÅ‚adu leczniczego dla zwierzÄ…t:</b><br>
Â  Â  <span id="nazwaLecznicy"></span><br>
Â  Â  <b>Wykonanie czynnoÅ›ci lekarsko-weterynaryjnych dnia:</b>
Â  Â  <input type="date" id="dataWykonania"><br>
Â  Â  <b>Nr stada:</b> <span id="nrStada"></span>
Â  </div>
Â  <div>
Â  Â  <b>ImiÄ™, nazwisko i adres albo nazwa siedziby i adres posiadacza zwierzÄ™cia:</b><br>
Â  Â  <input list="klientList" id="klientSelect" placeholder="Wpisz lub wybierz klienta"><br>
Â  Â  <span id="adresKlienta"></span>
Â  Â  <datalist id="klientList"></datalist>
Â  </div>
Â  <div>
Â  Â  <b>ZgÅ‚oszenie:</b> Data: <input type="date" id="dataZgloszenia"><br>
Â  Â  <b>Nr dokumentu:</b> <input type="text" id="nrDokumentu" placeholder="________">
Â  </div>
</div>

<div class="table-container">
Â  <table id="karta">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th rowspan="2" style="width:30px;">Lp.</th>
Â  Â  Â  <th rowspan="2" class="center-text">
Â  Â  Â  Â  Nazwa siedziby stada i opis leczonego zwierzÄ™cia<br>
Â  Â  Â  Â  (gatunek, pÅ‚eÄ‡ numer identyfikacyjny, sposÃ³b oznakowania, wiek, masa ciaÅ‚a)
Â  Â  Â  </th>
Â  Â  Â  <th rowspan="2" class="center-text">Liczba leczonych zwierzÄ…t</th>
Â  Â  Â  <th rowspan="2" class="center-text">Rozpoznanie albo wstÄ™pne rozpoznanie choroby</th>
Â  Â  Â  <th colspan="3">
Â  Â  Â  Â  Zastosowane u poszczegÃ³lnych zwierzÄ…t produkty lecznicze lub nabyte przez posiadacza zwierzÄ™cia produkty lecznicze weterynaryjne lub pasze lecznicze
Â  Â  Â  </th>
Â  Â  Â  <th rowspan="2">okres karencji / Zabieg leczniczy lub profilaktyczne zalecenia lekarskie oraz uwagi</th>
Â  Â  </tr>
Â  Â  <tr>
Â  Â  Â  <th>Nazwa produktu leczniczego/ produktu leczniczego weterynaryjnego/ paszy leczniczej</th>
Â  Â  Â  <th>Numer serii produktu leczniczego lub produktu leczniczego weterynaryjnego</th>
Â  Â  Â  <th>IloÅ›Ä‡, dawkowanie zastosowanego produktu leczniczego lub iloÅ›Ä‡, dawkowanie i okres stosowanie nabytego produktu leczniczego, weterynaryjnego/paszy leczniczej</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody></tbody>
Â  </table>
</div>

<p><b>OÅ›wiadczam, Å¼e nabyte produkty lecznicze weterynaryjne/pasze lecznicze zostanÄ… zastosowane zgodnie z zaleceniami lekarza weterynarii.</b></p>

<div class="signatures">
Â  <div class="signature-box">
Â  Â  <span class="signature-label">Lekarz weterynarii</span>
Â  Â  <img id="doctor-signature" class="signature-img" alt="Podpis lekarza">
Â  Â  <span class="signature-name">lek. wet. Magdalena Chojnowska</span>
Â  </div>
Â  <div class="signature-box">
Â  Â  <span class="signature-label">Podpis posiadacza zwierzÄ™cia</span>
Â  Â  <canvas id="canvasPosiadacz" class="signature-canvas"></canvas>
Â  Â  <button id="fullscreenBtn">PowiÄ™ksz podpis</button>
Â  Â  <button id="clearSignBtn">WyczyÅ›Ä‡ podpis</button>
Â  </div>
</div>

<p><b>Wyniki badaÅ„ uzupeÅ‚niajÄ…cych:</b><br>*W przypadku zwierzÄ…t znajdujÄ…cych siÄ™ w rejestrze zwierzÄ…t gospodarskich oznakowanych</p>

<div class="actions">
Â  <button id="copyBtn" class="btn">Przepisz dane z leczenia na miejscu</button>
Â  <button id="formBtn" class="btn">ğŸ“‹ WprowadÅº poprzez formularz</button>
Â  <button id="printBtn" class="btn" onclick="window.print()">Drukuj / Zapisz PDF</button>
Â  <div class="email-box">
Â  <label for="userEmail">ğŸ“§ Podaj swÃ³j adres e-mail:</label>
Â  <div class="email-input-wrapper">
Â  Â  <input type="email" id="userEmail" placeholder="np. jan.kowalski@email.com">
Â  Â  <button type="button" id="saveEmail" title="Zapisz adres e-mail">ğŸ’¾</button>
Â  </div>
</div>

</div>

<div class="fullscreen-overlay" id="fullscreenOverlay">
Â  <canvas id="fullscreenCanvas" class="fullscreen-canvas"></canvas>
Â  <button id="closeSignBtn">Zamknij podpis</button>
Â  <button id="clearFullscreenSignBtn">WyczyÅ›Ä‡ podpis</button>
</div>

<div id="formModal" aria-hidden="true">
Â  <div class="form-card" role="dialog" aria-modal="true">
Â  Â  Â  Â  <div id="step1" class="form-step active">
Â  Â  Â  <h3>Dane posiadacza / nagÅ‚Ã³wek</h3>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formKlient">ImiÄ™, nazwisko lub nazwa siedziby</label>
Â  Â  Â  Â  <input list="klientList" id="formKlient" placeholder="Wpisz lub wybierz klienta">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formAdres">Adres</label>
Â  Â  Â  Â  <input type="text" id="formAdres" placeholder="Adres">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formNrStada">Nr stada</label>
Â  Â  Â  Â  <input type="text" id="formNrStada" placeholder="Nr stada">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formDataZgloszenia">Data zgÅ‚oszenia</label>
Â  Â  Â  Â  <input type="date" id="formDataZgloszenia">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formDataWykonania">Data wykonania</label>
Â  Â  Â  Â  <input type="date" id="formDataWykonania">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formNrDokumentu">Nr dokumentu</label>
Â  Â  Â  Â  <input type="text" id="formNrDokumentu" placeholder="Numer dokumentu">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-actions">
Â  Â  Â  Â  <div class="left">
Â  Â  Â  Â  Â  <button id="closeForm" class="btn ghost small">ZakoÅ„cz</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  <button id="nextToProducts" class="btn primary small">Dalej âœ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="step2" class="form-step">
Â  Â  Â  <h3>Edycja wierszy tabeli</h3>

Â  Â  Â  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
Â  Â  Â  Â  <label style="margin:0; font-weight:600;">Wybierz wiersz</label>
Â  Â  Â  Â  <select id="formRowSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"></select>
Â  Â  Â  Â  <div style="display:flex; gap:6px;">
Â  Â  Â  Â  Â  <button id="prevRow" class="btn small">â—€</button>
Â  Â  Â  Â  Â  <button id="nextRow" class="btn small">â–¶</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formOpis">Nazwa siedziby stada i opis zwierzÄ™cia</label>
Â  Â  Â  Â  <textarea id="formOpis" placeholder="Opis zwierzÄ™cia"></textarea>
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formLiczba">Liczba leczonych zwierzÄ…t</label>
Â  Â  Â  Â  <input type="number" id="formLiczba" min="0" placeholder="0">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formRozpoznanie">Rozpoznanie / wstÄ™pne rozpoznanie</label>
Â  Â  Â  Â  <input type="text" id="formRozpoznanie" placeholder="Rozpoznanie">
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formLek">Nazwa produktu leczniczego (lista)</label>
Â  Â  Â  Â  <input list="listaLekow" id="formLek" placeholder="Wybierz lek">
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
Â  Â  Â  Â  <button id="micBtn" class="" title="Dyktuj nazwÄ™ produktu">ğŸ¤</button>
Â  Â  Â  Â  <small style="color:#666">NaciÅ›nij mikrofon aby dyktowaÄ‡</small>
Â  Â  Â  </div>

Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <label for="formSeria">Numer serii produktu</label>
Â  Â  Â  Â  <input type="text" id="formSeria" placeholder="Numer serii">
Â  Â  Â  </div>
Â  Â  Â  <form id="myForm">

Â  <div class="form-row">
Â  Â  <label>IloÅ›Ä‡ </label>
Â  Â  <input type="number" inputmode="numeric" pattern="[0-9]*" id="formIlosc" placeholder="0" style="width:60px;">
Â  </div>

Â  <div class="form-row">
Â  Â  <label>Dawkowanie / jednostka</label>
Â  Â  <input type="text" id="formDawkowanie" placeholder="np. 2 ml/kg">
Â  </div>
</form>

Â  Â  Â  <div class="mic-container">
Â  <input type="text" id="formKarencja" placeholder="Okres karencji / uwagi">
Â  <button type="button" id="micKarencja" class="mic-btn" title="Dyktuj">ğŸ¤</button>
</div>


Â  Â  Â  <div class="form-actions" style="margin-top:12px;">
Â  Â  Â  Â  <div class="left">
Â  Â  Â  Â  Â  <button id="backToHeader" class="btn ghost small">â¬… Cofnij</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  <button id="saveRow" class="btn primary small">Zapisz wiersz</button>
Â  Â  Â  Â  Â  <button id="formCopyBtn" class="btn small">Przepisz dane z leczenia na miejscu</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>
</div>

<datalist id="listaLekow"></datalist>

<script>
/* ----- dane map i nazwy lekÃ³w (bÄ™dÄ… uzupeÅ‚nione z serwera) ----- */
let mapaSerii = {}, mapaIlosci = {}, mapaKarencji = {}, nazwyLekow = [];

// ğŸŒ Tryb GitHub Pages â€“ pobieramy dane z lokalnego pliku data.json
fetch('data.json')
Â  .then(response => {
Â  Â  if (!response.ok) throw new Error('BÅ‚Ä…d sieci: ' + response.status);
Â  Â  return response.json();
Â  })
Â  .then(data => {
Â  Â  console.log('âœ… Dane pobrane z data.json:', data);
Â  Â  initData(data); // wywoÅ‚uje TwojÄ… funkcjÄ™ z danymi
Â  })
Â  .catch(error => {
Â  Â  console.error('âŒ BÅ‚Ä…d pobierania pliku data.json:', error);
Â  Â  alert('Nie udaÅ‚o siÄ™ pobraÄ‡ danych. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.');
Â  });

function initData(data) {
Â  // nagÅ‚Ã³wek
Â  document.getElementById('nazwaLecznicy').textContent = data.nazwaLecznicy || '';
Â  // klienci -> datalist
Â  const klientList = document.getElementById('klientList');
Â  klientList.innerHTML = '';
Â  (data.klienci||[]).forEach(k=>{
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = k.nazwa;
Â  Â  opt.dataset.adres = k.adres || '';
Â  Â  opt.dataset.nrstada = k.nrStada || '';
Â  Â  klientList.appendChild(opt);
Â  Â  // also add to the top klientSelect if present (same datalist used)
Â  });

Â  // leki -> mapy i lista
Â  nazwyLekow = [];
Â  (data.leki||[]).forEach(l=>{
Â  Â  mapaSerii[l.nazwa] = l.nrSerii || '';
Â  Â  mapaIlosci[l.nazwa] = l.dawkowanie || '';
Â  Â  mapaKarencji[l.nazwa] = l.karencja || '';
Â  Â  nazwyLekow.push(l.nazwa);
Â  });
Â  rebuildListaLekow();

Â  // default daty -> today
Â  const today = new Date().toISOString().split('T')[0];
Â  if (!document.getElementById('dataZgloszenia').value) document.getElementById('dataZgloszenia').value = today;
Â  if (!document.getElementById('dataWykonania').value) document.getElementById('dataWykonania').value = today;
Â  document.getElementById('formDataZgloszenia').value = today;
Â  document.getElementById('formDataWykonania').value = today;

Â  // podpis lekarza
Â  if (data.doctorSignature) document.getElementById('doctor-signature').src = data.doctorSignature;

Â  // generuj wiersze tabeli
Â  generateRows();

Â  // podÅ‚Ä…cz zachowanie autouzupeÅ‚niania klienta w nagÅ‚Ã³wku i w formularzu
Â  setupClientAutoFill();
}

/* ---- generowanie wierszy (dokÅ‚adnie tak jak wczeÅ›niej) ---- */
function generateRows(){
Â  const tbody = document.querySelector('#karta tbody');
Â  tbody.innerHTML = '';
Â  for (let i=1;i<=13;i++){
Â  Â  const row = document.createElement('tr');
Â  Â  if (i===10) {
Â  Â  Â  const cell = document.createElement('td');
Â  Â  Â  cell.colSpan = 8;
Â  Â  Â  cell.textContent = 'Potwierdzenie nabycia produktu leczniczego weterynaryjnego/paszy leczniczej';
Â  Â  Â  cell.style.fontWeight='bold';
Â  Â  Â  cell.style.textAlign='left';
Â  Â  Â  row.appendChild(cell);
Â  Â  Â  tbody.appendChild(row);
Â  Â  Â  continue;
Â  Â  }
Â  Â  for (let j=1;j<=8;j++){
Â  Â  Â  const cell = document.createElement('td');
Â  Â  Â Â 
Â  Â  Â  // Twoja stara logika dla j=1 (zostaje bez zmian)
Â  Â  Â  if (j===1) {
Â  Â  Â  Â  // Obliczamy "logiczny" indeks wiersza (0-11),
      // ktÃ³ry jest uÅ¼ywany przez funkcje formularza
      const logicalIndex = (i > 10) ? i - 2 : i - 1;
      
      // Bierzemy tekst, ktÃ³ry miaÅ‚eÅ› tam wczeÅ›niej (np. "1.", "2." itd.)
      const rowNumText = (i > 10 ? i - 10 : i) + '.';
      
      // WyczyÅ›Ä‡ komÃ³rkÄ™ i dodaj numer
      cell.textContent = rowNumText + ' '; 
      
      // StwÃ³rz i dodaj przycisk "edytuj"
      const btn = document.createElement('button');
      btn.textContent = 'â¡ï¸'; // MoÅ¼esz zmieniÄ‡ na 'âœï¸' lub inny symbol
      btn.className = 'btn-edit-row';
      btn.title = 'Edytuj ten wiersz w formularzu';
      
      btn.addEventListener('click', (e) => {
        // Zatrzymujemy propagacjÄ™, aby klikniÄ™cie przycisku
        // nie aktywowaÅ‚o edycji komÃ³rki (contenteditable)
        e.stopPropagation(); 
        
        // WywoÅ‚ujemy naszÄ… nowÄ… funkcjÄ™ z indeksem tego wiersza
        openFormAtRow(logicalIndex);
      });
      
      cell.appendChild(btn);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // DomyÅ›lne ustawienie contentEditable (zostaje)
Â  Â  Â  if (i!==10) cell.contentEditable = true;
Â  Â  Â Â 
Â  Â  Â  // Centrowanie tekstu (zostaje)
Â  Â  Â  if (j>=2 && j<=4) cell.classList.add('center-text');

Â  Â  Â  // --- â¬‡ï¸ NOWA SEKCJA â¬‡ï¸ ---
Â  Â  Â  // Specjalna obsÅ‚uga dla kolumny 2 (Opis zwierzÄ™cia, j=2)
Â  Â  Â  if (j === 2 && i !== 10) {Â 
Â  Â  Â  Â  cell.contentEditable = false; // WyÅ‚Ä…czamy edycjÄ™ na caÅ‚ej komÃ³rce

Â  Â  Â  Â  // Tworzymy wewnÄ™trzny div, ktÃ³ry bÄ™dzie edytowalny
Â  Â  Â  Â  const textDiv = document.createElement('div');
Â  Â  Â  Â  textDiv.contentEditable = true;
Â  Â  Â  Â  textDiv.className = 'editable-text'; // Dodajemy klasÄ™
Â  Â  Â  Â  cell.appendChild(textDiv);

Â  Â  Â  Â  // Dodaj checkbox 'jw.', ale nie w pierwszym wierszu (i!=1)
Â  Â  Â  Â  if (i !== 1) {
Â  Â  Â  Â  Â  const container = document.createElement('div');
Â  Â  Â  Â  Â  container.className = 'jw-checkbox-container';
Â  Â  Â  Â  Â  container.contentEditable = false; // Ten div nie jest edytowalny

Â  Â  Â  Â  Â  const checkbox = document.createElement('input');
Â  Â  Â  Â  Â  checkbox.type = 'checkbox';
Â  Â  Â  Â  Â  const checkboxId = `jw-check-${i}`;
Â  Â  Â  Â  Â  checkbox.id = checkboxId;

Â  Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  Â  label.htmlFor = checkboxId;
Â  Â  Â  Â  Â  label.textContent = 'jw.'; // Opis "jak wyÅ¼ej"

Â  Â  Â  Â  Â  // Dodajemy logikÄ™ kopiowania
Â  Â  Â  Â  Â  checkbox.addEventListener('change', function(e) {
Â  Â  Â  Â  Â  Â  e.stopPropagation(); // Zatrzymujemy edycjÄ™ komÃ³rki
Â  Â  Â  Â  Â  Â  if (this.checked) {
Â  Â  Â  Â  Â  Â  Â  // Przekazujemy caÅ‚y element <tr> do nowej funkcji
Â  Â  Â  Â  Â  Â  Â  copyDataFromAbove(row);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  container.appendChild(checkbox);
Â  Â  Â  Â  Â  container.appendChild(label);
Â  Â  Â  Â  Â  cell.appendChild(container); // Dodajemy do komÃ³rki
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // --- â¬†ï¸ KONIEC NOWEJ SEKCJI â¬†ï¸ ---

Â  Â  Â  // Twoja stara logika dla j=3 (zostaje bez zmian)
Â  Â  Â  if (j===3 && i!==10){
Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  input.type = 'number';
Â  Â  Â  Â  input.min = '0';
Â  Â  Â  Â  input.style.width = '50px';
Â  Â  Â  Â  cell.textContent = '';
Â  Â  Â  Â  cell.appendChild(input);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Twoja stara logika dla j=5 (zostaje bez zmian)
Â  Â  Â  if (j===5 && i!==10){
Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  input.setAttribute('list','listaLekow');
Â  Â  Â  Â  input.style.width = '95%';
Â  Â  Â  Â  input.addEventListener('input', function(){
Â  Â  Â  Â  Â  const nrCell = row.cells[5];
Â  Â  Â  Â  Â  const iloscCell = row.cells[6];
Â  Â  Â  Â  Â  const karCell = row.cells[7];
Â  Â  Â  Â  Â  const nazwa = this.value;
Â  Â  Â  Â  Â  const nr = mapaSerii[nazwa] || '';
Â  Â  Â  Â  Â  const dawka = mapaIlosci[nazwa] || '';
Â  Â  Â  Â  Â  const kar = mapaKarencji[nazwa] || '';
Â  Â  Â  Â  Â  nrCell.textContent = nr;
Â  Â  Â  Â  Â  iloscCell.innerHTML = `<input class="small-input" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="iloÅ›Ä‡"> ${dawka||''}`;
Â  Â  Â  Â  Â  karCell.textContent = kar;
Â  Â  Â  Â  });
Â  Â  Â  Â  cell.textContent = '';
Â  Â  Â  Â  cell.appendChild(input);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  row.appendChild(cell);
Â  Â  }
Â  Â  tbody.appendChild(row);
Â  }
Â  // napelnij select w formularzu... (zostaje)
Â  // napelnij select w formularzu odpowiadajÄ…cym wierszom
Â  populateRowSelect();
}
/* âœ… DODAJ TÄ˜ NOWÄ„ FUNKCJÄ˜: âœ… */

/* ---- NOWA FUNKCJA: Otwiera formularz na konkretnym wierszu ---- */
function openFormAtRow(logicalIndex) {
Â  // 1. OtwÃ³rz modal
Â  formModal.style.display = 'flex';
Â Â 
Â  // 2. PrzejdÅº od razu do kroku 2 (edycja wiersza)
Â  showStep(2);
Â Â 
Â  // 3. WypeÅ‚nij listÄ™ rozwijanÄ… wierszy (na wypadek gdyby nie byÅ‚a)
Â  populateRowSelect();
Â Â 
Â  // 4. Ustaw listÄ™ rozwijanÄ… na klikniÄ™ty wiersz
Â  formRowSelect.value = logicalIndex;
Â Â 
Â  // 5. Wczytaj dane z tego wiersza do formularza
Â  selectRowInForm(logicalIndex);
Â Â 
Â  // 6. Ustaw 'poprzedni' indeks, aby auto-zapis dziaÅ‚aÅ‚ poprawnie
Â  formRowSelect.dataset.prevIndex = logicalIndex;
}
/* ---- NOWA FUNKCJA: Kopiuj dane z wiersza powyÅ¼ej ---- */
function copyDataFromAbove(currentRow) {
Â  // 1. ZnajdÅº wiersz powyÅ¼ej (sourceRow)
Â  let sourceRow = currentRow.previousElementSibling;
Â Â 
Â  // 2. ObsÅ‚uga wiersza specjalnego (i=10)
Â  // JeÅ›li wiersz powyÅ¼ej to wiersz specjalny (ten z colSpan=8), przeskocz go
Â  if (sourceRow && sourceRow.cells.length < 8) {
Â  Â  sourceRow = sourceRow.previousElementSibling;
Â  }
Â Â 
Â  // 3. JeÅ›li nie ma wiersza ÅºrÃ³dÅ‚owego (to byÅ‚ pierwszy wiersz), nic nie rÃ³b
Â  if (!sourceRow) {
Â  Â  const checkbox = currentRow.querySelector('.jw-checkbox-container input[type="checkbox"]');
Â  Â  if (checkbox) checkbox.checked = false; // Odznacz checkbox
Â  Â  return;
Â  }

Â  // 4. Skopiuj dane (Kolumny 2, 3, 4)
Â  // Kolumna 2 (Opis) -> j=2, cell[1]
Â  // Kolumna 3 (Liczba) -> j=3, cell[2]
Â  // Kolumna 4 (Rozpoznanie) -> j=4, cell[3]

Â  // Kopiowanie Kolumny 2 (Opis) - uwzglÄ™dniamy nowÄ… strukturÄ™
Â  const sourceTextDiv = sourceRow.cells[1].querySelector('.editable-text');
Â  const targetTextDiv = currentRow.cells[1].querySelector('.editable-text');
Â  if (sourceTextDiv && targetTextDiv) {
Â  Â  targetTextDiv.innerHTML = sourceTextDiv.innerHTML; // UÅ¼yj innerHTML
Â  }

Â  // Kopiowanie Kolumny 3 (Liczba) - to jest input
Â  const sourceInput = sourceRow.cells[2].querySelector('input[type="number"]');
Â  const targetInput = currentRow.cells[2].querySelector('input[type="number"]');
Â  if (sourceInput && targetInput) {
Â  Â  targetInput.value = sourceInput.value;
Â  }
Â Â 
Â  // Kopiowanie Kolumny 4 (Rozpoznanie) - to jest zwykÅ‚y tekst
Â  const sourceText = sourceRow.cells[3].textContent;
Â  currentRow.cells[3].textContent = sourceText;
}
/* ---- lista lekow w datalist ---- */
function rebuildListaLekow(){
Â  const dl = document.getElementById('listaLekow');
Â  dl.innerHTML = '';
Â  nazwyLekow.forEach(n=>{
Â  Â  const o = document.createElement('option');
Â  Â  o.value = n;
Â  Â  dl.appendChild(o);
Â  });
}

/* ---- podÅ‚Ä…czenie autouzupeÅ‚niania klienta (nagÅ‚Ã³wek i pole formularza) ---- */
function setupClientAutoFill(){
Â  const klientSelect = document.getElementById('klientSelect');
Â  const klientList = document.getElementById('klientList');
Â  klientSelect.addEventListener('input', function(){
Â  Â  const val = this.value;
Â  Â  const opt = [...klientList.options].find(o=>o.value===val);
Â  Â  if (opt){
Â  Â  Â  document.getElementById('adresKlienta').textContent = opt.dataset.adres || '';
Â  Â  Â  document.getElementById('nrStada').textContent = opt.dataset.nrstada || '';
Â  Â  } else {
Â  Â  Â  document.getElementById('adresKlienta').textContent = '';
Â  Â  Â  document.getElementById('nrStada').textContent = '';
Â  Â  }
Â  });

Â  // formularz - automatyczne uzupeÅ‚nianie adresu i nr stada po wyborze klienta
Â  const formKlient = document.getElementById('formKlient');
Â  formKlient.addEventListener('input', function(){
Â  Â  const val = this.value;
Â  Â  const opt = [...klientList.options].find(o=>o.value===val);
Â  Â  if (opt){
Â  Â  Â  document.getElementById('formAdres').value = opt.dataset.adres || '';
Â  Â  Â  document.getElementById('formNrStada').value = opt.dataset.nrstada || '';
Â  Â  } else {
Â  Â  Â  // nieznany klient -> nie czyÅ›cimy adresu aby uÅ¼ytkownik mÃ³gÅ‚ pisaÄ‡
Â  Â  }
Â  });
}

/* ---- kopiowanie do wiersza 10 i przewiniÄ™cie + podÅ›wietlenie ---- */
function copyToRow10FromRow0(){
Â  const rows = document.querySelectorAll('#karta tbody tr');
Â  if (!rows[0]) return;
Â  // only copy if rows[0] is a normal row (we built so first is row 1)
Â  // find source cells: first non-10 row (rows array includes the special row as one element)
Â  // Safer way: build arr of editable rows (like rowsEditable())
Â  const ed = rowsEditable();
Â  if (ed.length === 0) return;
Â  const src = ed[0]; // first editable row
Â  // find the DOM row index of physical row10 in tbody (it is the 10th created tr)
Â  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
Â  // find index of the row which has colSpan === 8 (our special row)
Â  const specialIndex = tbodyTrs.findIndex(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
Â  if (specialIndex === -1) return;
Â  const row10 = tbodyTrs[specialIndex];
Â  // copy cells 1..3 from src into the "special" row cells (special row has single TD colspan 8)
Â  // Original behaviour: rows[10].cells[1] etc. In our DOM the "special" row is single cell colspan 8,
Â  // but original code earlier assumed rows[10].cells[1] exists. To match original behaviour we will insert
Â  // a new row AFTER the special row and fill it (but user wanted structure unchanged). So keep original approach:
Â  // In earlier code, rows[10] referenced the 11th element of NodeList of rows (including special as its own row),
Â  // and they set rows[10].cells[1] etc. That worked because special row still had 8 cells in earlier code.
Â  // To be compatible, we will locate the editable rows array and find the 10th logical row (index 9) and copy into it.
Â  const logicalRows = rowsEditable(); // array of trs for logical rows (skips special)
Â  if (logicalRows.length >= 10) {
Â  Â  const target = logicalRows[9]; // 0-based -> 9 = 10th editable row (this corresponds to original design)
Â  Â  // copy columns: cells[1], cells[2], cells[3]
Â  Â  const sourceTextDiv = src.cells[1].querySelector('.editable-text');
Â  Â  const targetTextDiv = target.cells[1].querySelector('.editable-text');
Â  Â  if (sourceTextDiv && targetTextDiv) targetTextDiv.textContent = sourceTextDiv.textContent;
Â  Â  // cell[2] may contain input
Â  Â  const srcInput = src.cells[2].querySelector('input');
Â  Â  const tgtInput = target.cells[2].querySelector('input');
Â  Â  if (srcInput && tgtInput) tgtInput.value = srcInput.value;
Â  Â  target.cells[3].textContent = src.cells[3].textContent;
Â  Â  // highlight and scroll
Â  Â  target.classList.add('highlight-row');
Â  Â  setTimeout(()=>target.classList.remove('highlight-row'),2000);
Â  Â  // scroll into view
Â  Â  target.scrollIntoView({behavior:'smooth', block:'center'});
Â  } else {
Â  Â  alert('Brak wystarczajÄ…cej liczby wierszy aby przenieÅ›Ä‡ dane do wiersza 10.');
Â  }
}

/* helper: zwraca tabelÄ™ logicznych (edytowalnych) wierszy jako tablica */
function rowsEditable(){
Â  return [...document.querySelectorAll('#karta tbody tr')].filter(tr=>tr.cells.length === 8);
}

/* ---- Formularz: otwieranie, krokowanie, synchronizacja nagÅ‚Ã³wka ---- */
const formModal = document.getElementById('formModal');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const formBtn = document.getElementById('formBtn');
const closeForm = document.getElementById('closeForm');
const nextToProducts = document.getElementById('nextToProducts');
const backToHeader = document.getElementById('backToHeader');
const formRowSelect = document.getElementById('formRowSelect');

formBtn.addEventListener('click', ()=>{
Â  formModal.style.display = 'flex';
Â  showStep(1);
Â  populateRowSelect();
Â  formRowSelect.dataset.prevIndex = 0;Â 
Â  // set form fields from current header values (so form reflects table)
Â  document.getElementById('formKlient').value = document.getElementById('klientSelect').value || '';
Â  document.getElementById('formAdres').value = document.getElementById('adresKlienta').textContent || '';
Â  document.getElementById('formNrStada').value = document.getElementById('nrStada').textContent || '';
Â  document.getElementById('formDataZgloszenia').value = document.getElementById('dataZgloszenia').value || '';
Â  document.getElementById('formDataWykonania').value = document.getElementById('dataWykonania').value || '';
Â  document.getElementById('formNrDokumentu').value = document.getElementById('nrDokumentu').value || '';
});

closeForm.addEventListener('click', ()=> formModal.style.display = 'none');

function showStep(n){
Â  step1.classList.toggle('active', n===1);
Â  step2.classList.toggle('active', n===2);
}

/* Next -> synchronizuj nagÅ‚Ã³wek i przejdÅº do kroku 2 */
nextToProducts.addEventListener('click', ()=>{
Â  // sync header form -> top header immediately (as user wanted)
Â  syncHeaderFormToTop();
Â  // populate first selected row data into form fields
Â  populateRowSelect();
Â  selectRowInForm(0); // default first logical row
Â  showStep(2);
});

/* back */
backToHeader.addEventListener('click', ()=>{
Â  showStep(1);
});

/* sync header: wpisane w formularzu wartoÅ›ci trafiajÄ… do headera */
function syncHeaderFormToTop(){
Â  const klient = document.getElementById('formKlient').value;
Â  const adres = document.getElementById('formAdres').value;
Â  const nrStada = document.getElementById('formNrStada').value;
Â  const dataZ = document.getElementById('formDataZgloszenia').value;
Â  const dataW = document.getElementById('formDataWykonania').value;
Â  const nrDok = document.getElementById('formNrDokumentu').value;
Â  document.getElementById('klientSelect').value = klient;
Â  document.getElementById('adresKlienta').textContent = adres;
Â  document.getElementById('nrStada').textContent = nrStada;
Â  if (dataZ) document.getElementById('dataZgloszenia').value = dataZ;
Â  if (dataW) document.getElementById('dataWykonania').value = dataW;
Â  document.getElementById('nrDokumentu').value = nrDok;
}

/* ---- Row select: wypeÅ‚nij select indeksami logicznych wierszy (1..13 bez wiersza 10) ---- */
function populateRowSelect(){
Â  const sel = formRowSelect;
Â  sel.innerHTML = '';
Â  const logical = rowsEditable();
Â  logical.forEach((tr, idx) => {
Â  Â  // compute displayed row number -> use first cell (like "1." etc)
Â  Â  const display = tr.cells[0].textContent || (idx+1)+'.';
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = idx; // index within logical array
Â  Â  opt.textContent = (idx+1) + '.';
Â  Â  sel.appendChild(opt);
Â  });
}

/* ---- wybierz kolejny/poprzedni w formularzu ---- */
document.getElementById('nextRow').addEventListener('click', ()=>{
Â  const sel = formRowSelect;
Â  const prevIdx = parseInt(sel.dataset.prevIndex,10);
Â  if (!isNaN(prevIdx)) saveRow(prevIdx); // autozapis obecnego wiersza
Â  if (sel.selectedIndex < sel.options.length - 1) sel.selectedIndex++;
Â  sel.dispatchEvent(new Event('change'));
});

document.getElementById('prevRow').addEventListener('click', ()=>{
Â  const sel = formRowSelect;
Â  const prevIdx = parseInt(sel.dataset.prevIndex,10);
Â  if (!isNaN(prevIdx)) saveRow(prevIdx); // autozapis obecnego wiersza
Â  if (sel.selectedIndex > 0) sel.selectedIndex--;
Â  sel.dispatchEvent(new Event('change'));
});

// dodatkowo przy rÄ™cznym wyborze wiersza w dropdown autozapis
formRowSelect.addEventListener('change', ()=>{
Â  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10);
Â  if (!isNaN(prevIdx)) saveRow(prevIdx); // teraz zapisze rÃ³wnieÅ¼ 0
Â  const idx = parseInt(formRowSelect.value,10);
Â  selectRowInForm(idx);
Â  formRowSelect.dataset.prevIndex = idx;
});



/* ---- zapis aktualnego wiersza przy zmianie wiersza w formularzu ---- */
formRowSelect.addEventListener('change', ()=> {
Â  // zapis aktualnego wiersza przed przejÅ›ciem do nowego
Â  const prevIdx = parseInt(formRowSelect.dataset.prevIndex, 10);
Â  if (!isNaN(prevIdx)) {
Â  Â  saveRow(prevIdx);
Â  }
Â  const idx = parseInt(formRowSelect.value, 10);
Â  selectRowInForm(idx);
Â  formRowSelect.dataset.prevIndex = idx; // zapamiÄ™taj nowy indeks
});

/* ---- funkcja zapisu wiersza (jeÅ›li jeszcze nie masz) ---- */
function saveRow(idx){
Â  const logical = rowsEditable();
Â  const row = logical[idx];
Â  if (!row) return;

Â  // write values
Â  const textDiv = row.cells[1].querySelector('.editable-text');
Â  if (textDiv) textDiv.textContent = document.getElementById('formOpis').value;
Â  const inp2 = row.cells[2].querySelector('input');
Â  if (inp2) inp2.value = document.getElementById('formLiczba').value;
Â  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
Â  const produktInput = row.cells[4].querySelector('input');
Â  if (produktInput) {
Â  Â  produktInput.value = document.getElementById('formLek').value;
Â  Â  produktInput.dispatchEvent(new Event('input', { bubbles:true }));
Â  }
Â  row.cells[5].textContent = document.getElementById('formSeria').value;
Â  const iloInp = row.cells[6].querySelector('input');
Â  if (iloInp) iloInp.value = document.getElementById('formDawkowanie').value || iloInp.value;
Â  row.cells[7].textContent = document.getElementById('formKarencja').value;
Â  row.classList.add('highlight-row');
Â  setTimeout(()=>row.classList.remove('highlight-row'), 1600);
}


function selectRowInForm(logicalIndex){
Â  const logical = rowsEditable();
Â  const row = logical[logicalIndex];
Â  if (!row) return;
Â  // load values into form
Â  const textDiv = row.cells[1].querySelector('.editable-text');
document.getElementById('formOpis').value = textDiv ? textDiv.textContent.trim() : '';
Â  const inp = row.cells[2].querySelector('input');
Â  document.getElementById('formLiczba').value = inp ? inp.value : '';
Â  document.getElementById('formRozpoznanie').value = row.cells[3].textContent.trim();
Â  const lekInput = row.cells[4].querySelector('input');
Â  document.getElementById('formLek').value = lekInput ? lekInput.value : '';
Â  document.getElementById('formSeria').value = row.cells[5].textContent.trim();
Â  // iloÅ›Ä‡ w komÃ³rce 6 moÅ¼e byÄ‡ input + tekst dawkowania
Â  // --- Wczytanie iloÅ›ci i dawkowania z komÃ³rki 6 ---
const cell6 = row.cells[6];

// liczba (maÅ‚y input)
const iloscInput = cell6.querySelector('input[type="number"]');
document.getElementById('formIlosc').value = iloscInput ? iloscInput.value : '';

// tekst po input (dawkowanie)
let tekstDawkowania = '';
if (cell6.childNodes.length > 1 && cell6.childNodes[1].nodeType === Node.TEXT_NODE) {
Â  tekstDawkowania = cell6.childNodes[1].textContent.trim();
}
document.getElementById('formDawkowanie').value = tekstDawkowania;

Â  document.getElementById('formKarencja').value = row.cells[7].textContent.trim();
}

/* ---- po wyborze produktu w formularzu automatycznie uzupeÅ‚nij seria/dawkowanie/karencja ---- */
document.getElementById('formLek').addEventListener('input', function(){
Â  const n = this.value;
Â  document.getElementById('formSeria').value = mapaSerii[n] || '';
Â  // jeÅ›li dawkowanie ma byÄ‡ w polu 'tekstowym' (zachowujemy format tabeli)
Â  document.getElementById('formDawkowanie').value = mapaIlosci[n] || '';
Â  document.getElementById('formKarencja').value = mapaKarencji[n] || '';
});

/* ---- zapis wiersza: zapisuje do logicznego wiersza (nie zmienia struktury tabeli) ---- */
document.getElementById('saveRow').addEventListener('click', ()=>{
Â  const idx = parseInt(formRowSelect.value,10);
Â  const logical = rowsEditable();
Â  const row = logical[idx];
Â  if (!row) { alert('Brak wybranego wiersza'); return; }

Â  // write values
Â  const textDiv = row.cells[1].querySelector('.editable-text');
if (textDiv) textDiv.textContent = document.getElementById('formOpis').value;
Â  // cell 2 -> input
Â  const inp2 = row.cells[2].querySelector('input');
Â  if (inp2) inp2.value = document.getElementById('formLiczba').value;
Â  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
Â  // produkt input
Â  const produktInput = row.cells[4].querySelector('input');
Â  if (produktInput) {
Â  Â  produktInput.value = document.getElementById('formLek').value;
Â  Â  // dispatch input event to trigger table logic (fills serie/ilosc/karencja like original)
Â  Â  produktInput.dispatchEvent(new Event('input', { bubbles:true }));
Â  }
Â  // series
Â  row.cells[5].textContent = document.getElementById('formSeria').value;
Â  // iloÅ›Ä‡ -> if there's input inside cell[6], set it; otherwise set text
Â  const iloInp = row.cells[6].querySelector('input');
Â  if (iloInp) {
Â  Â  // if user provided numeric in formDawkowanie, try set numeric portion
Â  Â  // but the table's cell[6] holds "<input> dostawanieTekst", so set input value
Â  Â  iloInp.value = document.getElementById('formIlosc').value || ''; // <-- POPRAWKA: pobierz z formIlosc
Â  Â Â 
Â  Â  // Zaktualizuj tekst dawkowania po inpucie
Â  Â  const dawkowanieText = document.getElementById('formDawkowanie').value || '';
Â  Â  let textNode = iloInp.nextSibling;
Â  Â  if (textNode && textNode.nodeType === Node.TEXT_NODE) {
Â  Â  Â  textNode.textContent = ' ' + dawkowanieText;
Â  Â  } else {
Â  Â  Â  iloInp.parentNode.appendChild(document.createTextNode(' ' + dawkowanieText));
Â  Â  }
Â  Â Â 
Â  } else {
Â  Â  row.cells[6].textContent = document.getElementById('formIlosc').value + ' ' + document.getElementById('formDawkowanie').value;
Â  }
Â  row.cells[7].textContent = document.getElementById('formKarencja').value;

Â  // Visually confirm
Â  row.classList.add('highlight-row');
Â  setTimeout(()=>row.classList.remove('highlight-row'), 1600);
Â  alert('Wiersz zapisany.');
});

/* ---- przycisk przepisz w formularzu: przenieÅ› dane z pierwszego wiersza do wiersza 10 i przenieÅ› uÅ¼ytkownika tam ---- */
document.getElementById('formCopyBtn').addEventListener('click', ()=>{
Â  copyToRow10FromRow0();

Â  // ustaw w formularzu na wiersz 10 (indeks logiczny 9)
Â  const sel = formRowSelect;
Â  sel.value = 9; // 0-based index
Â  sel.dispatchEvent(new Event('change'));

Â  // przewiÅ„ do wiersza 10 w tabeli
Â  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
Â  const special = tbodyTrs.find(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
Â  if (special) {Â 
Â  Â  special.scrollIntoView({behavior:'smooth', block:'center'});Â 
Â  Â  special.classList.add('highlight-row');Â 
Â  Â  setTimeout(()=>special.classList.remove('highlight-row'),2000);Â 
Â  }

Â  // formularz pozostaje otwarty
});


/* ---- przycisk gÃ³rny: przepisz dane z leczenia na miejscu (tak jak oryginalnie) ---- */
document.getElementById('copyBtn').addEventListener('click', ()=> {
Â  // wykonaj kopiÄ™ i przewiÅ„ do wiersza 10
Â  copyToRow10FromRow0();
});

/* ---- mikrofon (dyktowanie nazwy leku) ---- */
document.getElementById('micBtn').addEventListener('click', ()=>{
Â  // check for SpeechRecognition
Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  if (!SpeechRecognition) { alert('Twoja przeglÄ…darka nie obsÅ‚uguje rozpoznawania mowy'); return; }
Â  const rec = new SpeechRecognition();
Â  rec.lang = 'pl-PL';
Â  rec.interimResults = false;
Â  rec.maxAlternatives = 1;
Â  rec.start();
Â  rec.onresult = (e) => {
Â  Â  const text = e.results[0][0].transcript;
Â  Â  document.getElementById('formLek').value = text;
Â  Â  // auto-fill based on recognized name (best effort)
Â  Â  document.getElementById('formSeria').value = mapaSerii[text] || '';
Â  Â  document.getElementById('formDawkowanie').value = mapaIlosci[text] || '';
Â  Â  document.getElementById('formKarencja').value = mapaKarencji[text] || '';
Â  };
Â  rec.onerror = (ev) => {
Â  Â  console.error('Speech error', ev);
Â  Â  alert('BÅ‚Ä…d rozpoznawania mowy: ' + (ev.error || 'nieznany'));
Â  };
});

/* ---- podpis (oryginalna logika) ---- */
function initSignature(id){
Â  const canvas=document.getElementById(id);
Â  if (!canvas) return;
Â  const ctx=canvas.getContext('2d');
Â  ctx.lineWidth = 2;
Â  ctx.lineCap = 'round';
Â  let drawing=false;

Â  function getPos(e, c){
Â  Â  const rect = c.getBoundingClientRect();
Â  Â  const scaleX = c.width / rect.width;
Â  Â  const scaleY = c.height / rect.height;
Â  Â  const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
Â  Â  const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
Â  Â  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
Â  }

Â  canvas.addEventListener('pointerdown', e=>{ drawing=true; const pos=getPos(e,canvas); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); });
Â  canvas.addEventListener('pointermove', e=>{ if(drawing){ const pos=getPos(e,canvas); ctx.lineTo(pos.x,pos.y); ctx.stroke(); }});
Â  canvas.addEventListener('pointerup', ()=>{drawing=false;});
Â  canvas.addEventListener('pointerleave', ()=>{drawing=false;});

Â  // fullscreen handlers
Â  const fullscreenOverlay=document.getElementById('fullscreenOverlay');
Â  const fullscreenCanvas=document.getElementById('fullscreenCanvas');
Â  const closeBtn=document.getElementById('closeSignBtn');
Â  const clearFullscreenBtn=document.getElementById('clearFullscreenSignBtn');

Â  document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
Â  Â  fullscreenOverlay.style.display='flex';
Â  Â  fullscreenCanvas.width = window.innerWidth - 20;
Â  Â  fullscreenCanvas.height = window.innerHeight - 80;
Â  Â  const fctx = fullscreenCanvas.getContext('2d');
Â  Â  fctx.clearRect(0,0,fullscreenCanvas.width,fullscreenCanvas.height);
Â  Â  fctx.lineWidth = 5;
Â  Â  fctx.lineCap = 'round';
Â  Â  fctx.drawImage(canvas,0,0,fullscreenCanvas.width,fullscreenCanvas.height);

Â  Â  let fDrawing=false;
Â  Â  function getFPos(e){ const rect=fullscreenCanvas.getBoundingClientRect(); const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX; const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY; return { x: clientX-rect.left, y: clientY-rect.top }; }
Â  Â  fullscreenCanvas.addEventListener('pointerdown', e=>{ fDrawing=true; const pos=getFPos(e); fctx.beginPath(); fctx.moveTo(pos.x,pos.y); });
Â  Â  fullscreenCanvas.addEventListener('pointermove', e=>{ if(fDrawing){ const pos=getFPos(e); fctx.lineTo(pos.x,pos.y); fctx.stroke(); }});
Â  Â  fullscreenCanvas.addEventListener('pointerup', ()=>{fDrawing=false;});
Â  Â  fullscreenCanvas.addEventListener('pointerleave', ()=>{fDrawing=false;});
Â  });

Â  closeBtn.addEventListener('click', ()=>{
Â  Â  const fctx = fullscreenCanvas.getContext('2d');
Â  Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  Â  ctx.drawImage(fullscreenCanvas,0,0,canvas.width,canvas.height);
Â  Â  fullscreenOverlay.style.display='none';
Â  });

Â  clearFullscreenBtn.addEventListener('click', ()=>{
Â  Â  const fctx = fullscreenCanvas.getContext('2d');
Â  Â  fctx.clearRect(0,0,fullscreenCanvas.width,fullscreenCanvas.height);
Â  });

Â  document.getElementById('clearSignBtn').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); });
}

/* inicjalizacja podpisu po zaÅ‚adowaniu wierszy */
window.addEventListener('load', ()=> initSignature('canvasPosiadacz'));
/* ---- zapis wiersza automatycznie przy zmianie wiersza ---- */
formRowSelect.addEventListener('change', ()=>{
Â  // zapis aktualnego wiersza przed przejÅ›ciem do nowego
Â  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10);
Â  if (!isNaN(prevIdx)) {
Â  Â  saveRow(prevIdx);
Â  }
Â  const idx = parseInt(formRowSelect.value,10);
Â  selectRowInForm(idx);
Â  formRowSelect.dataset.prevIndex = idx; // zapamiÄ™taj nowy indeks
});

/* ---- funkcja zapisu wiersza (przeniesiona w gÃ³rÄ™ aby moÅ¼na uÅ¼yÄ‡ dynamicznie) ---- */
function saveRow(idx){
Â  const logical = rowsEditable();
Â  const row = logical[idx];
Â  if (!row) return;

Â  // write values
Â  const textDiv = row.cells[1].querySelector('.editable-text');
Â  if (textDiv) textDiv.textContent = document.getElementById('formOpis').value;
Example
Â  const inp2 = row.cells[2].querySelector('input');
Â  if (inp2) inp2.value = document.getElementById('formLiczba').value;
Â  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
Â  const produktInput = row.cells[4].querySelector('input');
Â  if (produktInput) {
Â  Â  produktInput.value = document.getElementById('formLek').value;
Â  Â  produktInput.dispatchEvent(new Event('input', { bubbles:true }));
Â  }
Â  row.cells[5].textContent = document.getElementById('formSeria').value;

// --- ZAPIS ILOÅšCI I DAWKOWANIA ---
const cell = row.cells[6]; // kolumna IloÅ›Ä‡ / dawkowanie
const iloscInput = cell.querySelector('input[type="number"]');
if (iloscInput) {
Â  // przepisz wartoÅ›Ä‡ liczbowÄ… z formularza
Â  iloscInput.value = document.getElementById('formIlosc').value || '';
}

const dawkowanie = document.getElementById('formDawkowanie').value || '';
// jeÅ›li po input jest tekst â€” zaktualizuj go
if (cell.childNodes.length > 1 && cell.childNodes[1].nodeType === Node.TEXT_NODE) {
Â  cell.childNodes[1].textContent = ' ' + dawkowanie;
} else {
Â  // jeÅ›li brak tekstu â€” dodaj nowy
Â  cell.appendChild(document.createTextNode(' ' + dawkowanie));
}

// --- pozostaÅ‚e pola ---
row.cells[7].textContent = document.getElementById('formKarencja').value;

// efekt wizualny: podÅ›wietlenie zapisanego wiersza
row.classList.add('highlight-row');
setTimeout(() => row.classList.remove('highlight-row'), 1600);

}

/* ---- przycisk ZakoÅ„cz w kroku 2 ---- */
const finishBtn = document.createElement('button');
finishBtn.textContent = 'ZakoÅ„cz';
finishBtn.className = 'btn warn small';
finishBtn.style.marginLeft = '6px';
finishBtn.addEventListener('click', ()=>{
Â  const idx = parseInt(formRowSelect.value,10);
Â  saveRow(idx);Â  Â  Â  Â  Â  // zapis obecnego wiersza
Â  syncHeaderFormToTop(); // aktualizacja nagÅ‚Ã³wka
Â  formModal.style.display = 'none'; // zamknij formularz
});
step2.querySelector('.form-actions .right').appendChild(finishBtn);
// Dopasowanie formularza do ekranu przy rotacji lub resize
window.addEventListener("resize", () => {
Â  const modal = document.getElementById("formModal");
Â  const card = modal.querySelector(".form-card");
Â  if (card) {
Â  Â  card.style.height = window.innerHeight * 0.9 + "px";
Â  Â  card.style.width = Math.min(window.innerWidth * 0.95, 600) + "px";
Â  }
});
// ğŸ¤ Dyktowanie gÅ‚osowe dla pola "Okres karencji / uwagi"
const micBtn = document.getElementById('micKarencja');
const karencjaInput = document.getElementById('formKarencja');

if ('webkitSpeechRecognition' in window) {
Â  const recognition = new webkitSpeechRecognition();
Â  recognition.lang = 'pl-PL';
Â  recognition.continuous = false;
Â  recognition.interimResults = false;

Â  micBtn.addEventListener('click', () => {
Â  Â  if (micBtn.classList.contains('active')) {
Â  Â  Â  recognition.stop();
Â  Â  Â  micBtn.classList.remove('active');
Â  Â  } else {
Â  Â  Â  recognition.start();
Â  Â  Â  micBtn.classList.add('active');
Â  Â  }
Â  });

Â  recognition.onresult = (event) => {
Â  Â  const text = event.results[0][0].transcript;
Â  Â  karencjaInput.value = karencjaInput.value
Â  Â  Â  ? karencjaInput.value + ' ' + text
Â  Â  Â  : text;
Â  };

Â  recognition.onerror = (e) => {
Â  Â  console.error('BÅ‚Ä…d rozpoznawania mowy:', e.error);
Â  Â  micBtn.classList.remove('active');
Â  };

Â  recognition.onend = () => {
Â  Â  micBtn.classList.remove('active');
Â  };
} else {
Â  micBtn.style.display = 'none';
Â  console.warn('Rozpoznawanie mowy nie jest obsÅ‚ugiwane w tej przeglÄ…darce.');
}
// === ObsÅ‚uga przycisku Drukuj i zapisu e-maila ===

// Drukuj (jeÅ›li chcesz Å¼eby klikniÄ™cie tego przycisku wywoÅ‚aÅ‚o window.print)
const drukujBtn = document.getElementById('drukujBtn');
if (drukujBtn) {
Â  drukujBtn.addEventListener('click', () => {
Â  Â  window.print();
Â  });
}

// Elementy e-mail
const emailInput = document.getElementById('userEmail');
const saveEmailBtn = document.getElementById('saveEmail');

// Wczytaj zapisany e-mail z localStorage (jeÅ›li jest)
try {
Â  const savedEmail = localStorage.getItem('userEmail');
Â  if (savedEmail && emailInput) emailInput.value = savedEmail;
} catch (e) {
Â  console.warn('Brak dostÄ™pu do localStorage:', e);
}

// Zapisuj e-mail po klikniÄ™ciu przycisku ğŸ’¾
if (saveEmailBtn && emailInput) {
Â  saveEmailBtn.addEventListener('click', () => {
Â  Â  const email = emailInput.value.trim();
Â  Â  if (!email) {
Â  Â  Â  alert('âš ï¸ WprowadÅº adres e-mail.');
Â  Â  Â  return;
Â  Â  }
Â  Â  // podstawowa walidacja
Â  Â  if (!email.includes('@') || !email.includes('.')) {
Â  Â  Â  alert('âš ï¸ WprowadÅº poprawny adres e-mail.');
Â  Â  Â  return;
Â  Â  }
Â  Â  try {
Â  Â  Â  localStorage.setItem('userEmail', email);
Â  Â  Â  alert('ğŸ“¨ Adres e-mail zostaÅ‚ zapisany lokalnie.');
Â  Â  } catch (e) {
Â  Â  Â  console.error('BÅ‚Ä…d zapisu w localStorage:', e);
Â  Â  Â  alert('âŒ Nie udaÅ‚o siÄ™ zapisaÄ‡ adresu e-mail lokalnie.');
Â  Â  }
Â  });
}

</script>
<script>
Â  if ('serviceWorker' in navigator) {
Â  Â  navigator.serviceWorker.register('sw.js')
Â  Â  Â  .then(() => console.log('âœ… Service Worker zarejestrowany!'))
Â  Â  Â  .catch(err => console.error('âŒ BÅ‚Ä…d rejestracji SW:', err));
Â  }

</script>
</body>
</html>
