<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>KARTA LECZENIA ZWIERZĄT</title>

    <meta name="theme-color" content="#2b74e4">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0275d8">
  <link rel="icon" href="https://www.gstatic.com/images/icons/material/system/2x/pets_black_24dp.png" type="image/png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
  /* --- Sekcja Drukuj + e-mail (styling) --- */
  .drukuj-sekcja {
    margin-top: 20px;
    padding: 10px 0 0 0;
    border-top: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .drukuj-sekcja #drukujBtn {
    background: #e6e6e6;
    border: 1px solid #aaa;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
  }

  .drukuj-sekcja #drukujBtn:hover {
    background: #dcdcdc;
  }

  /* 📧 Pole e-mail */
  .email-box {
    width: 100%;
    font-size: 14px;
  }

  .email-input-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
  }

  .email-input-wrapper input[type="email"] {
    width: 33%;
    min-width: 180px;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }

  .email-input-wrapper button {
    background: #f5f5f5;
    border: 1px solid #bbb;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    padding: 5px 8px;
  }

  /* Ukryj pole e-mail przy drukowaniu */
  @media print {
    .email-box, .drukuj-sekcja button#saveEmail { display: none !important; }
  }

  body { font-family: Arial, sans-serif; margin: 20px; transform: scale(0.95); transform-origin: top left; }
  h2 { text-align: center; font-size: 15px; text-transform: uppercase; margin-bottom: 10px; }
  .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 12px; margin-bottom: 10px; }
  .top-section div { padding: 5px; }
  .table-container { width: 100%; overflow-x: auto; }
  table { border-collapse: collapse; width: 100%; font-size: 11px; }
  th, td { border: 1px solid #000; padding: 4px; text-align: left; vertical-align: middle; }
  th { background: #e8eefc; text-align: center; }
  td[contenteditable="true"] { background: #fefefe; }
  .actions { text-align: right; margin-top: 10px; }
  @media print { #printBtn, #copyBtn, #clearSignBtn, #fullscreenBtn, #formBtn { display: none; } }
  input[type="date"] { font-size: 11px; }
  .small-input { width: 40px; display: inline-block; margin-right: 3px; }
  .center-text { text-align: center; }

  /* podpisy */
  .signatures { display: flex; justify-content: space-between; margin-top: 20px; }
  .signature-box { display: flex; flex-direction: column; align-items: center; width: 48%; }
  .signature-label { font-weight: bold; margin-bottom: 2px; display: block; text-align: center; width: 100%; }
  .signature-canvas { border: 1px solid #000; display: block; height: 80px; width: 100%; margin-top: 5px; touch-action: none; }
  .signature-img { display: block; height: 80px; width: 100%; object-fit: contain; margin-top: 5px; }
  .signature-name { margin-top: 2px; font-weight: normal; text-align: center; }
  /* podpisy */
  /* ... (inne style podpisów) ... */
/* podpisy */
  /* ... (inne style podpisów) ... */
  .fullscreen-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0; /* Pokryj cały ekran */
    background: #fff;
    display: none; /* ✅ POPRAWKA: Ukryj overlay na starcie */
    z-index: 9999;
    /* Użyj flexbox DOPIERO gdy jest widoczny (JS ustawi display: flex) */
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  /* ... (reszta stylów dla .fullscreen-canvas i przycisków pozostaje bez zmian) ... */
  .fullscreen-canvas {
    flex-grow: 1; /* Pozwól płótnu rozciągnąć się pionowo */
    max-height: 80vh; /* Ogranicz wysokość */
    width: 100%; /* Zajmij całą dostępną szerokość */
    border: 1px solid #000;
    touch-action: none;
    cursor: crosshair; /* Zmień kursor na krzyżyk */
  }
  /* Styl dla przycisków w overlay */
  .fullscreen-overlay button {
    margin-top: 8px; /* Odstęp między przyciskami a płótnem/sobą */
    padding: 8px 15px; /* Trochę większe przyciski */
  }
  /* Dostosowanie dla trybu poziomego */
  @media (orientation: landscape) and (max-height: 500px) {
    .fullscreen-overlay {
      padding: 5px; /* Mniejszy padding */
    }
    /* Usunięto max-height stąd */
    .fullscreen-overlay button {
      margin-top: 5px; /* Mniejszy odstęp */
      padding: 5px 10px; /* Mniejsze przyciski */
    }
  }
  #closeSignBtn { /* Domyślny odstęp już jest, zerujemy */
      margin-top: 8px;
  }
   #clearFullscreenSignBtn {
       margin-top: 8px;
   }

  /* ---- formularz (dodany, nie wpływa na tabelę) ---- */
  #formModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.48);
    display: none;
    z-index: 10000;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .form-card {
    width: 140vw;
    max-width: 600px;
    height: 120vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    font-size: clamp(18px, 5vw, 22px);
  }

  @media (max-width: 480px) {
    .form-card {
      width: 98vw;
      height: 95vh;
      padding: 12px;
    }
    input, select, textarea, button {
      font-size: 1rem;
    }
  }

  .form-step { display:none; }
  .form-step.active { display:block; }
  .form-row { margin-bottom:8px; }
  .form-row label { display:block; font-weight:600; font-size:13px; margin-bottom:4px; }
  .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="number"], .form-row textarea, .form-row input[list] {
    width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px;
    box-sizing:border-box;
  }
  .form-row textarea { min-height:70px; resize:vertical; }
  .form-actions { display:flex; gap:8px; justify-content:space-between; margin-top:12px; flex-wrap:wrap; }
  .form-actions .left, .form-actions .right { display:flex; gap:8px; }
  .btn { padding:8px 11px; border-radius:8px; border:1px solid #bbb; background:#f7f7f7; cursor:pointer; font-size:14px; }
  .btn.primary { background:#2b74e4; color:#fff; border-color:#2260c5; }
  .btn.warn { background:#c0392b; color:#fff; border-color:#992d22; }
  .btn.ghost { background:transparent; border-color:#ccc; }
  .small { padding:6px 8px; font-size:13px; }

  #micBtn { padding:6px 8px; border-radius:8px; cursor:pointer; border:1px solid #ccc; background:#eef; }

  .highlight-row { animation: highlightAnim 2s ease; }
  @keyframes highlightAnim {
    0% { background: #ffff99; }
    100% { background: transparent; }
  }

  @media (orientation: portrait) {
    .form-card {
      width: 98vw;
      max-width: 720px;
    }
  }

  @media (orientation: landscape) {
    .form-card {
      width: 90vw;
      max-width: 720px;
      max-height: 95vh;
    }
  }
    /* --- Styl dla przycisku edycji wiersza --- */
.btn-edit-row {
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 0px 5px;
  margin-left: 4px;
  cursor: pointer;
  font-size: 12px;
  line-height: 1.2;
  vertical-align: middle;
}
.btn-edit-row:hover {
  background: #e0e0e0;
}

/* Ukryj przycisk podczas drukowania */

/* ======================================================== */
/* KOMPLETNE STYLE DLA WYDRUKU (aby zmieścić na A4)        */
/* ======================================================== */
@media print {

  /* --- Ustawienia strony A4 --- */
  @page {
    size: A4;
    margin: 1cm; /* Możesz zmniejszyć, np. do 0.5cm */
  }

  /* --- Zmniejszenie ogólnych odstępów i czcionek --- */
  body {
    font-size: 10pt;
    margin: 0 !important;
    transform: none !important;
    width: 100%;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  h2 { font-size: 13pt; margin-bottom: 5px; }
  p { margin-top: 4px; margin-bottom: 4px; font-size: 9pt; }

  /* --- Sekcja nagłówkowa --- */
  .top-section {
    font-size: 9pt;
    margin-bottom: 5px;
    grid-template-columns: 1fr 1fr 1fr;
  }
  .top-section div { padding: 2px; }
  .top-section input[type="date"],
  .top-section input[type="text"] { font-size: 9pt; padding: 1px; }

  /* --- Tabela --- */
  .table-container { margin-bottom: 5px; }
  table { font-size: 8pt; }
  th, td { padding: 1px 2px; word-break: break-word; }
  td input[type="number"],
  td input[list],
  td .small-input { font-size: 8pt; padding: 0; margin: 0; height: auto; max-width: 95%; }
  td[contenteditable="true"] { padding: 1px 2px; }

  /* --- Podpisy --- */
  .signatures { margin-top: 10px; }
  .signature-box { width: 48%; }
  .signature-label { font-size: 9pt; margin-bottom: 0; }
  .signature-canvas, .signature-img { height: 40px; margin-top: 2px; }
  .signature-name { font-size: 9pt; margin-top: 1px; }

  /* --- Ukrywanie WSZYSTKICH niepotrzebnych elementów --- */
  .actions,           /* Sekcja z przyciskami na dole */
  #fullscreenOverlay, /* Overlay podpisu */
  #formModal,         /* Modal formularza */
  #fullscreenBtn,     /* Przycisk powiększenia podpisu */
  #clearSignBtn,      /* Przycisk czyszczenia podpisu */
  #copyBtn,           /* Przycisk kopiowania danych */
  #formBtn,           /* Przycisk otwierania formularza */
  .email-box,         /* Sekcja e-mail */
  .drukuj-sekcja button#saveEmail, /* Przycisk zapisu e-mail */
  #printBtn,          /* Przycisk Drukuj (z <div class="actions">) */
  .btn-edit-row {     /* ✅ Strzałki edycji wiersza */
    display: none !important;
  }

} /* Koniec @media print */

/* ✅ POCZĄTEK: Ukryj zapisany paragon podczas drukowania */
@media print {
  #savedReceiptSummary {
    display: none !important;
  }
}
/* ✅ KONIEC: Ukryj zapisany paragon podczas drukowania */

  </style>
</head>

<body>

<div style="text-align: center; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
  <button id="tabKartaBtn" class="btn primary">📝 Karta Leczenia</button>
  <button id="tabKalkulatorBtn" class="btn">🧮 Kalkulator Wizyty</button>
</div>
<div id="kartaLeczeniaSection">

<h2>KARTA LECZENIA ZWIERZĄT GOSPODARSKICH ORAZ ZWIERZĄT, Z KTÓRYCH POZYSKANE TKANKI LUB PRODUKTY SĄ PRZEZNACZONE DO SPOŻYCIA PRZEZ LUDZI / EWIDENCJA LECZENIA ZWIERZĄT</h2>

<div class="top-section">
  <div>
    <b>Nazwa i adres zakładu leczniczego dla zwierząt:</b><br>
    <span id="nazwaLecznicy"></span><br>
    <b>Wykonanie czynności lekarsko-weterynaryjnych dnia:</b>
    <input type="date" id="dataWykonania"><br>
    <b>Nr stada:</b> <span id="nrStada"></span>
  </div>
  <div>
    <b>Imię, nazwisko i adres albo nazwa siedziby i adres posiadacza zwierzęcia:</b><br>
    <input list="klientList" id="klientSelect" placeholder="Wpisz lub wybierz klienta"><br>
    <span id="adresKlienta"></span>
    <datalist id="klientList"></datalist>
  </div>
  <div>
    <b>Zgłoszenie:</b> Data: <input type="date" id="dataZgloszenia"><br>
    <b>Nr dokumentu:</b> <input type="text" id="nrDokumentu" placeholder="________">
  </div>
</div>

<div class="table-container">
  <table id="karta">
  <thead>
    <tr>
      <th rowspan="2" style="width:30px;">Lp.</th>
      <th rowspan="2" class="center-text">
        Nazwa siedziby stada i opis leczonego zwierzęcia<br>
        (gatunek, płeć numer identyfikacyjny, sposób oznakowania, wiek, masa ciała)
      </th>
      <th rowspan="2" class="center-text">Liczba leczonych zwierząt</th>
      <th rowspan="2" class="center-text">Rozpoznanie albo wstępne rozpoznanie choroby</th>
      <th colspan="3">
        Zastosowane u poszczególnych zwierząt produkty lecznicze lub nabyte przez posiadacza zwierzęcia produkty lecznicze weterynaryjne lub pasze lecznicze
      </th>
      <th rowspan="2">okres karencji / Zabieg leczniczy lub profilaktyczne zalecenia lekarskie oraz uwagi</th>
    </tr>
    <tr>
      <th>Nazwa produktu leczniczego/ produktu leczniczego weterynaryjnego/ paszy leczniczej</th>
      <th>Numer serii produktu leczniczego lub produktu leczniczego weterynaryjnego</th>
      <th>Ilość, dawkowanie zastosowanego produktu leczniczego lub ilość, dawkowanie i okres stosowanie nabytego produktu leczniczego, weterynaryjnego/paszy leczniczej</th>
    </tr>
  </thead>
  <tbody></tbody>
  </table>
</div>

<p><b>Oświadczam, że nabyte produkty lecznicze weterynaryjne/pasze lecznicze zostaną zastosowane zgodnie z zaleceniami lekarza weterynarii.</b></p>

<div class="signatures">
  <div class="signature-box">
    <span class="signature-label">Lekarz weterynarii</span>
    <img id="doctor-signature" class="signature-img" alt="Podpis lekarza">
    <span class="signature-name">lek. wet. Magdalena Chojnowska</span>
  </div>
  <div class="signature-box">
    <span class="signature-label">Podpis posiadacza zwierzęcia</span>
    <canvas id="canvasPosiadacz" class="signature-canvas"></canvas>
    <button id="fullscreenBtn">Podpisz dokument</button>
    <button id="clearSignBtn">Wyczyść podpis</button>
  </div>
</div>

<p><b>Wyniki badań uzupełniających:</b><br>*W przypadku zwierząt znajdujących się w rejestrze zwierząt gospodarskich oznakowanych</p>

<div class="actions">
 <button id="openCalculatorBtn" class="btn small">Otwórz Kalkulator</button>   <button id="copyBtn" class="btn">Przepisz dane z leczenia na miejscu</button>
  <button id="formBtn" class="btn">📋 Wprowadź poprzez formularz</button>
  <button id="printBtn" class="btn" onclick="window.print()">Drukuj / Zapisz PDF</button>
  <div class="email-box">
  <label for="userEmail">📧 Podaj swój adres e-mail:</label>
  <div class="email-input-wrapper">
    <input type="email" id="userEmail" placeholder="np. jan.kowalski@email.com">
    <button type="button" id="saveEmail" title="Zapisz adres e-mail">💾</button>
  </div>
</div>

</div>

<div class="fullscreen-overlay" id="fullscreenOverlay">
  <canvas id="fullscreenCanvas" class="fullscreen-canvas"></canvas>
  <button id="closeSignBtn">Zamknij podpis</button>
  <button id="clearFullscreenSignBtn">Wyczyść podpis</button>
</div>

<div id="formModal" aria-hidden="true">
  <div class="form-card" role="dialog" aria-modal="true">
        <div id="step1" class="form-step active">
      <h3>Dane posiadacza / nagłówek</h3>
      <div class="form-row">
        <label for="formKlient">Imię, nazwisko lub nazwa siedziby</label>
        <input list="klientList" id="formKlient" placeholder="Wpisz lub wybierz klienta">
      </div>
      <div class="form-row">
        <label for="formAdres">Adres</label>
        <input type="text" id="formAdres" placeholder="Adres">
      </div>
      <div class="form-row">
        <label for="formNrStada">Nr stada</label>
        <input type="text" id="formNrStada" placeholder="Nr stada">
      </div>
      <div class="form-row">
        <label for="formDataZgloszenia">Data zgłoszenia</label>
        <input type="date" id="formDataZgloszenia">
      </div>
      <div class="form-row">
        <label for="formDataWykonania">Data wykonania</label>
        <input type="date" id="formDataWykonania">
      </div>
      <div class="form-row">
        <label for="formNrDokumentu">Nr dokumentu</label>
        <input type="text" id="formNrDokumentu" placeholder="Numer dokumentu">
      </div>
      <div class="form-actions">
        <div class="left">
          <button id="closeForm" class="btn ghost small">Zakończ</button>
        </div>
        <div class="right">
          <button id="nextToProducts" class="btn primary small">Dalej ➜</button>
        </div>
      </div>
    </div>

        <div id="step2" class="form-step">
      <h3>Edycja wierszy tabeli</h3>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <label style="margin:0; font-weight:600;">Wybierz wiersz</label>
        <select id="formRowSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"></select>
        <div style="display:flex; gap:6px;">
          <button id="prevRow" class="btn small">◀</button>
          <button id="nextRow" class="btn small">▶</button>
        </div>
      </div>

      <div class="form-row">
        <label for="formOpis">Nazwa siedziby stada i opis zwierzęcia</label>
        <textarea id="formOpis" placeholder="Opis zwierzęcia"></textarea>
      </div>
      <div class="form-row">
        <label for="formLiczba">Liczba leczonych zwierząt</label>
        <input type="number" id="formLiczba" min="0" placeholder="0">
      </div>
      <div class="form-row">
        <label for="formRozpoznanie">Rozpoznanie / wstępne rozpoznanie</label>
        <input type="text" id="formRozpoznanie" placeholder="Rozpoznanie">
      </div>

      <div class="form-row">
        <label for="formLek">Nazwa produktu leczniczego (lista)</label>
        <input list="listaLekow" id="formLek" placeholder="Wybierz lek">
      </div>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <button id="micBtn" class="" title="Dyktuj nazwę produktu">🎤</button>
        <small style="color:#666">Naciśnij mikrofon aby dyktować</small>
      </div>

      <div class="form-row">
        <label for="formSeria">Numer serii produktu</label>
        <input type="text" id="formSeria" placeholder="Numer serii">
      </div>
      <form id="myForm">

  <div class="form-row">
    <label>Ilość </label>
    <input type="number" inputmode="numeric" pattern="[0-9]*" id="formIlosc" placeholder="0" style="width:60px;">
  </div>

  <div class="form-row">
    <label>Dawkowanie / jednostka</label>
    <input type="text" id="formDawkowanie" placeholder="np. 2 ml/kg">
  </div>
</form>

      <div class="mic-container">
  <input type="text" id="formKarencja" placeholder="Okres karencji / uwagi">
  <button type="button" id="micKarencja" class="mic-btn" title="Dyktuj">🎤</button>
</div>


      <div class="form-actions" style="margin-top:12px;">
        <div class="left">
          <button id="backToHeader" class="btn ghost small">⬅ Cofnij</button>
        </div>
        <div class="right">
          <button id="saveRow" class="btn primary small">Zapisz wiersz</button>
          <button id="formCopyBtn" class="btn small">Przepisz dane z leczenia na miejscu</button>
        </div>
      </div>
    </div>

  </div>
</div>

<datalist id="listaLekow"></datalist>

</div> <div id="kalkulatorWizytySection" style="display: none;">
  <h2>Kalkulator Wizyty</h2>
  <div id="calculatorUI">
    <div id="receiptDisplay" style="border: 1px solid #ccc; min-height: 100px; margin-bottom: 15px; padding: 5px; background: #f9f9f9;">
      <p style="text-align: center; color: #999;">Paragon jest pusty</p>
    </div>

    <div>
      <input type="checkbox" id="copyFromCardCheckbox">
      <label for="copyFromCardCheckbox">Przepisz produkty z karty leczenia</label>
    </div>

    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: flex-end;">
      <div style="flex-grow: 1;">
        <label for="productSelect">Wybierz produkt:</label><br>
        <input list="listaLekow" id="productSelect" style="width: 100%; padding: 5px;">
        </div>
      <div>
        <label for="productQuantityInput">Ilość:</label><br>
        <input type="number" id="productQuantityInput" value="1" min="1" style="width: 60px; padding: 5px;">
      </div>
      <button id="addProductBtn" class="btn primary small">Dodaj</button>
    </div>

    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: flex-end;">
       <div>
           <label for="pluCodeInput">Kod PLU:</label><br>
           <input type="text" id="pluCodeInput" style="width: 80px; padding: 5px;">
       </div>
       <button id="pluBtn" class="btn small">PLU</button>
    </div>


    <div style="text-align: right; margin-top: 20px;">
      <button id="saveReceiptBtn" class="btn primary">Zapisz Paragon</button>
    </div>
  </div>

  <div id="savedReceiptSummary" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px;">
     </div>

</div> <script>
/* ----- dane map i nazwy leków (będą uzupełnione z serwera) ----- */
let mapaSerii = {}, mapaIlosci = {}, mapaKarencji = {}, nazwyLekow = [];

// 🌐 Tryb GitHub Pages – pobieramy dane z lokalnego pliku data.json
fetch('data.json')
  .then(response => {
    if (!response.ok) throw new Error('Błąd sieci: ' + response.status);
    return response.json();
  })
  .then(data => {
    console.log('✅ Dane pobrane z data.json:', data);
    // ✅ POPRAWKA: Wywołujemy funkcję initData z pobranymi danymi
    initData(data);
  })
  .catch(error => {
    // ✅ POPRAWKA: Przeniesiono .catch() we właściwe miejsce
    console.error('❌ Błąd pobierania pliku data.json:', error);
    alert('Nie udało się pobrać danych. Spróbuj odświeżyć stronę.');
  });

// ✅ POPRAWKA: Definicja funkcji initData jest TERAZ na zewnątrz, we właściwym miejscu
function initData(data) {
  // nagłówek
  document.getElementById('nazwaLecznicy').textContent = data.nazwaLecznicy || '';
  // klienci -> datalist
  const klientList = document.getElementById('klientList');
  klientList.innerHTML = '';
  (data.klienci || []).forEach(k => {
    const opt = document.createElement('option');
    opt.value = k.nazwa;
    opt.dataset.adres = k.adres || '';
    opt.dataset.nrstada = k.nrStada || '';
    klientList.appendChild(opt);
  });

  // leki -> mapy i lista
  nazwyLekow = [];
  (data.leki || []).forEach(l => {
    mapaSerii[l.nazwa] = l.nrSerii || '';
    mapaIlosci[l.nazwa] = l.dawkowanie || '';
    mapaKarencji[l.nazwa] = l.karencja || '';
    nazwyLekow.push(l.nazwa);
  });
  rebuildListaLekow();

  // default daty -> today
  const today = new Date().toISOString().split('T')[0];
  if (!document.getElementById('dataZgloszenia').value) document.getElementById('dataZgloszenia').value = today;
  if (!document.getElementById('dataWykonania').value) document.getElementById('dataWykonania').value = today;
  // Sprawdzamy, czy elementy istnieją przed ustawieniem wartości
  const formDataZgloszenia = document.getElementById('formDataZgloszenia');
  const formDataWykonania = document.getElementById('formDataWykonania');
  if (formDataZgloszenia) formDataZgloszenia.value = today;
  if (formDataWykonania) formDataWykonania.value = today;

  // podpis lekarza
  if (data.doctorSignature) document.getElementById('doctor-signature').src = data.doctorSignature;

  // generuj wiersze tabeli
  generateRows();

  // podłącz zachowanie autouzupełniania klienta w nagłówku i w formularzu
  setupClientAutoFill();

  // --- Przenoszenie przycisków ---

  // Przenieś przycisk #formBtn nad tabelę
  const formBtnContainer = document.getElementById('formBtnContainer');
  const formBtn = document.getElementById('formBtn');
  // Sprawdzamy czy przyciski istnieją zanim je przeniesiemy
  if (formBtnContainer && formBtn) {
    formBtnContainer.appendChild(formBtn);
  } else {
     console.warn("#formBtn or #formBtnContainer not found, skipping move.");
  }


  // Przenieś przycisk #copyBtn do specjalnego wiersza tabeli
  const copyBtn = document.getElementById('copyBtn');
  const specialRow = document.querySelector('#karta tbody tr td[colSpan="8"]');
  if (copyBtn && specialRow) {
    const buttonContainer = specialRow.querySelector('div:last-child');
    if (buttonContainer) {
      buttonContainer.appendChild(copyBtn);
    } else {
      specialRow.appendChild(copyBtn); // Fallback
       console.warn("Button container in special row not found, fallback append.");
    }
  } else {
     console.warn("#copyBtn or special row not found, skipping move.");
  }
} // <- Koniec definicji funkcji initData

/* ---- generowanie wierszy ---- */
function generateRows(){
  const tbody = document.querySelector('#karta tbody');
  tbody.innerHTML = '';
  for (let i=1;i<=13;i++){
    const row = document.createElement('tr');
    if (i===10) {
      const cell = document.createElement('td');
      cell.colSpan = 8;
      cell.style.textAlign = 'left';

      const mainContainer = document.createElement('div');
      mainContainer.style.display = 'flex';
      mainContainer.style.alignItems = 'center';
      mainContainer.style.justifyContent = 'space-between';
      cell.appendChild(mainContainer);

      const textDiv = document.createElement('div');
      textDiv.textContent = 'Potwierdzenie nabycia produktu leczniczego weterynaryjnego/paszy leczniczej';
      textDiv.style.fontWeight = 'bold';
      mainContainer.appendChild(textDiv);

      const buttonPlaceholder = document.createElement('div');
      buttonPlaceholder.style.marginLeft = '10px';
      buttonPlaceholder.id = 'copyBtnPlaceholder';
      mainContainer.appendChild(buttonPlaceholder);

      row.appendChild(cell);
      tbody.appendChild(row);
      continue;
    }
    for (let j=1;j<=8;j++){
      const cell = document.createElement('td');

      // --- Logika dla j=1 (Numer wiersza + przycisk edycji) ---
      if (j===1) {
        const logicalIndex = (i > 10) ? i - 2 : i - 1;
        const rowNumText = (i > 10 ? i - 10 : i) + '.';
        cell.textContent = rowNumText + ' '; // Ustaw numer wiersza

        // Dodaj przycisk edycji
        const btn = document.createElement('button');
        btn.textContent = '➡️';
        btn.className = 'btn-edit-row';
        btn.title = 'Edytuj ten wiersz w formularzu';
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openFormAtRow(logicalIndex);
        });
        cell.appendChild(btn);

      // --- Logika dla j=2 (Przycisk "jw." + Opis) ---
      } else if (j === 2 && i !== 10) {
        cell.contentEditable = false; // Wyłącz edycję na samej komórce

        // Stwórz wewnętrzny div dla edytowalnego tekstu (ZAWSZE)
        const textDiv = document.createElement('div');
        textDiv.contentEditable = true;
        textDiv.className = 'editable-text';
        cell.appendChild(textDiv); // Dodaj div

      // --- Domyślne ustawienia dla pozostałych kolumn ---
      } else {
         // Ustaw contentEditable dla innych kolumn (oprócz j=1 i j=2 w wierszach edytowalnych)
         if (i !== 10) {
             cell.contentEditable = true;
         }
      }

      // Centrowanie tekstu (dla kolumn 2, 3, 4)
      if (j>=2 && j<=4) {
           cell.classList.add('center-text');
      }

      // --- Logika dla j=3 (Input liczbowy) ---
      if (j===3 && i!==10){
         const input = document.createElement('input');
         input.type = 'number';
         input.min = '0';
         input.style.width = '50px';
         cell.textContent = '';
         cell.appendChild(input);
      }

      // --- Logika dla j=5 (Input z listą leków) ---
      if (j===5 && i!==10){
        const input = document.createElement('input');
        input.setAttribute('list','listaLekow');
        input.style.width = '95%';
        input.addEventListener('input', function(){
          const nrCell = row.cells[5];
          const iloscCell = row.cells[6];
          const karCell = row.cells[7];
          const nazwa = this.value;
          const nr = mapaSerii[nazwa] || '';
          const dawka = mapaIlosci[nazwa] || '';
          const kar = mapaKarencji[nazwa] || '';
          if(nrCell) nrCell.textContent = nr;
          if(iloscCell) iloscCell.innerHTML = `<input class="small-input" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="ilość"> ${dawka||''}`;
          if(karCell) karCell.textContent = kar;
        });
        cell.textContent = '';
        cell.appendChild(input);
      }

      row.appendChild(cell);
    } // Koniec pętli for (j...)
    tbody.appendChild(row);
  } // Koniec pętli for (i...)

  populateRowSelect();
} // Koniec funkcji generateRows

/* ---- NOWA FUNKCJA: Otwiera formularz na konkretnym wierszu ---- */
function openFormAtRow(logicalIndex) {
  // 1. Otwórz modal
  formModal.style.display = 'flex';

  // 2. Przejdź od razu do kroku 2 (edycja wiersza)
  showStep(2);

  // 3. Wypełnij listę rozwijaną wierszy (na wypadek gdyby nie była)
  populateRowSelect();

  // 4. Ustaw listę rozwijaną na kliknięty wiersz
  formRowSelect.value = logicalIndex;

  // 5. Wczytaj dane z tego wiersza do formularza
  selectRowInForm(logicalIndex);

  // 6. Ustaw 'poprzedni' indeks, aby auto-zapis działał poprawnie
  formRowSelect.dataset.prevIndex = logicalIndex;
}
/* ---- lista lekow w datalist ---- */
function rebuildListaLekow(){
  const dl = document.getElementById('listaLekow');
  dl.innerHTML = '';
  nazwyLekow.forEach(n=>{
    const o = document.createElement('option');
    o.value = n;
    dl.appendChild(o);
  });
}

/* ---- podłączenie autouzupełniania klienta (nagłówek i pole formularza) ---- */
function setupClientAutoFill(){
  const klientSelect = document.getElementById('klientSelect');
  const klientList = document.getElementById('klientList');
  klientSelect.addEventListener('input', function(){
    const val = this.value;
    const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('adresKlienta').textContent = opt.dataset.adres || '';
      document.getElementById('nrStada').textContent = opt.dataset.nrstada || '';
    } else {
      document.getElementById('adresKlienta').textContent = '';
      document.getElementById('nrStada').textContent = '';
    }
  });

  // formularz - automatyczne uzupełnianie adresu i nr stada po wyborze klienta
  const formKlient = document.getElementById('formKlient');
  formKlient.addEventListener('input', function(){
    const val = this.value;
    const opt = [...klientList.options].find(o=>o.value===val);
    if (opt){
      document.getElementById('formAdres').value = opt.dataset.adres || '';
      document.getElementById('formNrStada').value = opt.dataset.nrstada || '';
    } else {
      // nieznany klient -> nie czyścimy adresu aby użytkownik mógł pisać
    }
  });
}

/* ---- kopiowanie do wiersza 10 i przewinięcie + podświetlenie ---- */
function copyToRow10FromRow0(){
  const rows = document.querySelectorAll('#karta tbody tr');
  if (!rows[0]) return;
  const ed = rowsEditable();
  if (ed.length === 0) return;
  const src = ed[0]; // first editable row
  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
  const specialIndex = tbodyTrs.findIndex(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
  if (specialIndex === -1) return;
  const logicalRows = rowsEditable(); // array of trs for logical rows (skips special)
  if (logicalRows.length >= 10) {
    const target = logicalRows[9]; // 0-based -> 9 = 10th editable row
    // copy columns: cells[1], cells[2], cells[3]
    const sourceTextDiv = src.cells[1].querySelector('.editable-text');
    const targetTextDiv = target.cells[1].querySelector('.editable-text');
    if (sourceTextDiv && targetTextDiv) targetTextDiv.textContent = sourceTextDiv.textContent; // Zmieniono na textContent
    const srcInput = src.cells[2].querySelector('input');
    const tgtInput = target.cells[2].querySelector('input');
    if (srcInput && tgtInput) tgtInput.value = srcInput.value;
    target.cells[3].textContent = src.cells[3].textContent;
    target.classList.add('highlight-row');
    setTimeout(()=>target.classList.remove('highlight-row'),2000);
    target.scrollIntoView({behavior:'smooth', block:'center'});
  } else {
    alert('Brak wystarczającej liczby wierszy aby przenieść dane do wiersza 10.');
  }
}

/* helper: zwraca tabelę logicznych (edytowalnych) wierszy jako tablica */
function rowsEditable(){
  return [...document.querySelectorAll('#karta tbody tr')].filter(tr=>tr.cells.length === 8);
}

/* ---- Formularz: otwieranie, krokowanie, synchronizacja nagłówka ---- */
const formModal = document.getElementById('formModal');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const formBtn = document.getElementById('formBtn');
const closeForm = document.getElementById('closeForm');
const nextToProducts = document.getElementById('nextToProducts');
const backToHeader = document.getElementById('backToHeader');
const formRowSelect = document.getElementById('formRowSelect');

if (formBtn) { // Dodano sprawdzenie, czy przycisk istnieje
    formBtn.addEventListener('click', ()=>{
      formModal.style.display = 'flex';
      showStep(1);
      populateRowSelect();
      formRowSelect.dataset.prevIndex = 0;
      document.getElementById('formKlient').value = document.getElementById('klientSelect').value || '';
      document.getElementById('formAdres').value = document.getElementById('adresKlienta').textContent || '';
      document.getElementById('formNrStada').value = document.getElementById('nrStada').textContent || '';
      document.getElementById('formDataZgloszenia').value = document.getElementById('dataZgloszenia').value || '';
      document.getElementById('formDataWykonania').value = document.getElementById('dataWykonania').value || '';
      document.getElementById('formNrDokumentu').value = document.getElementById('nrDokumentu').value || '';
    });
}


closeForm.addEventListener('click', ()=> formModal.style.display = 'none');

function showStep(n){
  step1.classList.toggle('active', n===1);
  step2.classList.toggle('active', n===2);
}

nextToProducts.addEventListener('click', ()=>{
  syncHeaderFormToTop();
  populateRowSelect();
  selectRowInForm(0);
  showStep(2);
});

backToHeader.addEventListener('click', ()=>{
  showStep(1);
});

function syncHeaderFormToTop(){
  const klient = document.getElementById('formKlient').value;
  const adres = document.getElementById('formAdres').value;
  const nrStada = document.getElementById('formNrStada').value;
  const dataZ = document.getElementById('formDataZgloszenia').value;
  const dataW = document.getElementById('formDataWykonania').value;
  const nrDok = document.getElementById('formNrDokumentu').value;
  document.getElementById('klientSelect').value = klient;
  document.getElementById('adresKlienta').textContent = adres;
  document.getElementById('nrStada').textContent = nrStada;
  if (dataZ) document.getElementById('dataZgloszenia').value = dataZ;
  if (dataW) document.getElementById('dataWykonania').value = dataW;
  document.getElementById('nrDokumentu').value = nrDok;
}

function populateRowSelect(){
  const sel = formRowSelect;
  sel.innerHTML = '';
  const logical = rowsEditable();
  logical.forEach((tr, idx) => {
    const display = tr.cells[0].textContent || (idx+1)+'.';
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = (idx+1) + '.';
    sel.appendChild(opt);
  });
}

document.getElementById('nextRow').addEventListener('click', ()=>{
  const sel = formRowSelect;
  const prevIdx = parseInt(sel.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx);
  if (sel.selectedIndex < sel.options.length - 1) sel.selectedIndex++;
  sel.dispatchEvent(new Event('change'));
});

document.getElementById('prevRow').addEventListener('click', ()=>{
  const sel = formRowSelect;
  const prevIdx = parseInt(sel.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx);
  if (sel.selectedIndex > 0) sel.selectedIndex--;
  sel.dispatchEvent(new Event('change'));
});

formRowSelect.addEventListener('change', ()=>{
  const prevIdx = parseInt(formRowSelect.dataset.prevIndex,10);
  if (!isNaN(prevIdx)) saveRow(prevIdx);
  const idx = parseInt(formRowSelect.value,10);
  selectRowInForm(idx);
  formRowSelect.dataset.prevIndex = idx;
});

/* ---- funkcja zapisu wiersza ---- */
function saveRow(idx){
  const logical = rowsEditable();
  const row = logical[idx];
  if (!row) return;

  // write values - Użyj nowej struktury dla kolumny 2
  const textDiv = row.cells[1].querySelector('.editable-text');
  if (textDiv) textDiv.textContent = document.getElementById('formOpis').value;
  else row.cells[1].textContent = document.getElementById('formOpis').value; // Fallback

  const inp2 = row.cells[2].querySelector('input');
  if (inp2) inp2.value = document.getElementById('formLiczba').value;
  row.cells[3].textContent = document.getElementById('formRozpoznanie').value;
  const produktInput = row.cells[4].querySelector('input');
  if (produktInput) {
    produktInput.value = document.getElementById('formLek').value;
    produktInput.dispatchEvent(new Event('input', { bubbles:true }));
  }
  row.cells[5].textContent = document.getElementById('formSeria').value;

  // ZAPIS ILOŚCI I DAWKOWANIA
  const cell6 = row.cells[6];
  const iloscInput = cell6.querySelector('input[type="number"]');
  if (iloscInput) {
    iloscInput.value = document.getElementById('formIlosc').value || '';
  }
  const dawkowanie = document.getElementById('formDawkowanie').value || '';
  let textNode = iloscInput ? iloscInput.nextSibling : cell6.firstChild; // Znajdź text node
  if (textNode && textNode.nodeType === Node.TEXT_NODE) {
      textNode.textContent = ' ' + dawkowanie;
  } else if (iloscInput) { // Jeśli jest input, dodaj tekst po nim
      cell6.appendChild(document.createTextNode(' ' + dawkowanie));
  } else { // Jeśli nie ma inputa, ustaw cały tekst
      cell6.textContent = (document.getElementById('formIlosc').value || '') + ' ' + dawkowanie;
  }

  row.cells[7].textContent = document.getElementById('formKarencja').value;

  row.classList.add('highlight-row');
  setTimeout(() => row.classList.remove('highlight-row'), 1600);
}


function selectRowInForm(logicalIndex){
  const logical = rowsEditable();
  const row = logical[logicalIndex];
  if (!row) return;

  // load values - Użyj nowej struktury dla kolumny 2
  const textDiv = row.cells[1].querySelector('.editable-text');
  document.getElementById('formOpis').value = textDiv ? textDiv.textContent.trim() : row.cells[1].textContent.trim(); // Fallback

  const inp = row.cells[2].querySelector('input');
  document.getElementById('formLiczba').value = inp ? inp.value : '';
  document.getElementById('formRozpoznanie').value = row.cells[3].textContent.trim();
  const lekInput = row.cells[4].querySelector('input');
  document.getElementById('formLek').value = lekInput ? lekInput.value : '';
  document.getElementById('formSeria').value = row.cells[5].textContent.trim();

  // Wczytanie ilości i dawkowania z komórki 6
  const cell6 = row.cells[6];
  const iloscInput = cell6.querySelector('input[type="number"]');
  document.getElementById('formIlosc').value = iloscInput ? iloscInput.value : '';
  let tekstDawkowania = '';
  // Sprawdź tekst po inpucie lub cały tekst komórki
  const textNode = iloscInput ? iloscInput.nextSibling : cell6.firstChild;
  if (textNode && textNode.nodeType === Node.TEXT_NODE) {
     tekstDawkowania = textNode.textContent.trim();
  } else if (!iloscInput) { // Jeśli nie ma inputa, weź cały tekst i usuń ewentualną liczbę
     const fullText = cell6.textContent.trim();
     const numberPart = document.getElementById('formIlosc').value;
     if (numberPart && fullText.startsWith(numberPart)) {
         tekstDawkowania = fullText.substring(numberPart.length).trim();
     } else {
         tekstDawkowania = fullText; // Fallback
     }
  }
  document.getElementById('formDawkowanie').value = tekstDawkowania;

  document.getElementById('formKarencja').value = row.cells[7].textContent.trim();
}

document.getElementById('formLek').addEventListener('input', function(){
  const n = this.value;
  document.getElementById('formSeria').value = mapaSerii[n] || '';
  document.getElementById('formDawkowanie').value = mapaIlosci[n] || '';
  document.getElementById('formKarencja').value = mapaKarencji[n] || '';
});

document.getElementById('saveRow').addEventListener('click', ()=>{
  const idx = parseInt(formRowSelect.value,10);
  saveRow(idx); // Wywołaj funkcję saveRow
  alert('Wiersz zapisany.'); // Przenieś alert tutaj
});

document.getElementById('formCopyBtn').addEventListener('click', ()=>{
  copyToRow10FromRow0();
  const sel = formRowSelect;
  sel.value = 9;
  sel.dispatchEvent(new Event('change'));
  const tbodyTrs = [...document.querySelectorAll('#karta tbody tr')];
  const special = tbodyTrs.find(tr => tr.children.length === 1 && tr.children[0].colSpan==8);
  if (special) {
    special.scrollIntoView({behavior:'smooth', block:'center'});
    special.classList.add('highlight-row');
    setTimeout(()=>special.classList.remove('highlight-row'),2000);
  }
});

if(document.getElementById('copyBtn')) { // Sprawdź czy przycisk istnieje
    document.getElementById('copyBtn').addEventListener('click', ()=> {
      copyToRow10FromRow0();
    });
}


document.getElementById('micBtn').addEventListener('click', ()=>{
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { alert('Twoja przeglądarka nie obsługuje rozpoznawania mowy'); return; }
  const rec = new SpeechRecognition();
  rec.lang = 'pl-PL';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.start();
  rec.onresult = (e) => {
    const text = e.results[0][0].transcript;
    document.getElementById('formLek').value = text;
    document.getElementById('formSeria').value = mapaSerii[text] || '';
    document.getElementById('formDawkowanie').value = mapaIlosci[text] || '';
    document.getElementById('formKarencja').value = mapaKarencji[text] || '';
  };
  rec.onerror = (ev) => {
    console.error('Speech error', ev);
    alert('Błąd rozpoznawania mowy: ' + (ev.error || 'nieznany'));
  };
});

/* ---- podpis (Wersja z blokadą, auto-resize i wymuszeniem landscape) ---- */
function initSignature(id){
  const canvas = document.getElementById(id); // Małe płótno
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  canvas.classList.add('disabled'); // Zablokuj małe płótno

  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const clearSignBtn = document.getElementById('clearSignBtn');
  const fullscreenOverlay = document.getElementById('fullscreenOverlay');
  const fullscreenCanvas = document.getElementById('fullscreenCanvas'); // Duże płótno
  const closeBtn = document.getElementById('closeSignBtn');
  const clearFullscreenBtn = document.getElementById('clearFullscreenSignBtn');

  let fDrawing = false;
  let fctx;

  function getFPos(e){
    const rect = fullscreenCanvas.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  const startDrawingFullscreen = e => {
    if (window.innerHeight > window.innerWidth) {
        alert("Proszę obrócić urządzenie do pozycji poziomej, aby podpisać.");
        fDrawing = false;
        return;
    }
    fDrawing = true;
    const pos=getFPos(e);
    fctx.beginPath();
    fctx.moveTo(pos.x,pos.y);
  };
  const drawFullscreen = e => { if(fDrawing){ const pos=getFPos(e); fctx.lineTo(pos.x,pos.y); fctx.stroke(); }};
  const stopDrawingFullscreen = () => { fDrawing = false; };

  const handleResize = () => {
    if (fullscreenOverlay.style.display !== 'flex') {
      window.removeEventListener('resize', handleResize);
      return;
    }
    const newWidth = fullscreenCanvas.offsetWidth;
    const newHeight = fullscreenCanvas.offsetHeight;
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = fullscreenCanvas.width;
    tempCanvas.height = fullscreenCanvas.height;
    if (fullscreenCanvas.width > 0 && fullscreenCanvas.height > 0) {
       tempCtx.drawImage(fullscreenCanvas, 0, 0);
    }
    fullscreenCanvas.width = newWidth;
    fullscreenCanvas.height = newHeight;
    fctx = fullscreenCanvas.getContext('2d');
    fctx.lineWidth = 6;
    fctx.lineCap = 'round';
    if (tempCanvas.width > 0 && tempCanvas.height > 0) {
       fctx.drawImage(tempCanvas, 0, 0, newWidth, newHeight);
    }
  };

  fullscreenBtn.addEventListener('click', async ()=>{
    fullscreenOverlay.style.display = 'flex';
    try {
        if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock('landscape');
            console.log("Orientacja zablokowana na landscape.");
        } else {
            console.warn("Screen Orientation API not fully supported.");
        }
    } catch (error) {
        console.error("Nie udało się zablokować orientacji:", error);
    }
    requestAnimationFrame(() => {
        const canvasWidth = fullscreenCanvas.offsetWidth;
        const canvasHeight = fullscreenCanvas.offsetHeight;
        fullscreenCanvas.width = canvasWidth;
        fullscreenCanvas.height = canvasHeight;
        fctx = fullscreenCanvas.getContext('2d');
        fctx.clearRect(0, 0, canvasWidth, canvasHeight);
        fctx.lineWidth = 6;
        fctx.lineCap = 'round';
        fctx.drawImage(canvas, 0, 0, canvasWidth, canvasHeight);
        fullscreenCanvas.addEventListener('pointerdown', startDrawingFullscreen);
        fullscreenCanvas.addEventListener('pointermove', drawFullscreen);
        fullscreenCanvas.addEventListener('pointerup', stopDrawingFullscreen);
        fullscreenCanvas.addEventListener('pointerleave', stopDrawingFullscreen);
        window.addEventListener('resize', handleResize);
    });
  });

  closeBtn.addEventListener('click', ()=>{
    window.removeEventListener('resize', handleResize);
    if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
        console.log("Orientacja odblokowana.");
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(fullscreenCanvas, 0, 0, canvas.width, canvas.height);
    fullscreenOverlay.style.display = 'none';
    fullscreenCanvas.removeEventListener('pointerdown', startDrawingFullscreen);
    fullscreenCanvas.removeEventListener('pointermove', drawFullscreen);
    fullscreenCanvas.removeEventListener('pointerup', stopDrawingFullscreen);
    fullscreenCanvas.removeEventListener('pointerleave', stopDrawingFullscreen);
  });

  clearFullscreenBtn.addEventListener('click', ()=>{
      if (fctx) {
        fctx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
      }
  });

  clearSignBtn.addEventListener('click', ()=>{ ctx.clearRect(0, 0, canvas.width, canvas.height); });

} // Koniec initSignature

window.addEventListener('load', ()=> initSignature('canvasPosiadacz'));

/* ---- PRZYCISK Zakończ w kroku 2 formularza ---- */
// Upewnij się, że element step2 istnieje przed dodaniem przycisku
if (document.getElementById('step2')) {
    const finishBtn = document.createElement('button');
    finishBtn.textContent = 'Zakończ';
    finishBtn.className = 'btn warn small';
    finishBtn.style.marginLeft = '6px';
    finishBtn.addEventListener('click', ()=>{
      const idx = parseInt(formRowSelect.value,10);
      saveRow(idx);
      syncHeaderFormToTop();
      formModal.style.display = 'none';
    });
    // Upewnij się, że kontener na przyciski istnieje
    const rightActionsContainer = document.getElementById('step2').querySelector('.form-actions .right');
    if (rightActionsContainer) {
        rightActionsContainer.appendChild(finishBtn);
    } else {
        console.warn("Konteiner '.form-actions .right' nie znaleziony w kroku 2.");
    }
} else {
    console.warn("Element #step2 nie znaleziony przy próbie dodania przycisku 'Zakończ'.");
}


window.addEventListener("resize", () => {
  const modal = document.getElementById("formModal");
  const card = modal.querySelector(".form-card");
  if (card) {
    card.style.height = window.innerHeight * 0.9 + "px";
    card.style.width = Math.min(window.innerWidth * 0.95, 600) + "px";
  }
});

const micKarencjaBtn = document.getElementById('micKarencja'); // Poprawiono nazwę zmiennej
const karencjaInput = document.getElementById('formKarencja');

if ('webkitSpeechRecognition' in window && micKarencjaBtn) { // Dodano sprawdzenie micKarencjaBtn
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'pl-PL';
  recognition.continuous = false;
  recognition.interimResults = false;

  micKarencjaBtn.addEventListener('click', () => { // Użyto poprawionej nazwy zmiennej
    if (micKarencjaBtn.classList.contains('active')) {
      recognition.stop();
      micKarencjaBtn.classList.remove('active');
    } else {
      recognition.start();
      micKarencjaBtn.classList.add('active');
    }
  });

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    karencjaInput.value = karencjaInput.value
      ? karencjaInput.value + ' ' + text
      : text;
  };

  recognition.onerror = (e) => {
    console.error('Błąd rozpoznawania mowy:', e.error);
    micKarencjaBtn.classList.remove('active');
  };

  recognition.onend = () => {
    micKarencjaBtn.classList.remove('active');
  };
} else if (!micKarencjaBtn) {
    console.warn("Przycisk #micKarencja nie znaleziony.");
} else {
  if(micKarencjaBtn) micKarencjaBtn.style.display = 'none'; // Ukryj, jeśli nie ma wsparcia
  console.warn('Rozpoznawanie mowy nie jest obsługiwane w tej przeglądarce.');
}

const drukujBtn = document.getElementById('drukujBtn'); // Zakładam, że masz przycisk z takim ID
if (drukujBtn) {
  drukujBtn.addEventListener('click', () => {
    window.print();
  });
}

const emailInput = document.getElementById('userEmail');
const saveEmailBtn = document.getElementById('saveEmail');

try {
  const savedEmail = localStorage.getItem('userEmail');
  if (savedEmail && emailInput) emailInput.value = savedEmail;
} catch (e) {
  console.warn('Brak dostępu do localStorage:', e);
}

if (saveEmailBtn && emailInput) {
  saveEmailBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if (!email) {
      alert('⚠️ Wprowadź adres e-mail.');
      return;
    }
    if (!email.includes('@') || !email.includes('.')) {
      alert('⚠️ Wprowadź poprawny adres e-mail.');
      return;
    }
    try {
      localStorage.setItem('userEmail', email);
      alert('📨 Adres e-mail został zapisany lokalnie.');
    } catch (e) {
      console.error('Błąd zapisu w localStorage:', e);
      alert('❌ Nie udało się zapisać adresu e-mail lokalnie.');
    }
  });
}

// ✅ POCZĄTEK: Kod dla Kalkulatora Wizyty

// --- Nawigacja między zakładkami ---
const kartaSection = document.getElementById('kartaLeczeniaSection');
const kalkulatorSection = document.getElementById('kalkulatorWizytySection');
const tabKartaBtn = document.getElementById('tabKartaBtn');
const tabKalkulatorBtn = document.getElementById('tabKalkulatorBtn');

function showSection(sectionToShow) {
  if (kartaSection) kartaSection.style.display = 'none';
  if (kalkulatorSection) kalkulatorSection.style.display = 'none';
  if (tabKartaBtn) tabKartaBtn.classList.remove('primary');
  if (tabKalkulatorBtn) tabKalkulatorBtn.classList.remove('primary');

  if (sectionToShow === 'karta' && kartaSection) {
    kartaSection.style.display = 'block';
    if (tabKartaBtn) tabKartaBtn.classList.add('primary');
  } else if (sectionToShow === 'kalkulator' && kalkulatorSection) {
    kalkulatorSection.style.display = 'block';
    if (tabKalkulatorBtn) tabKalkulatorBtn.classList.add('primary');
  }
}

if (tabKartaBtn && tabKalkulatorBtn) {
    tabKartaBtn.addEventListener('click', () => showSection('karta'));
    tabKalkulatorBtn.addEventListener('click', () => showSection('kalkulator'));
}


// Opcjonalny przycisk "Otwórz Kalkulator" w Karcie Leczenia
const openCalcBtn = document.getElementById('openCalculatorBtn');
if (openCalcBtn) {
    openCalcBtn.addEventListener('click', () => showSection('kalkulator'));
}

// --- Logika Kalkulatora (początkowa) ---
const copyCheckbox = document.getElementById('copyFromCardCheckbox');
const productSelect = document.getElementById('productSelect');
const quantityInput = document.getElementById('productQuantityInput');
const addProductBtn = document.getElementById('addProductBtn');
const receiptDisplay = document.getElementById('receiptDisplay');
const saveReceiptBtn = document.getElementById('saveReceiptBtn');
const savedReceiptSummary = document.getElementById('savedReceiptSummary');
const pluCodeInput = document.getElementById('pluCodeInput');
const pluBtn = document.getElementById('pluBtn');

let receiptItems = []; // Tablica przechowująca pozycje paragonu { name: '...', quantity: 1 }

// Funkcja renderująca paragon
function renderReceipt() {
  // Sprawdź czy elementy istnieją
  if (!receiptDisplay) return;

  if (receiptItems.length === 0) {
    receiptDisplay.innerHTML = '<p style="text-align: center; color: #999;">Paragon jest pusty</p>';
    return;
  }

  receiptDisplay.innerHTML = ''; // Wyczyść
  const list = document.createElement('ul');
  list.style.listStyle = 'none';
  list.style.padding = '0';
  list.style.margin = '0';

  receiptItems.forEach((item, index) => {
    const listItem = document.createElement('li');
    listItem.style.display = 'flex';
    listItem.style.justifyContent = 'space-between';
    listItem.style.marginBottom = '5px';
    listItem.style.borderBottom = '1px solid #eee';
    listItem.style.paddingBottom = '3px';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = item.name;

    const quantitySpan = document.createElement('span');
    quantitySpan.textContent = `x ${item.quantity}`;
    // TODO: Dodać edycję ilości

    const removeBtn = document.createElement('button');
    removeBtn.textContent = '❌';
    removeBtn.className = 'btn small ghost';
    removeBtn.style.padding = '2px 5px';
    removeBtn.title = 'Usuń pozycję';
    removeBtn.onclick = () => {
      receiptItems.splice(index, 1); // Usuń element z tablicy
      renderReceipt(); // Odśwież widok
    };

    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = 'flex';
    controlsDiv.style.alignItems = 'center';
    controlsDiv.style.gap = '8px';
    controlsDiv.appendChild(quantitySpan);
    controlsDiv.appendChild(removeBtn);

    listItem.appendChild(nameSpan);
    listItem.appendChild(controlsDiv);
    list.appendChild(listItem);
  });
  receiptDisplay.appendChild(list);
}

// Dodawanie produktu z formularza
if (addProductBtn) {
    addProductBtn.addEventListener('click', () => {
      const productName = productSelect ? productSelect.value.trim() : '';
      const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 0;

      if (productName && quantity > 0) {
        // Sprawdź, czy produkt jest na liście leków (prosta walidacja)
        if (typeof nazwyLekow !== 'undefined' && nazwyLekow.includes(productName)) {
           // Sprawdź, czy produkt już jest na paragonie
           const existingItem = receiptItems.find(item => item.name === productName);
           if(existingItem){
               existingItem.quantity += quantity; // Zwiększ ilość
           } else {
               receiptItems.push({ name: productName, quantity: quantity }); // Dodaj nowy
           }
           renderReceipt();
           if (productSelect) productSelect.value = ''; // Wyczyść pole wyboru
           if (quantityInput) quantityInput.value = 1; // Zresetuj ilość
        } else {
            alert('Wybrany produkt nie znajduje się w bazie leków.');
        }
      } else {
          alert('Wybierz produkt i podaj poprawną ilość.');
      }
    });
}


// Kopiowanie z karty leczenia
if (copyCheckbox) {
    copyCheckbox.addEventListener('change', () => {
      if (copyCheckbox.checked) {
        receiptItems = []; // Wyczyść obecny paragon
        const rows = document.querySelectorAll('#karta tbody tr');
        rows.forEach(row => {
          if (row.cells.length === 8) { // Pomijaj wiersz specjalny
            const lekInput = row.cells[4].querySelector('input[list="listaLekow"]');
            const iloscInput = row.cells[6].querySelector('input.small-input');

            if (lekInput && iloscInput) {
                 const productName = lekInput.value.trim();
                 // Upewnij się, że iloscInput.value nie jest pusty przed parsowaniem
                 const quantityValue = iloscInput.value;
                 const quantity = quantityValue ? parseInt(quantityValue, 10) : 0;

                 if (productName && quantity > 0) {
                    // Dodaj tylko jeśli nazwa i ilość są poprawne
                    const existing = receiptItems.find(item => item.name === productName);
                    if(existing){
                        existing.quantity += quantity;
                    } else {
                        receiptItems.push({ name: productName, quantity: quantity });
                    }
                 }
            }
          }
        });
        renderReceipt(); // Pokaż skopiowane
      } else {
        // Opcjonalnie: można wyczyścić paragon po odznaczeniu
        // receiptItems = [];
        // renderReceipt();
      }
    });
}

// Zapisywanie paragonu (prosta wersja)
if (saveReceiptBtn) {
    saveReceiptBtn.addEventListener('click', () => {
      if (receiptItems.length > 0) {
        if (savedReceiptSummary) {
            savedReceiptSummary.innerHTML = '<h4>Zapisany Paragon:</h4>';
            const list = document.createElement('ul');
            list.style.listStyle = 'none'; list.style.paddingLeft = '10px';
            receiptItems.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.name} x ${item.quantity}`;
              list.appendChild(li);
            });
            savedReceiptSummary.appendChild(list);
        }
        alert('Paragon zapisany (tymczasowo).');
        // Opcjonalnie: przełącz z powrotem na Kartę Leczenia
        // showSection('karta');
      } else {
          alert('Paragon jest pusty, nie ma czego zapisywać.');
      }
    });
}

// Obsługa PLU (bardzo uproszczona)
if (pluBtn) {
    pluBtn.addEventListener('click', () => {
        const code = pluCodeInput ? pluCodeInput.value.trim() : '';
        if(code){
            // Uproszczone: Traktuj kod jako nazwę leku
            const productName = code; // W przyszłości: productName = pluMap[code];
            if (typeof nazwyLekow !== 'undefined' && nazwyLekow.includes(productName)) {
                const existingItem = receiptItems.find(item => item.name === productName);
                if(existingItem){
                    existingItem.quantity += 1; // Domyślnie dodaj 1 szt.
                } else {
                    receiptItems.push({ name: productName, quantity: 1 });
                }
                renderReceipt();
                if (pluCodeInput) pluCodeInput.value = ''; // Wyczyść pole
            } else {
                alert(`Nie znaleziono produktu dla kodu PLU: ${code}`);
            }
        }
    });
}

// Pierwsze renderowanie pustego paragonu przy starcie (jeśli element istnieje)
if (document.readyState === 'loading') { // Czekaj na załadowanie DOM
    document.addEventListener('DOMContentLoaded', renderReceipt);
} else {
    renderReceipt(); // DOM już załadowany
}

// ✅ KONIEC: Kod dla Kalkulatora Wizyty

</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('✅ Service Worker zarejestrowany!'))
      .catch(err => console.error('❌ Błąd rejestracji SW:', err));
  }

</script>
</body>
</html>
